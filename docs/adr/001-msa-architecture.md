# ADR-001: MSA (Microservices Architecture) 선택

## 상태
채택됨 (2025-11-29)

## 컨텍스트 (Context)

PayFlow는 결제, 정산, 에스크로, 식자재 발주, 채용, 근태관리 등 다양한 도메인을 포함하는 복합 시스템입니다. 초기에는 모놀리식으로 시작했으나, 다음과 같은 문제에 직면했습니다:

### 직면한 문제들
1. **배포 리스크**: 결제 모듈 수정 시 전체 시스템 재배포 필요
2. **확장성 제약**: 특정 도메인(예: 결제)만 트래픽이 증가해도 전체 시스템 스케일 아웃 필요
3. **기술 부채**: 도메인 간 의존성이 복잡하게 얽혀 코드 변경이 어려움
4. **팀 협업 어려움**: 여러 도메인을 동시에 개발할 때 코드 충돌 빈번
5. **장애 전파**: 한 도메인의 장애가 전체 시스템에 영향

### 비즈니스 요구사항
- 결제 시스템은 99.9% 가용성 필요 (금융 거래)
- 식자재 발주는 새벽 시간대 트래픽 집중
- 채용 시스템은 독립적인 배포 주기 필요
- 각 도메인별 독립적인 확장 필요

## 결정 (Decision)

**DDD 기반 MSA 아키텍처를 채택**합니다.

### 서비스 분리 전략
```
payflow/
├── order/          # 주문 서비스
├── payment/        # 결제 서비스 (핵심)
├── settlement/     # 정산 서비스
├── escrow/         # 에스크로 서비스
├── ingredientorder/# 식자재 발주 서비스
├── recruitment/    # 채용 서비스
├── hr/             # 근태관리 서비스
├── crypto/         # 코인 시세 서비스
└── logging/        # 로그 수집 서비스
```

### 각 서비스의 독립성
- **독립 데이터베이스**: 각 서비스는 자신의 데이터만 소유
- **독립 배포**: 서비스별 독립 배포 가능 (현재는 모듈러 모놀리스로 구현)
- **독립 확장**: 서비스별 독립적인 스케일링
- **기술 다양성**: 서비스별 최적 기술 스택 선택 가능

## 대안 (Alternatives)

### 1. 모놀리식 유지
**장점**:
- 단순한 배포
- 트랜잭션 관리 용이
- 개발 초기 속도 빠름

**단점**:
- 확장성 제약
- 배포 리스크 높음
- 기술 부채 누적
- **거부 이유**: 다양한 도메인의 독립적 확장 불가능

### 2. 모듈러 모놀리스
**장점**:
- 모놀리식보다 도메인 분리 명확
- MSA보다 운영 복잡도 낮음
- 트랜잭션 관리 용이

**단점**:
- 여전히 단일 배포 단위
- 독립 확장 불가능
- **현재 상태**: MSA로 가기 위한 중간 단계로 채택

### 3. 서버리스 (AWS Lambda)
**장점**:
- 자동 스케일링
- 운영 부담 최소화
- 사용한 만큼만 과금

**단점**:
- Cold Start 문제
- 실행 시간 제약 (15분)
- 벤더 종속성
- **거부 이유**: 결제 시스템의 실시간 응답 요구사항 충족 어려움

## 결과 (Consequences)

### 긍정적 영향 ✅
1. **독립 배포**: 결제 서비스 수정 시 다른 서비스 영향 없음
2. **독립 확장**: 식자재 발주 서비스만 새벽 시간대 스케일 아웃
3. **장애 격리**: 채용 서비스 장애가 결제 시스템에 영향 없음
4. **팀 자율성**: 각 도메인 팀이 독립적으로 개발/배포
5. **기술 선택 자유**: 서비스별 최적 기술 스택 선택 가능

### 부정적 영향 ⚠️
1. **분산 트랜잭션**: ACID 트랜잭션 대신 Saga 패턴 필요 (ADR-003 참조)
2. **운영 복잡도**: 모니터링, 로깅, 배포 파이프라인 복잡
3. **네트워크 레이턴시**: 서비스 간 HTTP/Kafka 통신 오버헤드
4. **데이터 일관성**: 최종 일관성(Eventual Consistency) 수용 필요
5. **개발 초기 비용**: 인프라 구축 비용 증가

### 완화 전략
- **Saga 패턴**: 분산 트랜잭션 문제 해결 (ADR-003)
- **Kafka**: 비동기 통신으로 레이턴시 완화 (ADR-002)
- **중앙 로깅**: 로그 수집 시스템으로 운영 복잡도 완화
- **모듈러 모놀리스**: 초기에는 단일 배포로 시작, 점진적 분리

## 메트릭 (Metrics)

### 배포 빈도
- **Before (모놀리식)**: 주 1회 (전체 시스템 배포)
- **After (MSA)**: 서비스별 일 1-2회 (독립 배포)

### 장애 영향 범위
- **Before**: 한 모듈 장애 시 전체 시스템 다운
- **After**: 한 서비스 장애 시 해당 서비스만 영향

### 확장성
- **Before**: 전체 시스템 스케일 아웃 (비용 증가)
- **After**: 필요한 서비스만 스케일 아웃 (비용 절감 30%)

## 참고 자료
- [Building Microservices - Sam Newman](https://www.oreilly.com/library/view/building-microservices-2nd/9781492034018/)
- [Domain-Driven Design - Eric Evans](https://www.domainlanguage.com/ddd/)
- [Microservices Patterns - Chris Richardson](https://microservices.io/patterns/microservices.html)

## 관련 ADR
- ADR-002: Kafka 메시지 브로커 선택
- ADR-003: Saga 패턴 적용
- ADR-004: DDD 전술적 패턴 적용
