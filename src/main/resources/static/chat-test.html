<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 300px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .message.store {
            background-color: #e3f2fd;
            text-align: left;
        }
        .message.distributor {
            background-color: #fff3e0;
            text-align: right;
        }
        .message.system {
            background-color: #f5f5f5;
            text-align: center;
            font-style: italic;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>ğŸ—¨ï¸ ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    
    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div class="container">
        <h2>1. ë¡œê·¸ì¸</h2>
        <div class="input-group">
            <label>ì‚¬ìš©ì íƒ€ì…:</label>
            <select id="userType">
                <option value="store">ë§¤ì¥ (store1)</option>
                <option value="distributor">ìœ í†µì—…ì²´ (dist1)</option>
            </select>
        </div>
        <div class="input-group">
            <label>Username:</label>
            <input type="text" id="username" value="store1">
        </div>
        <div class="input-group">
            <label>Password:</label>
            <input type="password" id="password" value="password123">
        </div>
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <div id="loginStatus"></div>
    </div>
    
    <!-- ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ ì„¹ì…˜ -->
    <div class="container">
        <h2>2. ì±„íŒ…ë°©</h2>
        <div class="input-group">
            <label>ë§¤ì¥ ID:</label>
            <input type="text" id="storeId" value="store1">
        </div>
        <div class="input-group">
            <label>ìœ í†µì—…ì²´ ID:</label>
            <input type="text" id="distributorId" value="dist1">
        </div>
        <button onclick="createChatRoom()">ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ</button>
        <button onclick="getMyChatRooms()">ë‚´ ì±„íŒ…ë°© ëª©ë¡</button>
        <div id="chatRoomInfo"></div>
    </div>
    
    <!-- WebSocket ì—°ê²° ì„¹ì…˜ -->
    <div class="container">
        <h2>3. WebSocket ì—°ê²°</h2>
        <div id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
        <button id="connectBtn" onclick="connectWebSocket()">ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>ì—°ê²° í•´ì œ</button>
    </div>
    
    <!-- ë©”ì‹œì§€ ì„¹ì…˜ -->
    <div class="container">
        <h2>4. ë©”ì‹œì§€</h2>
        <div id="messages"></div>
        <div class="input-group">
            <label>ë©”ì‹œì§€:</label>
            <textarea id="messageContent" rows="3"></textarea>
        </div>
        <div class="input-group">
            <label>ë©”ì‹œì§€ íƒ€ì…:</label>
            <select id="messageType">
                <option value="TEXT">ì¼ë°˜ í…ìŠ¤íŠ¸</option>
                <option value="ORDER_INQUIRY">ì£¼ë¬¸ ë¬¸ì˜</option>
                <option value="QUOTE_REQUEST">ê²¬ì  ìš”ì²­</option>
                <option value="QUOTE_RESPONSE">ê²¬ì  ì‘ë‹µ</option>
            </select>
        </div>
        <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡</button>
        <button onclick="loadMessages()">ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <script>
        let token = null;
        let roomId = null;
        let stompClient = null;
        let currentUserId = null;
        let currentUserType = null;

        // ì‚¬ìš©ì íƒ€ì… ë³€ê²½ ì‹œ username ìë™ ë³€ê²½
        document.getElementById('userType').addEventListener('change', function() {
            const userType = this.value;
            document.getElementById('username').value = userType === 'store' ? 'store1' : 'dist1';
        });

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                token = data.accessToken;  // accessTokenìœ¼ë¡œ ìˆ˜ì •
                currentUserId = username;
                currentUserType = username.startsWith('store') ? 'STORE' : 'DISTRIBUTOR';
                
                console.log('ë¡œê·¸ì¸ ì„±ê³µ, í† í°:', token ? 'ìˆìŒ' : 'ì—†ìŒ');
                
                document.getElementById('loginStatus').innerHTML = 
                    `<div class="status connected">âœ… ë¡œê·¸ì¸ ì„±ê³µ! (${username})<br>í† í°: ${token.substring(0, 30)}...</div>`;
            } catch (error) {
                document.getElementById('loginStatus').innerHTML = 
                    `<div class="status disconnected">âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        async function createChatRoom() {
            if (!token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!');
                return;
            }
            
            const storeId = document.getElementById('storeId').value;
            const distributorId = document.getElementById('distributorId').value;
            
            try {
                const response = await fetch('/api/chat/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ storeId, distributorId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                roomId = data.roomId;
                
                document.getElementById('chatRoomInfo').innerHTML = `
                    <div class="status connected">
                        <strong>ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ!</strong><br>
                        Room ID: ${data.roomId}<br>
                        ë§¤ì¥: ${data.storeName}<br>
                        ìœ í†µì—…ì²´: ${data.distributorName}<br>
                        ì½ì§€ ì•Šì€ ë©”ì‹œì§€: ${data.unreadCount}
                    </div>
                `;
            } catch (error) {
                document.getElementById('chatRoomInfo').innerHTML = 
                    `<div class="status disconnected">âŒ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        async function getMyChatRooms() {
            if (!token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!');
                return;
            }
            
            try {
                const response = await fetch('/api/chat/rooms', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const rooms = await response.json();
                let html = '<div class="status connected"><strong>ë‚´ ì±„íŒ…ë°© ëª©ë¡:</strong><br>';
                rooms.forEach(room => {
                    html += `- ${room.roomId} (ì½ì§€ ì•ŠìŒ: ${room.unreadCount})<br>`;
                });
                html += '</div>';
                
                document.getElementById('chatRoomInfo').innerHTML = html;
            } catch (error) {
                document.getElementById('chatRoomInfo').innerHTML = 
                    `<div class="status disconnected">âŒ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        function connectWebSocket() {
            if (!token || !roomId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ê³  ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”!');
                return;
            }
            
            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);
            
            stompClient.connect(
                { 'Authorization': `Bearer ${token}` },
                function(frame) {
                    console.log('Connected: ' + frame);
                    document.getElementById('connectionStatus').className = 'status connected';
                    document.getElementById('connectionStatus').textContent = 'âœ… ì—°ê²°ë¨';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    
                    // ì±„íŒ…ë°© êµ¬ë…
                    stompClient.subscribe('/topic/chat/' + roomId, function(message) {
                        const msg = JSON.parse(message.body);
                        displayMessage(msg);
                    });
                },
                function(error) {
                    console.error('Connection error: ' + error);
                    document.getElementById('connectionStatus').className = 'status disconnected';
                    document.getElementById('connectionStatus').textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                }
            );
        }

        function disconnectWebSocket() {
            if (stompClient) {
                stompClient.disconnect();
                document.getElementById('connectionStatus').className = 'status disconnected';
                document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì•ˆë¨';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        }

        function sendMessage() {
            if (!stompClient || !roomId) {
                alert('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const content = document.getElementById('messageContent').value;
            const messageType = document.getElementById('messageType').value;
            
            if (!content.trim()) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }
            
            const message = {
                content: content,
                messageType: messageType,
                metadata: null
            };
            
            stompClient.send('/app/chat/' + roomId, {}, JSON.stringify(message));
            document.getElementById('messageContent').value = '';
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + msg.senderType.toLowerCase();
            
            const time = new Date(msg.createdAt).toLocaleTimeString('ko-KR');
            messageDiv.innerHTML = `
                <strong>${msg.senderId}</strong> (${msg.messageType})<br>
                ${msg.content}<br>
                <small>${time}</small>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function loadMessages() {
            if (!token || !roomId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ê³  ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”!');
                return;
            }
            
            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                // ì—­ìˆœìœ¼ë¡œ í‘œì‹œ (ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„°)
                data.content.reverse().forEach(msg => displayMessage(msg));
            } catch (error) {
                alert('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>
</body>
</html>
