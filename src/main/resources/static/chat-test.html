<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 300px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .message.store {
            background-color: #e3f2fd;
            text-align: left;
        }
        .message.distributor {
            background-color: #fff3e0;
            text-align: right;
        }
        .message.system {
            background-color: #f5f5f5;
            text-align: center;
            font-style: italic;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .typing-indicator {
            padding: 10px;
            margin: 10px 0;
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
            font-style: italic;
            color: #2e7d32;
            min-height: 20px;
        }
        .typing-indicator.active {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .typing-dots {
            display: inline-block;
        }
        .typing-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>ğŸ—¨ï¸ ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    
    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div class="container">
        <h2>1. ë¡œê·¸ì¸</h2>
        <div class="input-group">
            <label>ì‚¬ìš©ì íƒ€ì…:</label>
            <select id="userType">
                <option value="store">ë§¤ì¥ (store1)</option>
                <option value="distributor">ìœ í†µì—…ì²´ (dist1)</option>
            </select>
        </div>
        <div class="input-group">
            <label>Username:</label>
            <input type="text" id="username" value="store1">
        </div>
        <div class="input-group">
            <label>Password:</label>
            <input type="password" id="password" value="password123">
        </div>
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <div id="loginStatus"></div>
    </div>
    
    <!-- ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ ì„¹ì…˜ -->
    <div class="container">
        <h2>2. ì±„íŒ…ë°©</h2>
        <div class="input-group">
            <label>ë§¤ì¥ ID:</label>
            <input type="text" id="storeId" value="store1">
        </div>
        <div class="input-group">
            <label>ìœ í†µì—…ì²´ ID:</label>
            <input type="text" id="distributorId" value="dist1">
        </div>
        <button onclick="createChatRoom()">ì±„íŒ…ë°© ìƒì„±/ì¡°íšŒ</button>
        <button onclick="getMyChatRooms()">ë‚´ ì±„íŒ…ë°© ëª©ë¡</button>
        <div id="chatRoomInfo"></div>
    </div>
    
    <!-- WebSocket ì—°ê²° ì„¹ì…˜ -->
    <div class="container">
        <h2>3. WebSocket ì—°ê²°</h2>
        <div id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
        <button id="connectBtn" onclick="connectWebSocket()">ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>ì—°ê²° í•´ì œ</button>
    </div>
    
    <!-- ë©”ì‹œì§€ ì„¹ì…˜ -->
    <div class="container">
        <h2>4. ë©”ì‹œì§€</h2>
        <div id="messages"></div>
        
        <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
        <div id="typingIndicator" class="typing-indicator"></div>
        
        <div class="input-group">
            <label>ë©”ì‹œì§€:</label>
            <textarea id="messageContent" rows="3"></textarea>
        </div>
        <div class="input-group">
            <label>ë©”ì‹œì§€ íƒ€ì…:</label>
            <select id="messageType">
                <option value="TEXT">ì¼ë°˜ í…ìŠ¤íŠ¸</option>
                <option value="ORDER_INQUIRY">ì£¼ë¬¸ ë¬¸ì˜</option>
                <option value="QUOTE_REQUEST">ê²¬ì  ìš”ì²­</option>
                <option value="QUOTE_RESPONSE">ê²¬ì  ì‘ë‹µ</option>
            </select>
        </div>
        <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡</button>
        <button onclick="loadMessages()">ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    
    <!-- íƒ€ì´í•‘ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
    <div class="container">
        <h2>5. íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í…ŒìŠ¤íŠ¸</h2>
        <p>ë©”ì‹œì§€ ì…ë ¥ë€ì— íƒ€ì´í•‘í•˜ë©´ ìë™ìœ¼ë¡œ ìƒëŒ€ë°©ì—ê²Œ "ì…ë ¥ ì¤‘..." í‘œì‹œë©ë‹ˆë‹¤.</p>
        <button onclick="sendTypingStart()" id="typingStartBtn" disabled>ìˆ˜ë™: ì…ë ¥ ì‹œì‘</button>
        <button onclick="sendTypingStop()" id="typingStopBtn" disabled>ìˆ˜ë™: ì…ë ¥ ì¤‘ë‹¨</button>
        <div id="typingTestStatus"></div>
    </div>

    <script>
        let token = null;
        let roomId = null;
        let stompClient = null;
        let currentUserId = null;
        let currentUserType = null;
        let typingTimeout = null;
        let isTyping = false;

        // ì‚¬ìš©ì íƒ€ì… ë³€ê²½ ì‹œ username ìë™ ë³€ê²½
        document.getElementById('userType').addEventListener('change', function() {
            const userType = this.value;
            document.getElementById('username').value = userType === 'store' ? 'store1' : 'dist1';
        });

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                token = data.accessToken;  // accessTokenìœ¼ë¡œ ìˆ˜ì •
                currentUserId = username;
                currentUserType = username.startsWith('store') ? 'STORE' : 'DISTRIBUTOR';
                
                console.log('ë¡œê·¸ì¸ ì„±ê³µ, í† í°:', token ? 'ìˆìŒ' : 'ì—†ìŒ');
                
                document.getElementById('loginStatus').innerHTML = 
                    `<div class="status connected">âœ… ë¡œê·¸ì¸ ì„±ê³µ! (${username})<br>í† í°: ${token.substring(0, 30)}...</div>`;
            } catch (error) {
                document.getElementById('loginStatus').innerHTML = 
                    `<div class="status disconnected">âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        async function createChatRoom() {
            if (!token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!');
                return;
            }
            
            const storeId = document.getElementById('storeId').value;
            const distributorId = document.getElementById('distributorId').value;
            
            try {
                const response = await fetch('/api/chat/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ storeId, distributorId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                roomId = data.roomId;
                
                document.getElementById('chatRoomInfo').innerHTML = `
                    <div class="status connected">
                        <strong>ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ!</strong><br>
                        Room ID: ${data.roomId}<br>
                        ë§¤ì¥: ${data.storeName}<br>
                        ìœ í†µì—…ì²´: ${data.distributorName}<br>
                        ì½ì§€ ì•Šì€ ë©”ì‹œì§€: ${data.unreadCount}
                    </div>
                `;
            } catch (error) {
                document.getElementById('chatRoomInfo').innerHTML = 
                    `<div class="status disconnected">âŒ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        async function getMyChatRooms() {
            if (!token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!');
                return;
            }
            
            try {
                const response = await fetch('/api/chat/rooms', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const rooms = await response.json();
                let html = '<div class="status connected"><strong>ë‚´ ì±„íŒ…ë°© ëª©ë¡:</strong><br>';
                rooms.forEach(room => {
                    html += `- ${room.roomId} (ì½ì§€ ì•ŠìŒ: ${room.unreadCount})<br>`;
                });
                html += '</div>';
                
                document.getElementById('chatRoomInfo').innerHTML = html;
            } catch (error) {
                document.getElementById('chatRoomInfo').innerHTML = 
                    `<div class="status disconnected">âŒ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        function connectWebSocket() {
            if (!token || !roomId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ê³  ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”!');
                return;
            }
            
            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);
            
            stompClient.connect(
                { 'Authorization': `Bearer ${token}` },
                function(frame) {
                    console.log('Connected: ' + frame);
                    document.getElementById('connectionStatus').className = 'status connected';
                    document.getElementById('connectionStatus').textContent = 'âœ… ì—°ê²°ë¨';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    
                    // ì±„íŒ…ë°© ë©”ì‹œì§€ êµ¬ë…
                    stompClient.subscribe('/topic/chat/' + roomId, function(message) {
                        const msg = JSON.parse(message.body);
                        displayMessage(msg);
                    });
                    
                    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° êµ¬ë…
                    stompClient.subscribe('/topic/chat/' + roomId + '/typing', function(message) {
                        const event = JSON.parse(message.body);
                        handleTypingEvent(event);
                    });
                    
                    console.log('âœ… íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° êµ¬ë… ì™„ë£Œ');
                    
                    // ë²„íŠ¼ í™œì„±í™”
                    document.getElementById('typingStartBtn').disabled = false;
                    document.getElementById('typingStopBtn').disabled = false;
                },
                function(error) {
                    console.error('Connection error: ' + error);
                    document.getElementById('connectionStatus').className = 'status disconnected';
                    document.getElementById('connectionStatus').textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                }
            );
        }

        function disconnectWebSocket() {
            if (stompClient) {
                // íƒ€ì´í•‘ ì¤‘ì´ë©´ ì¤‘ë‹¨ ì´ë²¤íŠ¸ ì „ì†¡
                if (isTyping) {
                    sendTypingStop();
                }
                
                stompClient.disconnect();
                document.getElementById('connectionStatus').className = 'status disconnected';
                document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì•ˆë¨';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('typingStartBtn').disabled = true;
                document.getElementById('typingStopBtn').disabled = true;
            }
        }

        function sendMessage() {
            if (!stompClient || !roomId) {
                alert('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const content = document.getElementById('messageContent').value;
            const messageType = document.getElementById('messageType').value;
            
            if (!content.trim()) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }
            
            // ë©”ì‹œì§€ ì „ì†¡ ì „ì— íƒ€ì´í•‘ ì¤‘ë‹¨
            if (isTyping) {
                sendTypingStop();
            }
            
            const message = {
                content: content,
                messageType: messageType,
                metadata: null
            };
            
            stompClient.send('/app/chat/' + roomId, {}, JSON.stringify(message));
            document.getElementById('messageContent').value = '';
        }
        
        // íƒ€ì´í•‘ ì´ë²¤íŠ¸ ì „ì†¡
        function sendTypingEvent(typing) {
            if (!stompClient || !roomId) {
                return;
            }
            
            const event = {
                roomId: roomId,
                isTyping: typing
            };
            
            stompClient.send('/app/chat/' + roomId + '/typing', {}, JSON.stringify(event));
            console.log('ğŸ“¤ íƒ€ì´í•‘ ì´ë²¤íŠ¸ ì „ì†¡:', typing ? 'ì‹œì‘' : 'ì¤‘ë‹¨');
        }
        
        function sendTypingStart() {
            sendTypingEvent(true);
            isTyping = true;
            document.getElementById('typingTestStatus').innerHTML = 
                '<div class="status connected">âœ… íƒ€ì´í•‘ ì‹œì‘ ì´ë²¤íŠ¸ ì „ì†¡ë¨</div>';
        }
        
        function sendTypingStop() {
            sendTypingEvent(false);
            isTyping = false;
            document.getElementById('typingTestStatus').innerHTML = 
                '<div class="status disconnected">â¹ï¸ íƒ€ì´í•‘ ì¤‘ë‹¨ ì´ë²¤íŠ¸ ì „ì†¡ë¨</div>';
        }
        
        // íƒ€ì´í•‘ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì²˜ë¦¬
        function handleTypingEvent(event) {
            console.log('ğŸ“¥ íƒ€ì´í•‘ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', event);
            
            const indicator = document.getElementById('typingIndicator');
            
            // ìì‹ ì˜ íƒ€ì´í•‘ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
            if (event.userId === currentUserId) {
                return;
            }
            
            if (event.isTyping) {
                const userName = event.userName || event.userId;
                indicator.innerHTML = `
                    <strong>${userName}</strong>ë‹˜ì´ ì…ë ¥ ì¤‘
                    <span class="typing-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </span>
                `;
                indicator.className = 'typing-indicator active';
                
                // 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê²Œ (ì„œë²„ì—ì„œ ì¤‘ë‹¨ ì´ë²¤íŠ¸ê°€ ì•ˆ ì˜¬ ê²½ìš° ëŒ€ë¹„)
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    indicator.innerHTML = '';
                    indicator.className = 'typing-indicator';
                }, 10000);
            } else {
                indicator.innerHTML = '';
                indicator.className = 'typing-indicator';
                clearTimeout(typingTimeout);
            }
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + msg.senderType.toLowerCase();
            
            const time = new Date(msg.createdAt).toLocaleTimeString('ko-KR');
            messageDiv.innerHTML = `
                <strong>${msg.senderId}</strong> (${msg.messageType})<br>
                ${msg.content}<br>
                <small>${time}</small>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function loadMessages() {
            if (!token || !roomId) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ê³  ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”!');
                return;
            }
            
            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                // ì—­ìˆœìœ¼ë¡œ í‘œì‹œ (ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„°)
                data.content.reverse().forEach(msg => displayMessage(msg));
            } catch (error) {
                alert('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ë©”ì‹œì§€ ì…ë ¥ë€ì— íƒ€ì´í•‘ ê°ì§€ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageContent');
            let typingDebounce = null;
            
            messageInput.addEventListener('input', function() {
                // ì…ë ¥ ì‹œì‘
                if (!isTyping && this.value.length > 0) {
                    isTyping = true;
                    sendTypingEvent(true);
                }
                
                // ë””ë°”ìš´ì‹±: 2ì´ˆê°„ ì…ë ¥ ì—†ìœ¼ë©´ íƒ€ì´í•‘ ì¤‘ë‹¨
                clearTimeout(typingDebounce);
                typingDebounce = setTimeout(() => {
                    if (isTyping) {
                        isTyping = false;
                        sendTypingEvent(false);
                    }
                }, 2000);
            });
            
            // ì…ë ¥ë€ì´ ë¹„ì›Œì§€ë©´ íƒ€ì´í•‘ ì¤‘ë‹¨
            messageInput.addEventListener('blur', function() {
                if (isTyping) {
                    isTyping = false;
                    sendTypingEvent(false);
                }
            });
        });
    </script>
</body>
</html>
