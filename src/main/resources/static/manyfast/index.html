<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manyfast Editor MVP</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }
        .app { display: flex; height: 100vh; }
        
        .chat-panel { width: 300px; background: #1e293b; display: flex; flex-direction: column; border-right: 1px solid #334155; }
        .chat-header { padding: 16px; border-bottom: 1px solid #334155; }
        .chat-header h2 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .project-select { width: 100%; padding: 8px 12px; background: #334155; border: none; border-radius: 6px; color: white; font-size: 13px; }
        .new-project-btn { width: 100%; margin-top: 8px; padding: 8px; background: transparent; border: 1px dashed #475569; border-radius: 6px; color: #64748b; cursor: pointer; }
        .new-project-btn:hover { border-color: #3b82f6; color: #3b82f6; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
        .message { margin-bottom: 16px; }
        .message.user { text-align: right; }
        .message-bubble { display: inline-block; max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
        .message.user .message-bubble { background: #3b82f6; border-radius: 12px 12px 4px 12px; }
        .message.ai .message-bubble { background: transparent; padding: 0; max-width: 100%; }
        .typing { color: #64748b; font-size: 12px; padding: 8px; }
        
        /* AI ì‘ë‹µ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .ai-response { background: #1e293b; border-radius: 12px; overflow: hidden; }
        .ai-response-header { padding: 12px 14px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 8px; }
        .ai-response-header .icon { width: 20px; height: 20px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .ai-response-header .title { font-weight: 600; font-size: 13px; }
        .ai-response-body { padding: 12px 14px; }
        .ai-step { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid #334155; }
        .ai-step:last-child { border-bottom: none; }
        .ai-step-icon { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; margin-top: 2px; }
        .ai-step-icon.thinking { background: #334155; color: #94a3b8; }
        .ai-step-icon.done { background: #065f46; color: #34d399; }
        .ai-step-icon.feature { background: #3f1e5f; color: #a78bfa; }
        .ai-step-content { flex: 1; }
        .ai-step-title { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
        .ai-step-desc { font-size: 11px; color: #94a3b8; }
        .ai-summary { background: #0f172a; padding: 10px 12px; border-radius: 8px; margin-top: 8px; font-size: 12px; color: #94a3b8; line-height: 1.5; }
        .chat-input-area { padding: 12px; border-top: 1px solid #334155; }
        .chat-input { width: 100%; padding: 10px; background: #334155; border: none; border-radius: 6px; color: white; resize: none; font-size: 13px; }
        .chat-input:focus { outline: 1px solid #3b82f6; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .toolbar { padding: 10px 16px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 8px; }
        .toolbar h1 { font-size: 16px; font-weight: 500; margin-right: 20px; }
        .tab-btn { padding: 6px 14px; background: transparent; border: 1px solid #334155; border-radius: 6px; color: #94a3b8; cursor: pointer; font-size: 13px; }
        .tab-btn:hover { border-color: #475569; color: #e2e8f0; }
        .tab-btn.active { background: #334155; border-color: #475569; color: white; }
        .export-btn { margin-left: auto; padding: 6px 14px; background: #3b82f6; border: none; border-radius: 6px; color: white; cursor: pointer; }
        
        .fs-container { flex: 1; overflow: auto; padding: 40px; background: #0f172a; }
        
        /* ë§ˆì¸ë“œë§µ ë ˆì´ì•„ì›ƒ */
        .mindmap { display: flex; align-items: center; gap: 0; }
        .node-column { display: flex; flex-direction: column; gap: 20px; position: relative; }
        
        /* ë…¸ë“œ ì¹´ë“œ */
        .node-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 14px 18px; min-width: 200px; max-width: 300px; position: relative; }
        .node-card:hover { border-color: #475569; }
        .node-card.root { background: linear-gradient(135deg, #1e293b, #334155); }
        .node-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .node-desc { font-size: 11px; color: #94a3b8; line-height: 1.4; margin-bottom: 8px; }
        .node-meta { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .badge.todo { background: #1e3a5f; color: #60a5fa; }
        .badge.admin { background: #3f1e5f; color: #a78bfa; }
        .prd-link { font-size: 11px; color: #3b82f6; cursor: pointer; }
        
        /* ì—°ê²°ì„  - ê°€ë¡œ */
        .h-connector { width: 50px; height: 2px; background: #475569; align-self: center; }
        
        /* ì—°ê²°ì„  - ì„¸ë¡œ ë¸Œëœì¹˜ */
        .branch-container { display: flex; align-items: stretch; }
        .v-branch { width: 50px; position: relative; display: flex; flex-direction: column; justify-content: center; }
        .v-branch::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 2px; background: #475569; }
        .v-branch-line { position: absolute; left: 0; width: 2px; background: #475569; }
        
        /* ë¸Œëœì¹˜ ì•„ì´í…œ */
        .branch-item { display: flex; align-items: center; position: relative; }
        .branch-connector { width: 50px; height: 2px; background: #475569; }
        
        /* ëª¨ë‹¬ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: #1e293b; padding: 24px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; margin-bottom: 12px; }
        .modal-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .modal-buttons button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        .modal-buttons .primary { background: #3b82f6; color: white; }
        .modal-buttons .secondary { background: #334155; color: #e2e8f0; }
        .prd-content { background: #0f172a; padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 13px; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #64748b; }
        .empty-state h3 { color: #94a3b8; margin-bottom: 8px; }
        
        /* IA ë·° ìŠ¤íƒ€ì¼ */
        .ia-container { display: flex; flex-direction: column; align-items: center; padding: 40px; min-height: 100%; }
        .ia-root { display: flex; flex-direction: column; align-items: center; }
        .ia-root-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
        .ia-root-card .icon { font-size: 16px; }
        .ia-root-card .title { font-size: 14px; font-weight: 500; }
        .ia-root-card .prd-link { font-size: 12px; color: #3b82f6; margin-left: 12px; cursor: pointer; }
        
        .ia-connector-v { width: 2px; height: 40px; background: #475569; }
        .ia-branch-h { display: flex; align-items: flex-start; justify-content: center; position: relative; }
        .ia-branch-h::before { content: ''; position: absolute; top: 0; height: 2px; background: #475569; }
        
        .ia-pages { display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .ia-page { display: flex; flex-direction: column; align-items: center; }
        .ia-page-connector { width: 2px; height: 30px; background: #475569; }
        
        .ia-page-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; width: 280px; overflow: hidden; }
        .ia-page-header { padding: 12px 14px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 8px; }
        .ia-page-header .badge { background: #8b5cf6; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .ia-page-header .title { font-size: 13px; font-weight: 600; flex: 1; }
        .ia-page-header .id { font-size: 10px; color: #64748b; }
        .ia-page-desc { padding: 10px 14px; font-size: 11px; color: #94a3b8; border-bottom: 1px solid #334155; line-height: 1.5; }
        .ia-page-features { padding: 10px 14px; }
        .ia-page-features-title { font-size: 11px; color: #64748b; margin-bottom: 8px; }
        .ia-feature-item { font-size: 12px; padding: 6px 0; border-bottom: 1px solid #334155; color: #e2e8f0; }
        .ia-feature-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = '/api/manyfast';

        function App() {
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [treeData, setTreeData] = useState([]);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [activeTab, setActiveTab] = useState('FS');
            const [showPRD, setShowPRD] = useState(false);
            const [prdContent, setPrdContent] = useState('');
            const [showNewProject, setShowNewProject] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { loadProjects(); }, []);
            useEffect(() => { 
                if (currentProject) { 
                    loadProjectTree(); 
                    setMessages([{ type: 'ai', text: `"${currentProject.name}" í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.` }]); 
                } 
            }, [currentProject]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const loadProjects = async () => {
                const res = await fetch(`${API_BASE}/projects`);
                const data = await res.json();
                setProjects(data);
                if (data.length > 0 && !currentProject) setCurrentProject(data[0]);
            };

            const loadProjectTree = async () => {
                const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/tree`);
                setTreeData(await res.json());
            };

            const createProject = async (name, desc) => {
                const res = await fetch(`${API_BASE}/projects`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: desc })
                });
                const project = await res.json();
                setProjects([...projects, project]);
                setCurrentProject(project);
                setShowNewProject(false);
            };

            const handleSendMessage = async () => {
                if (!inputText.trim() || !currentProject) return;
                const userMessage = inputText.trim();
                setMessages(prev => [...prev, { type: 'user', text: userMessage }]);
                setInputText('');
                setIsTyping(true);
                try {
                    const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/chat`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { type: 'ai', text: data.response }]);
                    if (data.nodesCreated > 0) loadProjectTree();
                } catch (e) {
                    setMessages(prev => [...prev, { type: 'ai', text: 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }]);
                }
                setIsTyping(false);
            };

            const generatePRD = async () => {
                setIsTyping(true);
                const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/generate-prd`, { method: 'POST' });
                const data = await res.json();
                setPrdContent(data.prd);
                setShowPRD(true);
                setIsTyping(false);
            };

            return (
                <div className="app">
                    <div className="chat-panel">
                        <div className="chat-header">
                            <h2>New chat</h2>
                            <select className="project-select" value={currentProject?.id || ''} 
                                onChange={e => setCurrentProject(projects.find(p => p.id === parseInt(e.target.value)))}>
                                {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <button className="new-project-btn" onClick={() => setShowNewProject(true)}>+ ìƒˆ í”„ë¡œì íŠ¸</button>
                        </div>
                        <div className="chat-messages">
                            {messages.map((msg, i) => (
                                <div key={i} className={`message ${msg.type}`}>
                                    {msg.type === 'user' ? (
                                        <div className="message-bubble">{msg.text}</div>
                                    ) : (
                                        <AIResponseCard text={msg.text} />
                                    )}
                                </div>
                            ))}
                            {isTyping && (
                                <div className="ai-response" style={{margin: '8px 0'}}>
                                    <div className="ai-response-body">
                                        <div className="ai-step">
                                            <div className="ai-step-icon thinking">â³</div>
                                            <div className="ai-step-content">
                                                <div className="ai-step-title">ìƒê°í•¨</div>
                                                <div className="ai-step-desc">ê¸°ëŠ¥ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="chat-input-area">
                            <textarea className="chat-input" placeholder="What do you want to create?"
                                value={inputText} onChange={e => setInputText(e.target.value)}
                                onKeyPress={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }}}
                                rows="2" />
                        </div>
                    </div>
                    
                    <div className="main-area">
                        <div className="toolbar">
                            <h1>{currentProject?.name || 'Manyfast'}</h1>
                            {['PRD', 'FS', 'IA', 'Tree', 'Directory'].map(tab => (
                                <button key={tab} className={`tab-btn ${activeTab === tab ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab)}>{tab}</button>
                            ))}
                            <button className="export-btn" onClick={generatePRD}>Export</button>
                        </div>
                        <div className="fs-container">
                            {activeTab === 'FS' && <MindmapView treeData={treeData} projectName={currentProject?.name} onPRDClick={() => setShowPRD(true)} />}
                            {activeTab === 'PRD' && <PRDView content={prdContent} onGenerate={generatePRD} />}
                            {activeTab === 'IA' && <IAView treeData={treeData} projectName={currentProject?.name} onPRDClick={() => setShowPRD(true)} />}
                            {activeTab === 'Tree' && <TreeView treeData={treeData} />}
                            {activeTab === 'Directory' && <div className="empty-state"><h3>Directory ë·° ì¤€ë¹„ ì¤‘</h3></div>}
                        </div>
                    </div>
                    {showNewProject && <NewProjectModal onClose={() => setShowNewProject(false)} onCreate={createProject} />}
                    {showPRD && <PRDModal content={prdContent} onClose={() => setShowPRD(false)} />}
                </div>
            );
        }

        // ë§ˆì¸ë“œë§µ ë·° - SVG ì—°ê²°ì„  ì‚¬ìš©
        function MindmapView({ treeData, projectName, onPRDClick }) {
            if (!treeData || treeData.length === 0) {
                return <div className="empty-state"><h3>ê¸°ëŠ¥ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</h3><p>ì±„íŒ…ì°½ì—ì„œ ê¸°ëŠ¥ì„ ìš”ì²­í•´ë³´ì„¸ìš”</p></div>;
            }
            
            return (
                <div className="mindmap">
                    {/* ë£¨íŠ¸ ë…¸ë“œ */}
                    <div className="node-card root">
                        <div className="node-title">{projectName || 'Project'}</div>
                        <span className="prd-link" onClick={onPRDClick}>â†— PRD</span>
                    </div>
                    
                    {/* 1ë‹¨ê³„ ì—°ê²°ì„  */}
                    <div className="h-connector"></div>
                    
                    {/* 1ë‹¨ê³„ ë…¸ë“œë“¤ */}
                    <NodeBranch nodes={treeData} level={1} />
                </div>
            );
        }
        
        function NodeBranch({ nodes, level }) {
            const containerRef = useRef(null);
            const [nodePositions, setNodePositions] = useState([]);
            
            useEffect(() => {
                if (containerRef.current) {
                    const nodeElements = containerRef.current.querySelectorAll(':scope > .node-row');
                    const positions = Array.from(nodeElements).map(el => {
                        const rect = el.getBoundingClientRect();
                        const containerRect = containerRef.current.getBoundingClientRect();
                        return {
                            top: rect.top - containerRect.top,
                            height: rect.height,
                            center: rect.top - containerRect.top + rect.height / 2
                        };
                    });
                    setNodePositions(positions);
                }
            }, [nodes]);
            
            if (!nodes || nodes.length === 0) return null;
            
            const totalHeight = nodePositions.length > 0 
                ? nodePositions[nodePositions.length - 1].top + nodePositions[nodePositions.length - 1].height
                : nodes.length * 100;
            
            const firstCenter = nodePositions[0]?.center || 50;
            const lastCenter = nodePositions[nodePositions.length - 1]?.center || totalHeight - 50;
            const midY = totalHeight / 2;
            
            return (
                <div style={{display: 'flex', alignItems: 'stretch'}}>
                    {/* ì—°ê²°ì„  SVG */}
                    <svg width="50" height={totalHeight} style={{flexShrink: 0, minHeight: totalHeight}}>
                        {/* ì…ë ¥ì„  (ì™¼ìª½ â†’ ì¤‘ì•™) */}
                        <line x1="0" y1={midY} x2="25" y2={midY} stroke="#475569" strokeWidth="2"/>
                        
                        {nodes.length > 1 && nodePositions.length > 1 ? (
                            <>
                                {/* ì„¸ë¡œì„  */}
                                <line x1="25" y1={firstCenter} x2="25" y2={lastCenter} stroke="#475569" strokeWidth="2"/>
                                {/* ê° ë…¸ë“œë¡œ ê°€ëŠ” ê°€ë¡œì„  */}
                                {nodePositions.map((pos, idx) => (
                                    <line key={idx} x1="25" y1={pos.center} x2="50" y2={pos.center} stroke="#475569" strokeWidth="2"/>
                                ))}
                            </>
                        ) : (
                            <line x1="25" y1={midY} x2="50" y2={midY} stroke="#475569" strokeWidth="2"/>
                        )}
                    </svg>
                    
                    {/* ë…¸ë“œ ì»¬ëŸ¼ */}
                    <div ref={containerRef} style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                        {nodes.map((node) => (
                            <div key={node.id} className="node-row" style={{display: 'flex', alignItems: 'center'}}>
                                <div className="node-card">
                                    <div className="node-title">{node.title}</div>
                                    {node.description && <div className="node-desc">{node.description.substring(0, 50)}...</div>}
                                    <div className="node-meta">
                                        <span className="badge todo">To Do</span>
                                        {node.nodeType === 'FEATURE' && <span className="badge admin">Admin</span>}
                                    </div>
                                </div>
                                
                                {node.children && node.children.length > 0 && (
                                    <NodeBranch nodes={node.children} level={level + 1} />
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // AI ì‘ë‹µì„ íŒŒì‹±í•´ì„œ ì¹´ë“œë¡œ í‘œì‹œ
        function AIResponseCard({ text }) {
            const parseResponse = (text) => {
                const steps = [];
                const lines = text.split('\n');
                
                // "Nê°œì˜ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤" íŒ¨í„´ ì°¾ê¸°
                const countMatch = text.match(/(\d+)ê°œì˜ ê¸°ëŠ¥ì´ ì¶”ê°€/);
                if (countMatch) {
                    steps.push({ type: 'done', title: 'Feature completed', desc: `${countMatch[1]}ê°œì˜ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤` });
                }
                
                // [NODE] ë¸”ë¡ íŒŒì‹±
                const nodeMatches = text.matchAll(/\[NODE\]([\s\S]*?)\[\/NODE\]/gi);
                for (const match of nodeMatches) {
                    const block = match[1];
                    const titleMatch = block.match(/title:\s*(.+)/i);
                    const typeMatch = block.match(/type:\s*(.+)/i);
                    const descMatch = block.match(/description:\s*(.+)/i);
                    
                    if (titleMatch) {
                        steps.push({
                            type: 'feature',
                            title: titleMatch[1].trim(),
                            desc: typeMatch ? typeMatch[1].trim() : 'FEATURE',
                            fullDesc: descMatch ? descMatch[1].trim() : ''
                        });
                    }
                }
                
                // [FEATURE], [TASK] ë“± íŒ¨í„´
                const altMatches = text.matchAll(/\[(FEATURE|TASK|REQUIREMENT)\]\s*([^\n]+)/gi);
                for (const match of altMatches) {
                    steps.push({
                        type: 'feature',
                        title: match[2].trim().replace(/^title:\s*/i, ''),
                        desc: match[1]
                    });
                }
                
                // ë‚˜ë¨¸ì§€ ì„¤ëª… í…ìŠ¤íŠ¸ ì¶”ì¶œ
                let summary = text
                    .replace(/\[NODE\][\s\S]*?\[\/NODE\]/gi, '')
                    .replace(/\[(FEATURE|TASK|REQUIREMENT)\][^\n]*/gi, '')
                    .replace(/\d+ê°œì˜ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤\.?/g, '')
                    .replace(/title:.*\n?/gi, '')
                    .replace(/type:.*\n?/gi, '')
                    .replace(/description:.*\n?/gi, '')
                    .replace(/parent:.*\n?/gi, '')
                    .trim();
                
                // ì—¬ëŸ¬ ì¤„ ê³µë°± ì •ë¦¬
                summary = summary.replace(/\n{3,}/g, '\n\n').trim();
                
                return { steps, summary };
            };
            
            const { steps, summary } = parseResponse(text);
            
            // íŒŒì‹±ëœ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
            if (steps.length === 0 && !summary) {
                return <div className="ai-response"><div className="ai-response-body" style={{fontSize: '13px'}}>{text}</div></div>;
            }
            
            return (
                <div className="ai-response">
                    {steps.length > 0 && (
                        <div className="ai-response-body">
                            {steps.map((step, idx) => (
                                <div key={idx} className="ai-step">
                                    <div className={`ai-step-icon ${step.type}`}>
                                        {step.type === 'done' ? 'âœ“' : step.type === 'feature' ? 'â—†' : 'â—‹'}
                                    </div>
                                    <div className="ai-step-content">
                                        <div className="ai-step-title">{step.title}</div>
                                        <div className="ai-step-desc">{step.desc}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {summary && summary.length > 10 && (
                        <div className="ai-summary">{summary.substring(0, 200)}{summary.length > 200 ? '...' : ''}</div>
                    )}
                </div>
            );
        }

        // IA ë·° - ì„¸ë¡œ íŠ¸ë¦¬ í˜•íƒœ
        function IAView({ treeData, projectName, onPRDClick }) {
            if (!treeData || treeData.length === 0) {
                return <div className="empty-state"><h3>ê¸°ëŠ¥ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</h3><p>ì±„íŒ…ì°½ì—ì„œ ê¸°ëŠ¥ì„ ìš”ì²­í•´ë³´ì„¸ìš”</p></div>;
            }
            
            // í˜ì´ì§€ ë‹¨ìœ„ë¡œ ê·¸ë£¹í™” (ìµœìƒìœ„ ë…¸ë“œë“¤ì„ í˜ì´ì§€ë¡œ ì·¨ê¸‰)
            const pages = treeData.map(node => ({
                ...node,
                features: node.children || []
            }));
            
            // ê°€ë¡œ ì—°ê²°ì„  ë„ˆë¹„ ê³„ì‚°
            const branchWidth = Math.max(pages.length * 304 - 24, 100);
            
            return (
                <div className="ia-container">
                    {/* ë£¨íŠ¸ ë…¸ë“œ */}
                    <div className="ia-root">
                        <div className="ia-root-card">
                            <span className="icon">ğŸ“„</span>
                            <span className="title">{projectName || 'Untitled'}</span>
                            <span className="prd-link" onClick={onPRDClick}>â†— PRD</span>
                        </div>
                        
                        {/* ì„¸ë¡œ ì—°ê²°ì„  */}
                        <div className="ia-connector-v"></div>
                        
                        {/* ê°€ë¡œ ë¶„ê¸°ì„  */}
                        {pages.length > 1 && (
                            <div className="ia-branch-h" style={{width: branchWidth + 'px'}}>
                                <div style={{position: 'absolute', top: 0, left: '50%', transform: 'translateX(-50%)', width: branchWidth + 'px', height: '2px', background: '#475569'}}></div>
                            </div>
                        )}
                    </div>
                    
                    {/* í˜ì´ì§€ ì¹´ë“œë“¤ */}
                    <div className="ia-pages">
                        {pages.map((page, idx) => (
                            <IAPageCard key={page.id} page={page} index={idx} />
                        ))}
                    </div>
                </div>
            );
        }
        
        function IAPageCard({ page, index }) {
            const pageId = `P-${page.id.toString().padStart(4, '0')}`;
            
            return (
                <div className="ia-page">
                    {/* ì„¸ë¡œ ì—°ê²°ì„  */}
                    <div className="ia-page-connector"></div>
                    
                    {/* í˜ì´ì§€ ì¹´ë“œ */}
                    <div className="ia-page-card">
                        <div className="ia-page-header">
                            <span className="badge">1d</span>
                            <span className="title">{page.title}</span>
                            <span className="id">{pageId}</span>
                        </div>
                        
                        {page.description && (
                            <div className="ia-page-desc">
                                {page.description.substring(0, 80)}{page.description.length > 80 ? '...' : ''}
                            </div>
                        )}
                        
                        {page.features && page.features.length > 0 && (
                            <div className="ia-page-features">
                                <div className="ia-page-features-title">{page.title} ê¸°ëŠ¥</div>
                                {page.features.map(feature => (
                                    <div key={feature.id} className="ia-feature-item">
                                        {feature.title}
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {(!page.features || page.features.length === 0) && !page.description && (
                            <div className="ia-page-features">
                                <div className="ia-feature-item" style={{color: '#64748b'}}>í•˜ìœ„ ê¸°ëŠ¥ ì—†ìŒ</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function TreeView({ treeData }) {
            if (!treeData || treeData.length === 0) return <div className="empty-state"><h3>ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</h3></div>;
            return (
                <div style={{padding: '20px'}}>
                    {treeData.map(node => <TreeNode key={node.id} node={node} level={0} />)}
                </div>
            );
        }

        function TreeNode({ node, level }) {
            return (
                <div style={{marginLeft: level * 24 + 'px', marginBottom: '8px'}}>
                    <div className="node-card" style={{display: 'inline-block'}}>
                        <div className="node-title">{node.title}</div>
                        <div className="node-meta"><span className="badge todo">{node.nodeType}</span></div>
                    </div>
                    {node.children?.map(child => <TreeNode key={child.id} node={child} level={level + 1} />)}
                </div>
            );
        }

        function PRDView({ content, onGenerate }) {
            return (
                <div style={{padding: '20px', maxWidth: '800px'}}>
                    <h2 style={{marginBottom: '16px'}}>PRD Document</h2>
                    {content ? <div className="prd-content">{content}</div> : (
                        <div className="empty-state">
                            <h3>PRDê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                            <button className="export-btn" onClick={onGenerate} style={{marginTop: '16px'}}>PRD ìƒì„±</button>
                        </div>
                    )}
                </div>
            );
        }

        function NewProjectModal({ onClose, onCreate }) {
            const [name, setName] = useState('');
            const [desc, setDesc] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2>ìƒˆ í”„ë¡œì íŠ¸</h2>
                        <input placeholder="í”„ë¡œì íŠ¸ ì´ë¦„" value={name} onChange={e => setName(e.target.value)} autoFocus />
                        <textarea placeholder="ì„¤ëª…" rows="3" value={desc} onChange={e => setDesc(e.target.value)} />
                        <div className="modal-buttons">
                            <button className="primary" onClick={() => onCreate(name, desc)} disabled={!name}>ìƒì„±</button>
                            <button className="secondary" onClick={onClose}>ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PRDModal({ content, onClose }) {
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{width: '700px'}}>
                        <h2>Generated PRD</h2>
                        <div className="prd-content">{content}</div>
                        <div className="modal-buttons" style={{marginTop: '16px'}}>
                            <button className="secondary" onClick={onClose}>ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
