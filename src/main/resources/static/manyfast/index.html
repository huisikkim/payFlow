<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manyfast Editor MVP</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }
        .app { display: flex; height: 100vh; }
        
        /* 채팅 패널 */
        .chat-panel { width: 300px; background: #1e293b; display: flex; flex-direction: column; border-right: 1px solid #334155; }
        .chat-header { padding: 16px; border-bottom: 1px solid #334155; }
        .chat-header h2 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .project-select { width: 100%; padding: 8px 12px; background: #334155; border: none; border-radius: 6px; color: white; font-size: 13px; }
        .new-project-btn { width: 100%; margin-top: 8px; padding: 8px; background: transparent; border: 1px dashed #475569; border-radius: 6px; color: #64748b; cursor: pointer; font-size: 13px; }
        .new-project-btn:hover { border-color: #3b82f6; color: #3b82f6; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
        .message { margin-bottom: 12px; }
        .message.user { text-align: right; }
        .message-bubble { display: inline-block; max-width: 90%; padding: 8px 12px; border-radius: 10px; font-size: 13px; line-height: 1.5; }
        .message.user .message-bubble { background: #3b82f6; }
        .message.ai .message-bubble { background: #334155; }
        .typing { color: #64748b; font-size: 12px; padding: 8px; }
        .chat-input-area { padding: 12px; border-top: 1px solid #334155; }
        .chat-input { width: 100%; padding: 10px; background: #334155; border: none; border-radius: 6px; color: white; resize: none; font-size: 13px; }
        .chat-input:focus { outline: 1px solid #3b82f6; }
        .chat-input::placeholder { color: #64748b; }
        
        /* 메인 영역 */
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .toolbar { padding: 10px 16px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 8px; }
        .toolbar h1 { font-size: 16px; font-weight: 500; margin-right: 20px; }
        .tab-btn { padding: 6px 14px; background: transparent; border: 1px solid #334155; border-radius: 6px; color: #94a3b8; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .tab-btn:hover { border-color: #475569; color: #e2e8f0; }
        .tab-btn.active { background: #334155; border-color: #475569; color: white; }
        .export-btn { margin-left: auto; padding: 6px 14px; background: #3b82f6; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 13px; }
        .export-btn:hover { background: #2563eb; }
        
        /* FS 뷰 - 가로 마인드맵 */
        .fs-container { flex: 1; overflow: auto; padding: 40px; background: #0f172a; }
        .fs-mindmap { display: flex; align-items: flex-start; min-width: max-content; padding-left: 20px; }
        
        /* 루트 노드 */
        .root-node { display: flex; align-items: center; }
        .root-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 16px 20px; min-width: 120px; }
        .root-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .root-card .prd-link { font-size: 11px; color: #3b82f6; cursor: pointer; }
        .root-card .prd-link:hover { text-decoration: underline; }
        
        /* 연결선 컨테이너 */
        .connector-h { width: 60px; height: 2px; background: #334155; position: relative; }
        .connector-h::after { content: ''; position: absolute; right: -4px; top: -3px; width: 8px; height: 8px; background: #475569; border-radius: 50%; }
        
        /* Feature 컬럼 */
        .features-column { display: flex; flex-direction: column; gap: 16px; }
        .feature-row { display: flex; align-items: flex-start; }
        .feature-connector { width: 30px; display: flex; align-items: center; position: relative; }
        .feature-connector::before { content: ''; width: 100%; height: 2px; background: #334155; }
        .v-line { position: absolute; left: 0; width: 2px; background: #334155; }
        
        /* Feature 카드 */
        .feature-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 14px 16px; min-width: 280px; max-width: 320px; }
        .feature-card:hover { border-color: #475569; }
        .feature-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #f1f5f9; }
        .feature-desc { font-size: 11px; color: #94a3b8; line-height: 1.5; margin-bottom: 10px; }
        .feature-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: #334155; color: #94a3b8; }
        .status-badge.todo { background: #1e3a5f; color: #60a5fa; }
        .criteria-link { font-size: 10px; color: #8b5cf6; cursor: pointer; }
        
        /* Sub-feature 컬럼 */
        .subfeatures-column { display: flex; flex-direction: column; gap: 12px; margin-left: 40px; }
        .subfeature-row { display: flex; align-items: flex-start; }
        .sub-connector { width: 40px; display: flex; align-items: center; }
        .sub-connector::before { content: ''; width: 100%; height: 2px; background: #334155; }
        
        /* Sub-feature 카드 */
        .subfeature-card { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 10px 14px; min-width: 200px; }
        .subfeature-card:hover { border-color: #475569; }
        .subfeature-title { font-size: 12px; font-weight: 500; margin-bottom: 4px; }
        .subfeature-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; background: #334155; }
        .tag.tester { background: #1e3a5f; color: #60a5fa; }
        .tag.admin { background: #3f1e5f; color: #a78bfa; }
        .tag.developer { background: #1e3f3f; color: #5eead4; }
        
        /* Task 컬럼 */
        .tasks-column { display: flex; flex-direction: column; gap: 8px; margin-left: 30px; }
        .task-row { display: flex; align-items: center; }
        .task-connector { width: 30px; height: 2px; background: #334155; }
        .task-card { background: #1e293b; border: 1px solid #334155; border-radius: 4px; padding: 8px 12px; font-size: 11px; min-width: 160px; }
        .task-card:hover { border-color: #475569; }
        
        /* 모달 */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: #1e293b; padding: 24px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 16px; font-size: 18px; }
        .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; margin-bottom: 12px; font-size: 13px; }
        .modal-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .modal-buttons button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .modal-buttons .primary { background: #3b82f6; color: white; }
        .modal-buttons .secondary { background: #334155; color: #e2e8f0; }
        .prd-content { background: #0f172a; padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 13px; max-height: 400px; overflow-y: auto; }
        
        /* 빈 상태 */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #64748b; text-align: center; }
        .empty-state h3 { color: #94a3b8; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = '/api/manyfast';

        function App() {
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [treeData, setTreeData] = useState([]);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [activeTab, setActiveTab] = useState('FS');
            const [showPRD, setShowPRD] = useState(false);
            const [prdContent, setPrdContent] = useState('');
            const [showNewProject, setShowNewProject] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { loadProjects(); }, []);
            useEffect(() => { 
                if (currentProject) { 
                    loadProjectTree(); 
                    setMessages([{ type: 'ai', text: `"${currentProject.name}" 프로젝트입니다. 어떤 기능을 추가할까요?` }]); 
                } 
            }, [currentProject]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const loadProjects = async () => {
                const res = await fetch(`${API_BASE}/projects`);
                const data = await res.json();
                setProjects(data);
                if (data.length > 0 && !currentProject) setCurrentProject(data[0]);
            };

            const loadProjectTree = async () => {
                const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/tree`);
                setTreeData(await res.json());
            };

            const createProject = async (name, desc) => {
                const res = await fetch(`${API_BASE}/projects`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: desc })
                });
                const project = await res.json();
                setProjects([...projects, project]);
                setCurrentProject(project);
                setShowNewProject(false);
            };

            const handleSendMessage = async () => {
                if (!inputText.trim() || !currentProject) return;
                const userMessage = inputText.trim();
                setMessages(prev => [...prev, { type: 'user', text: userMessage }]);
                setInputText('');
                setIsTyping(true);

                try {
                    const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { type: 'ai', text: data.response }]);
                    if (data.nodesCreated > 0) loadProjectTree();
                } catch (e) {
                    setMessages(prev => [...prev, { type: 'ai', text: '오류가 발생했습니다.' }]);
                }
                setIsTyping(false);
            };

            const generatePRD = async () => {
                setIsTyping(true);
                const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/generate-prd`, { method: 'POST' });
                const data = await res.json();
                setPrdContent(data.prd);
                setShowPRD(true);
                setIsTyping(false);
            };

            return (
                <div className="app">
                    <div className="chat-panel">
                        <div className="chat-header">
                            <h2>New chat</h2>
                            <select className="project-select" value={currentProject?.id || ''} 
                                onChange={e => setCurrentProject(projects.find(p => p.id === parseInt(e.target.value)))}>
                                {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <button className="new-project-btn" onClick={() => setShowNewProject(true)}>+ 새 프로젝트</button>
                        </div>
                        
                        <div className="chat-messages">
                            {messages.map((msg, i) => (
                                <div key={i} className={`message ${msg.type}`}>
                                    <div className="message-bubble">{msg.text}</div>
                                </div>
                            ))}
                            {isTyping && <div className="typing">생각 중...</div>}
                            <div ref={messagesEndRef} />
                        </div>
                        
                        <div className="chat-input-area">
                            <textarea className="chat-input" placeholder="What do you want to create?"
                                value={inputText} onChange={e => setInputText(e.target.value)}
                                onKeyPress={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }}}
                                rows="2" />
                        </div>
                    </div>
                    
                    <div className="main-area">
                        <div className="toolbar">
                            <h1>{currentProject?.name || 'Manyfast'}</h1>
                            {['PRD', 'FS', 'IA', 'Tree', 'Directory'].map(tab => (
                                <button key={tab} className={`tab-btn ${activeTab === tab ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab)}>{tab}</button>
                            ))}
                            <button className="export-btn" onClick={generatePRD}>Export</button>
                        </div>
                        
                        <div className="fs-container">
                            {activeTab === 'FS' && <FSView treeData={treeData} projectName={currentProject?.name} onPRDClick={() => setShowPRD(true)} />}
                            {activeTab === 'PRD' && <PRDView content={prdContent} onGenerate={generatePRD} />}
                            {activeTab === 'Tree' && <TreeView treeData={treeData} />}
                            {(activeTab === 'IA' || activeTab === 'Directory') && (
                                <div className="empty-state"><h3>{activeTab} 뷰</h3><p>준비 중입니다</p></div>
                            )}
                        </div>
                    </div>

                    {showNewProject && <NewProjectModal onClose={() => setShowNewProject(false)} onCreate={createProject} />}
                    {showPRD && <PRDModal content={prdContent} onClose={() => setShowPRD(false)} />}
                </div>
            );
        }

        // FS 뷰 - 가로 마인드맵
        function FSView({ treeData, projectName, onPRDClick }) {
            if (!treeData || treeData.length === 0) {
                return (
                    <div className="empty-state">
                        <h3>기능을 추가해보세요</h3>
                        <p>채팅창에서 "로그인 기능 추가해줘" 라고 입력해보세요</p>
                    </div>
                );
            }

            // 트리를 Feature(1단계), SubFeature(2단계), Task(3단계)로 분류
            const features = treeData.filter(n => !n.parentId || n.nodeType === 'FEATURE' || n.nodeType === 'ROOT');
            
            return (
                <div className="fs-mindmap">
                    {/* 루트 노드 */}
                    <div className="root-node">
                        <div className="root-card">
                            <h3>{projectName || 'Project'}</h3>
                            <span className="prd-link" onClick={onPRDClick}>↗ PRD</span>
                        </div>
                        <div className="connector-h"></div>
                    </div>
                    
                    {/* Features 컬럼 */}
                    <div className="features-column">
                        {treeData.map((feature, idx) => (
                            <FeatureRow key={feature.id} feature={feature} isFirst={idx === 0} isLast={idx === treeData.length - 1} totalCount={treeData.length} />
                        ))}
                    </div>
                </div>
            );
        }

        function FeatureRow({ feature, isFirst, isLast, totalCount }) {
            const children = feature.children || [];
            const subFeatures = children.filter(c => c.nodeType === 'FEATURE' || c.nodeType === 'REQUIREMENT');
            const tasks = children.filter(c => c.nodeType === 'TASK');
            
            return (
                <div className="feature-row">
                    <div className="feature-connector">
                        {totalCount > 1 && (
                            <div className="v-line" style={{
                                top: isFirst ? '50%' : 0,
                                bottom: isLast ? '50%' : 0,
                                height: isFirst || isLast ? '50%' : '100%'
                            }}></div>
                        )}
                    </div>
                    
                    <div className="feature-card">
                        <div className="feature-title">{feature.title}</div>
                        {feature.description && <div className="feature-desc">{feature.description}</div>}
                        <div className="feature-meta">
                            <span className="status-badge todo">To Do</span>
                            <span className="criteria-link">Acceptance Criteria: 0/2</span>
                        </div>
                    </div>
                    
                    {children.length > 0 && (
                        <>
                            <div className="connector-h" style={{width: '40px'}}></div>
                            <div className="subfeatures-column">
                                {children.map((child, idx) => (
                                    <SubFeatureRow key={child.id} node={child} isFirst={idx === 0} isLast={idx === children.length - 1} totalCount={children.length} />
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        function SubFeatureRow({ node, isFirst, isLast, totalCount }) {
            const children = node.children || [];
            const tags = ['To Do'];
            if (node.nodeType === 'TASK') tags.push('Tester');
            if (node.nodeType === 'REQUIREMENT') tags.push('Developer');
            if (node.nodeType === 'FEATURE') tags.push('Admin');
            
            return (
                <div className="subfeature-row">
                    <div className="sub-connector" style={{position: 'relative'}}>
                        {totalCount > 1 && (
                            <div className="v-line" style={{
                                position: 'absolute', left: 0,
                                top: isFirst ? '50%' : 0,
                                bottom: isLast ? '50%' : 0,
                                height: isFirst || isLast ? '50%' : '100%'
                            }}></div>
                        )}
                    </div>
                    
                    <div className="subfeature-card">
                        <div className="subfeature-title">{node.title}</div>
                        <div className="subfeature-tags">
                            <span className="tag tester">To Do</span>
                            {node.nodeType === 'TASK' && <span className="tag tester">Tester</span>}
                            {node.nodeType === 'REQUIREMENT' && <span className="tag developer">Developer</span>}
                            {node.nodeType === 'FEATURE' && <span className="tag admin">Admin</span>}
                        </div>
                    </div>
                    
                    {children.length > 0 && (
                        <>
                            <div className="task-connector"></div>
                            <div className="tasks-column">
                                {children.map(task => (
                                    <div key={task.id} className="task-row">
                                        <div className="task-connector"></div>
                                        <div className="task-card">{task.title}</div>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        function TreeView({ treeData }) {
            if (!treeData || treeData.length === 0) {
                return <div className="empty-state"><h3>노드가 없습니다</h3></div>;
            }
            return (
                <div style={{padding: '20px'}}>
                    {treeData.map(node => <TreeNode key={node.id} node={node} level={0} />)}
                </div>
            );
        }

        function TreeNode({ node, level }) {
            return (
                <div style={{marginLeft: level * 24 + 'px', marginBottom: '8px'}}>
                    <div className="feature-card" style={{display: 'inline-block', minWidth: '200px'}}>
                        <div className="feature-title">{node.title}</div>
                        <div className="feature-meta"><span className="status-badge">{node.nodeType}</span></div>
                    </div>
                    {node.children?.map(child => <TreeNode key={child.id} node={child} level={level + 1} />)}
                </div>
            );
        }

        function PRDView({ content, onGenerate }) {
            return (
                <div style={{padding: '20px', maxWidth: '800px'}}>
                    <h2 style={{marginBottom: '16px'}}>PRD Document</h2>
                    {content ? (
                        <div className="prd-content">{content}</div>
                    ) : (
                        <div className="empty-state">
                            <h3>PRD가 없습니다</h3>
                            <button className="export-btn" onClick={onGenerate} style={{marginTop: '16px'}}>PRD 생성하기</button>
                        </div>
                    )}
                </div>
            );
        }

        function NewProjectModal({ onClose, onCreate }) {
            const [name, setName] = useState('');
            const [desc, setDesc] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2>새 프로젝트</h2>
                        <input placeholder="프로젝트 이름" value={name} onChange={e => setName(e.target.value)} autoFocus />
                        <textarea placeholder="설명" rows="3" value={desc} onChange={e => setDesc(e.target.value)} />
                        <div className="modal-buttons">
                            <button className="primary" onClick={() => onCreate(name, desc)} disabled={!name}>생성</button>
                            <button className="secondary" onClick={onClose}>취소</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PRDModal({ content, onClose }) {
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{width: '700px'}}>
                        <h2>Generated PRD</h2>
                        <div className="prd-content">{content}</div>
                        <div className="modal-buttons" style={{marginTop: '16px'}}>
                            <button className="secondary" onClick={onClose}>닫기</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
