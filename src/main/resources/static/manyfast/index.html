<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manyfast Editor MVP</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; }
        .app { display: flex; height: 100vh; }
        .sidebar { width: 280px; background: #1e293b; color: white; padding: 20px; overflow-y: auto; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .toolbar { background: #fff; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; align-items: center; }
        .canvas { flex: 1; padding: 20px; overflow: auto; }
        .tree-container { background: white; border-radius: 12px; padding: 20px; min-height: 400px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #e2e8f0; color: #475569; }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .project-item { padding: 12px 15px; background: #334155; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .project-item:hover { background: #475569; }
        .project-item.selected { background: #3b82f6; }
        h2 { font-size: 20px; margin-bottom: 20px; }
        h3 { font-size: 13px; margin-bottom: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 500px; max-height: 80vh; overflow-y: auto; }
        .prd-viewer { white-space: pre-wrap; line-height: 1.8; font-size: 14px; background: #f8fafc; padding: 20px; border-radius: 8px; }
        .tree-node { padding: 12px 16px; background: #f1f5f9; margin: 8px 0; border-radius: 8px; border-left: 4px solid #3b82f6; cursor: pointer; transition: all 0.2s; }
        .tree-node:hover { background: #e2e8f0; transform: translateX(4px); }
        .tree-node.feature { border-left-color: #8b5cf6; }
        .tree-node.task { border-left-color: #f59e0b; }
        .tree-node.requirement { border-left-color: #10b981; }
        .tree-children { margin-left: 24px; border-left: 2px dashed #cbd5e1; padding-left: 16px; }
        .node-type { font-size: 11px; color: #64748b; background: #e2e8f0; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .logo { font-size: 24px; font-weight: 700; margin-bottom: 30px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = '/api/manyfast';

        function App() {
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [treeData, setTreeData] = useState([]);
            const [showNewProject, setShowNewProject] = useState(false);
            const [showNewNode, setShowNewNode] = useState(false);
            const [showPRD, setShowPRD] = useState(false);
            const [prdContent, setPrdContent] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => { loadProjects(); }, []);
            useEffect(() => { if (currentProject) loadProjectTree(); }, [currentProject]);

            const loadProjects = async () => {
                try {
                    const res = await fetch(`${API_BASE}/projects`);
                    const data = await res.json();
                    setProjects(data);
                } catch (e) { console.error('Failed to load projects:', e); }
            };

            const loadProjectTree = async () => {
                try {
                    const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/tree`);
                    const data = await res.json();
                    setTreeData(data);
                } catch (e) { console.error('Failed to load tree:', e); }
            };

            const createProject = async (name, description) => {
                const res = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                const project = await res.json();
                setProjects([...projects, project]);
                setCurrentProject(project);
                setShowNewProject(false);
            };

            const createNode = async (nodeData) => {
                await fetch(`${API_BASE}/projects/${currentProject.projectId}/nodes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nodeData)
                });
                loadProjectTree();
                setShowNewNode(false);
            };

            const generatePRD = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/generate-prd`, { method: 'POST' });
                    const data = await res.json();
                    setPrdContent(data.prd);
                    setShowPRD(true);
                } catch (e) { alert('PRD 생성 실패'); }
                setLoading(false);
            };

            return (
                <div className="app">
                    <div className="sidebar">
                        <div className="logo">Manyfast</div>
                        <button className="btn-primary" style={{width: '100%', marginBottom: '20px'}} onClick={() => setShowNewProject(true)}>
                            + 새 프로젝트
                        </button>
                        <h3>프로젝트 목록</h3>
                        {projects.map(p => (
                            <div key={p.id} className={`project-item ${currentProject?.id === p.id ? 'selected' : ''}`}
                                 onClick={() => setCurrentProject(p)}>
                                {p.name}
                            </div>
                        ))}
                        {projects.length === 0 && <p style={{color: '#64748b', fontSize: '14px'}}>프로젝트가 없습니다</p>}
                    </div>
                    
                    <div className="main">
                        {currentProject ? (
                            <>
                                <div className="toolbar">
                                    <h2>{currentProject.name}</h2>
                                    <div style={{flex: 1}}></div>
                                    <button className="btn-secondary" onClick={() => setShowNewNode(true)}>+ 노드 추가</button>
                                    <button className="btn-success" onClick={generatePRD} disabled={loading}>
                                        {loading ? '생성 중...' : 'PRD 생성'}
                                    </button>
                                </div>
                                <div className="canvas">
                                    <div className="tree-container">
                                        <h3>기능 트리</h3>
                                        {treeData.length > 0 ? (
                                            <TreeView nodes={treeData} />
                                        ) : (
                                            <div className="empty-state">
                                                <p>노드를 추가해서 기능 구조를 만들어보세요</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="canvas">
                                <div className="empty-state" style={{marginTop: '100px'}}>
                                    <h2 style={{color: '#475569', marginBottom: '10px'}}>프로젝트를 선택하세요</h2>
                                    <p>왼쪽에서 프로젝트를 선택하거나 새로 만들어보세요</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {showNewProject && <NewProjectModal onClose={() => setShowNewProject(false)} onCreate={createProject} />}
                    {showNewNode && <NewNodeModal onClose={() => setShowNewNode(false)} onCreate={createNode} treeData={treeData} />}
                    {showPRD && <PRDModal content={prdContent} onClose={() => setShowPRD(false)} />}
                </div>
            );
        }

        function TreeView({ nodes, level = 0 }) {
            return nodes.map(node => (
                <div key={node.id}>
                    <div className={`tree-node ${node.nodeType.toLowerCase()}`}>
                        <strong>{node.title}</strong>
                        <span className="node-type">{node.nodeType}</span>
                        {node.description && <p style={{margin: '8px 0 0', fontSize: '13px', color: '#64748b'}}>{node.description}</p>}
                    </div>
                    {node.children && node.children.length > 0 && (
                        <div className="tree-children">
                            <TreeView nodes={node.children} level={level + 1} />
                        </div>
                    )}
                </div>
            ));
        }

        function NewProjectModal({ onClose, onCreate }) {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2 style={{marginBottom: '20px'}}>새 프로젝트</h2>
                        <input placeholder="프로젝트 이름" value={name} onChange={e => setName(e.target.value)} autoFocus />
                        <textarea placeholder="설명" rows="4" value={description} onChange={e => setDescription(e.target.value)} />
                        <div style={{display: 'flex', gap: '10px', marginTop: '10px'}}>
                            <button className="btn-primary" onClick={() => onCreate(name, description)} disabled={!name}>생성</button>
                            <button className="btn-secondary" onClick={onClose}>취소</button>
                        </div>
                    </div>
                </div>
            );
        }

        function flattenTree(nodes, result = []) {
            nodes.forEach(node => {
                result.push(node);
                if (node.children) flattenTree(node.children, result);
            });
            return result;
        }

        function NewNodeModal({ onClose, onCreate, treeData }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [nodeType, setNodeType] = useState('FEATURE');
            const [parentId, setParentId] = useState('');
            const allNodes = flattenTree(treeData);
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2 style={{marginBottom: '20px'}}>새 노드</h2>
                        <input placeholder="제목" value={title} onChange={e => setTitle(e.target.value)} autoFocus />
                        <textarea placeholder="설명" rows="3" value={description} onChange={e => setDescription(e.target.value)} />
                        <select value={nodeType} onChange={e => setNodeType(e.target.value)}>
                            <option value="ROOT">Root (루트)</option>
                            <option value="FEATURE">Feature (기능)</option>
                            <option value="TASK">Task (작업)</option>
                            <option value="REQUIREMENT">Requirement (요구사항)</option>
                        </select>
                        <select value={parentId} onChange={e => setParentId(e.target.value)}>
                            <option value="">상위 노드 없음</option>
                            {allNodes.map(n => <option key={n.id} value={n.id}>{n.title}</option>)}
                        </select>
                        <div style={{display: 'flex', gap: '10px', marginTop: '10px'}}>
                            <button className="btn-primary" onClick={() => onCreate({
                                title, description, nodeType,
                                parentId: parentId ? parseInt(parentId) : null,
                                position: allNodes.length
                            })} disabled={!title}>생성</button>
                            <button className="btn-secondary" onClick={onClose}>취소</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PRDModal({ content, onClose }) {
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{width: '700px'}}>
                        <h2 style={{marginBottom: '20px'}}>생성된 PRD</h2>
                        <div className="prd-viewer">{content}</div>
                        <button className="btn-secondary" onClick={onClose} style={{marginTop: '20px'}}>닫기</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
