<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manyfast Editor MVP</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }
        .app { display: flex; height: 100vh; }
        
        .chat-panel { width: 300px; background: #1e293b; display: flex; flex-direction: column; border-right: 1px solid #334155; }
        .chat-header { padding: 16px; border-bottom: 1px solid #334155; }
        .chat-header h2 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .project-select { width: 100%; padding: 8px 12px; background: #334155; border: none; border-radius: 6px; color: white; font-size: 13px; }
        .new-project-btn { width: 100%; margin-top: 8px; padding: 8px; background: transparent; border: 1px dashed #475569; border-radius: 6px; color: #64748b; cursor: pointer; }
        .new-project-btn:hover { border-color: #3b82f6; color: #3b82f6; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
        .message { margin-bottom: 12px; }
        .message.user { text-align: right; }
        .message-bubble { display: inline-block; max-width: 90%; padding: 8px 12px; border-radius: 10px; font-size: 13px; line-height: 1.5; }
        .message.user .message-bubble { background: #3b82f6; }
        .message.ai .message-bubble { background: #334155; }
        .typing { color: #64748b; font-size: 12px; padding: 8px; }
        .chat-input-area { padding: 12px; border-top: 1px solid #334155; }
        .chat-input { width: 100%; padding: 10px; background: #334155; border: none; border-radius: 6px; color: white; resize: none; font-size: 13px; }
        .chat-input:focus { outline: 1px solid #3b82f6; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .toolbar { padding: 10px 16px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 8px; }
        .toolbar h1 { font-size: 16px; font-weight: 500; margin-right: 20px; }
        .tab-btn { padding: 6px 14px; background: transparent; border: 1px solid #334155; border-radius: 6px; color: #94a3b8; cursor: pointer; font-size: 13px; }
        .tab-btn:hover { border-color: #475569; color: #e2e8f0; }
        .tab-btn.active { background: #334155; border-color: #475569; color: white; }
        .export-btn { margin-left: auto; padding: 6px 14px; background: #3b82f6; border: none; border-radius: 6px; color: white; cursor: pointer; }
        
        .fs-container { flex: 1; overflow: auto; padding: 40px; background: #0f172a; }
        
        /* 마인드맵 레이아웃 */
        .mindmap { display: flex; align-items: center; gap: 0; }
        .node-column { display: flex; flex-direction: column; gap: 20px; position: relative; }
        
        /* 노드 카드 */
        .node-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 14px 18px; min-width: 200px; max-width: 300px; position: relative; }
        .node-card:hover { border-color: #475569; }
        .node-card.root { background: linear-gradient(135deg, #1e293b, #334155); }
        .node-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .node-desc { font-size: 11px; color: #94a3b8; line-height: 1.4; margin-bottom: 8px; }
        .node-meta { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .badge.todo { background: #1e3a5f; color: #60a5fa; }
        .badge.admin { background: #3f1e5f; color: #a78bfa; }
        .prd-link { font-size: 11px; color: #3b82f6; cursor: pointer; }
        
        /* 연결선 - 가로 */
        .h-connector { width: 50px; height: 2px; background: #475569; align-self: center; }
        
        /* 연결선 - 세로 브랜치 */
        .branch-container { display: flex; align-items: stretch; }
        .v-branch { width: 50px; position: relative; display: flex; flex-direction: column; justify-content: center; }
        .v-branch::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 2px; background: #475569; }
        .v-branch-line { position: absolute; left: 0; width: 2px; background: #475569; }
        
        /* 브랜치 아이템 */
        .branch-item { display: flex; align-items: center; position: relative; }
        .branch-connector { width: 50px; height: 2px; background: #475569; }
        
        /* 모달 */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: #1e293b; padding: 24px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; margin-bottom: 12px; }
        .modal-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .modal-buttons button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        .modal-buttons .primary { background: #3b82f6; color: white; }
        .modal-buttons .secondary { background: #334155; color: #e2e8f0; }
        .prd-content { background: #0f172a; padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 13px; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #64748b; }
        .empty-state h3 { color: #94a3b8; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = '/api/manyfast';

        function App() {
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [treeData, setTreeData] = useState([]);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [activeTab, setActiveTab] = useState('FS');
            const [showPRD, setShowPRD] = useState(false);
            const [prdContent, setPrdContent] = useState('');
            const [showNewProject, setShowNewProject] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { loadProjects(); }, []);
            useEffect(() => { 
                if (currentProject) { 
                    loadProjectTree(); 
                    setMessages([{ type: 'ai', text: `"${currentProject.name}" 프로젝트입니다.` }]); 
                } 
            }, [currentProject]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const loadProjects = async () => {
                const res = await fetch(`${API_BASE}/projects`);
                const data = await res.json();
                setProjects(data);
                if (data.length > 0 && !currentProject) setCurrentProject(data[0]);
            };

            const loadProjectTree = async () => {
                const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/tree`);
                setTreeData(await res.json());
            };

            const createProject = async (name, desc) => {
                const res = await fetch(`${API_BASE}/projects`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: desc })
                });
                const project = await res.json();
                setProjects([...projects, project]);
                setCurrentProject(project);
                setShowNewProject(false);
            };

            const handleSendMessage = async () => {
                if (!inputText.trim() || !currentProject) return;
                const userMessage = inputText.trim();
                setMessages(prev => [...prev, { type: 'user', text: userMessage }]);
                setInputText('');
                setIsTyping(true);
                try {
                    const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/chat`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { type: 'ai', text: data.response }]);
                    if (data.nodesCreated > 0) loadProjectTree();
                } catch (e) {
                    setMessages(prev => [...prev, { type: 'ai', text: '오류가 발생했습니다.' }]);
                }
                setIsTyping(false);
            };

            const generatePRD = async () => {
                setIsTyping(true);
                const res = await fetch(`${API_BASE}/projects/${currentProject.projectId}/generate-prd`, { method: 'POST' });
                const data = await res.json();
                setPrdContent(data.prd);
                setShowPRD(true);
                setIsTyping(false);
            };

            return (
                <div className="app">
                    <div className="chat-panel">
                        <div className="chat-header">
                            <h2>New chat</h2>
                            <select className="project-select" value={currentProject?.id || ''} 
                                onChange={e => setCurrentProject(projects.find(p => p.id === parseInt(e.target.value)))}>
                                {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            <button className="new-project-btn" onClick={() => setShowNewProject(true)}>+ 새 프로젝트</button>
                        </div>
                        <div className="chat-messages">
                            {messages.map((msg, i) => (
                                <div key={i} className={`message ${msg.type}`}>
                                    <div className="message-bubble">{msg.text}</div>
                                </div>
                            ))}
                            {isTyping && <div className="typing">생각 중...</div>}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="chat-input-area">
                            <textarea className="chat-input" placeholder="What do you want to create?"
                                value={inputText} onChange={e => setInputText(e.target.value)}
                                onKeyPress={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }}}
                                rows="2" />
                        </div>
                    </div>
                    
                    <div className="main-area">
                        <div className="toolbar">
                            <h1>{currentProject?.name || 'Manyfast'}</h1>
                            {['PRD', 'FS', 'IA', 'Tree', 'Directory'].map(tab => (
                                <button key={tab} className={`tab-btn ${activeTab === tab ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab)}>{tab}</button>
                            ))}
                            <button className="export-btn" onClick={generatePRD}>Export</button>
                        </div>
                        <div className="fs-container">
                            {activeTab === 'FS' && <MindmapView treeData={treeData} projectName={currentProject?.name} onPRDClick={() => setShowPRD(true)} />}
                            {activeTab === 'PRD' && <PRDView content={prdContent} onGenerate={generatePRD} />}
                            {activeTab === 'Tree' && <TreeView treeData={treeData} />}
                            {(activeTab === 'IA' || activeTab === 'Directory') && <div className="empty-state"><h3>{activeTab} 뷰 준비 중</h3></div>}
                        </div>
                    </div>
                    {showNewProject && <NewProjectModal onClose={() => setShowNewProject(false)} onCreate={createProject} />}
                    {showPRD && <PRDModal content={prdContent} onClose={() => setShowPRD(false)} />}
                </div>
            );
        }

        // 마인드맵 뷰 - SVG 연결선 사용
        function MindmapView({ treeData, projectName, onPRDClick }) {
            if (!treeData || treeData.length === 0) {
                return <div className="empty-state"><h3>기능을 추가해보세요</h3><p>채팅창에서 기능을 요청해보세요</p></div>;
            }
            
            return (
                <div className="mindmap">
                    {/* 루트 노드 */}
                    <div className="node-card root">
                        <div className="node-title">{projectName || 'Project'}</div>
                        <span className="prd-link" onClick={onPRDClick}>↗ PRD</span>
                    </div>
                    
                    {/* 1단계 연결선 */}
                    <div className="h-connector"></div>
                    
                    {/* 1단계 노드들 */}
                    <NodeBranch nodes={treeData} level={1} />
                </div>
            );
        }
        
        function NodeBranch({ nodes, level }) {
            const containerRef = useRef(null);
            const [nodePositions, setNodePositions] = useState([]);
            
            useEffect(() => {
                if (containerRef.current) {
                    const nodeElements = containerRef.current.querySelectorAll(':scope > .node-row');
                    const positions = Array.from(nodeElements).map(el => {
                        const rect = el.getBoundingClientRect();
                        const containerRect = containerRef.current.getBoundingClientRect();
                        return {
                            top: rect.top - containerRect.top,
                            height: rect.height,
                            center: rect.top - containerRect.top + rect.height / 2
                        };
                    });
                    setNodePositions(positions);
                }
            }, [nodes]);
            
            if (!nodes || nodes.length === 0) return null;
            
            const totalHeight = nodePositions.length > 0 
                ? nodePositions[nodePositions.length - 1].top + nodePositions[nodePositions.length - 1].height
                : nodes.length * 100;
            
            const firstCenter = nodePositions[0]?.center || 50;
            const lastCenter = nodePositions[nodePositions.length - 1]?.center || totalHeight - 50;
            const midY = totalHeight / 2;
            
            return (
                <div style={{display: 'flex', alignItems: 'stretch'}}>
                    {/* 연결선 SVG */}
                    <svg width="50" height={totalHeight} style={{flexShrink: 0, minHeight: totalHeight}}>
                        {/* 입력선 (왼쪽 → 중앙) */}
                        <line x1="0" y1={midY} x2="25" y2={midY} stroke="#475569" strokeWidth="2"/>
                        
                        {nodes.length > 1 && nodePositions.length > 1 ? (
                            <>
                                {/* 세로선 */}
                                <line x1="25" y1={firstCenter} x2="25" y2={lastCenter} stroke="#475569" strokeWidth="2"/>
                                {/* 각 노드로 가는 가로선 */}
                                {nodePositions.map((pos, idx) => (
                                    <line key={idx} x1="25" y1={pos.center} x2="50" y2={pos.center} stroke="#475569" strokeWidth="2"/>
                                ))}
                            </>
                        ) : (
                            <line x1="25" y1={midY} x2="50" y2={midY} stroke="#475569" strokeWidth="2"/>
                        )}
                    </svg>
                    
                    {/* 노드 컬럼 */}
                    <div ref={containerRef} style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                        {nodes.map((node) => (
                            <div key={node.id} className="node-row" style={{display: 'flex', alignItems: 'center'}}>
                                <div className="node-card">
                                    <div className="node-title">{node.title}</div>
                                    {node.description && <div className="node-desc">{node.description.substring(0, 50)}...</div>}
                                    <div className="node-meta">
                                        <span className="badge todo">To Do</span>
                                        {node.nodeType === 'FEATURE' && <span className="badge admin">Admin</span>}
                                    </div>
                                </div>
                                
                                {node.children && node.children.length > 0 && (
                                    <NodeBranch nodes={node.children} level={level + 1} />
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function TreeView({ treeData }) {
            if (!treeData || treeData.length === 0) return <div className="empty-state"><h3>노드가 없습니다</h3></div>;
            return (
                <div style={{padding: '20px'}}>
                    {treeData.map(node => <TreeNode key={node.id} node={node} level={0} />)}
                </div>
            );
        }

        function TreeNode({ node, level }) {
            return (
                <div style={{marginLeft: level * 24 + 'px', marginBottom: '8px'}}>
                    <div className="node-card" style={{display: 'inline-block'}}>
                        <div className="node-title">{node.title}</div>
                        <div className="node-meta"><span className="badge todo">{node.nodeType}</span></div>
                    </div>
                    {node.children?.map(child => <TreeNode key={child.id} node={child} level={level + 1} />)}
                </div>
            );
        }

        function PRDView({ content, onGenerate }) {
            return (
                <div style={{padding: '20px', maxWidth: '800px'}}>
                    <h2 style={{marginBottom: '16px'}}>PRD Document</h2>
                    {content ? <div className="prd-content">{content}</div> : (
                        <div className="empty-state">
                            <h3>PRD가 없습니다</h3>
                            <button className="export-btn" onClick={onGenerate} style={{marginTop: '16px'}}>PRD 생성</button>
                        </div>
                    )}
                </div>
            );
        }

        function NewProjectModal({ onClose, onCreate }) {
            const [name, setName] = useState('');
            const [desc, setDesc] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2>새 프로젝트</h2>
                        <input placeholder="프로젝트 이름" value={name} onChange={e => setName(e.target.value)} autoFocus />
                        <textarea placeholder="설명" rows="3" value={desc} onChange={e => setDesc(e.target.value)} />
                        <div className="modal-buttons">
                            <button className="primary" onClick={() => onCreate(name, desc)} disabled={!name}>생성</button>
                            <button className="secondary" onClick={onClose}>취소</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PRDModal({ content, onClose }) {
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{width: '700px'}}>
                        <h2>Generated PRD</h2>
                        <div className="prd-content">{content}</div>
                        <div className="modal-buttons" style={{marginTop: '16px'}}>
                            <button className="secondary" onClick={onClose}>닫기</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
