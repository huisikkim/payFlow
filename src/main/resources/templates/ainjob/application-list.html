<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì› ë‚´ì—­ - ì§ì‡ë‹¤</title>
    <link rel="stylesheet" th:href="@{/css/ainjob.css}">
    <style th:replace="~{fragments/navigation :: nav-style}"></style>
</head>
<body>
    <header>
        <nav th:replace="~{fragments/navigation :: nav}"></nav>
    </header>
    
    <div class="ainjob-container">
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">ğŸ“ ì§€ì› ë‚´ì—­</h2>
                <div class="filter-group">
                    <select id="status-filter" class="filter-select" onchange="filterByStatus()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="APPLIED">ì§€ì›</option>
                        <option value="DOCUMENT_PASS">ì„œë¥˜í•©ê²©</option>
                        <option value="INTERVIEW_1">1ì°¨ë©´ì ‘</option>
                        <option value="INTERVIEW_2">2ì°¨ë©´ì ‘</option>
                        <option value="FINAL_PASS">ìµœì¢…í•©ê²©</option>
                        <option value="REJECTED">ë¶ˆí•©ê²©</option>
                    </select>
                </div>
            </div>
            
            <div id="application-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ì§€ì› ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë§¤ì¹­ ì ìˆ˜ ëª¨ë‹¬ -->
    <div id="matching-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin: 0 0 24px 0; font-size: 24px; color: #212529;">ğŸ“Š ë§¤ì¹­ ì ìˆ˜ ë¶„ì„</h2>
            
            <div id="matching-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ë§¤ì¹­ ì ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</p>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-secondary" onclick="closeMatchingModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <script th:replace="~{fragments/navigation :: nav-script}"></script>
    <script>
        let allApplications = [];
        
        async function loadApplications() {
            try {
                const response = await fetch('/api/ainjob/applications');
                
                if (!response.ok) {
                    throw new Error('ì§€ì› ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                allApplications = await response.json();
                displayApplications(allApplications);
                
            } catch (error) {
                console.error('ì§€ì› ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('application-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function displayApplications(applications) {
            const container = document.getElementById('application-list');
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-title">ì•„ì§ ì§€ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">ì±„ìš© ê³µê³ ì—ì„œ ì§€ì›í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§€ì›í•´ë³´ì„¸ìš”</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ì§€ì›ì ID</th>
                            <th>ì±„ìš© ê³µê³  ID</th>
                            <th>ìƒíƒœ</th>
                            <th>ì§€ì›ì¼</th>
                            <th>ìµœì¢… ìˆ˜ì •ì¼</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            applications.forEach(app => {
                const statusBadge = getStatusBadge(app.status);
                const appliedAt = new Date(app.appliedAt).toLocaleString('ko-KR');
                const updatedAt = app.updatedAt ? new Date(app.updatedAt).toLocaleString('ko-KR') : '-';
                
                html += `
                    <tr>
                        <td>${app.applicantId}</td>
                        <td>${app.jobPostingId}</td>
                        <td>${statusBadge}</td>
                        <td>${appliedAt}</td>
                        <td>${updatedAt}</td>
                        <td>
                            <button class="btn-sm btn-primary" onclick="changeStatus(${app.id}, '${app.status}')">
                                ìƒíƒœ ë³€ê²½
                            </button>
                            <button class="btn-sm" onclick="showMatchingScore(${app.id})" 
                                    style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-left: 4px;">
                                ë§¤ì¹­ ì ìˆ˜
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function getStatusBadge(status) {
            const badges = {
                'APPLIED': '<span class="badge badge-applied">ì§€ì›</span>',
                'DOCUMENT_PASS': '<span class="badge badge-document-pass">ì„œë¥˜í•©ê²©</span>',
                'INTERVIEW_1': '<span class="badge badge-interview">1ì°¨ë©´ì ‘</span>',
                'INTERVIEW_2': '<span class="badge badge-interview">2ì°¨ë©´ì ‘</span>',
                'FINAL_PASS': '<span class="badge badge-final-pass">ìµœì¢…í•©ê²©</span>',
                'REJECTED': '<span class="badge badge-rejected">ë¶ˆí•©ê²©</span>'
            };
            return badges[status] || status;
        }
        
        function filterByStatus() {
            const selectedStatus = document.getElementById('status-filter').value;
            
            if (selectedStatus === '') {
                displayApplications(allApplications);
            } else {
                const filtered = allApplications.filter(app => app.status === selectedStatus);
                displayApplications(filtered);
            }
        }
        
        async function changeStatus(applicationId, currentStatus) {
            const statusOptions = {
                'APPLIED': ['DOCUMENT_PASS', 'REJECTED'],
                'DOCUMENT_PASS': ['INTERVIEW_1', 'REJECTED'],
                'INTERVIEW_1': ['INTERVIEW_2', 'REJECTED'],
                'INTERVIEW_2': ['FINAL_PASS', 'REJECTED'],
                'FINAL_PASS': [],
                'REJECTED': []
            };
            
            const availableStatuses = statusOptions[currentStatus] || [];
            
            if (availableStatuses.length === 0) {
                alert('ë” ì´ìƒ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const statusNames = {
                'DOCUMENT_PASS': 'ì„œë¥˜í•©ê²©',
                'INTERVIEW_1': '1ì°¨ë©´ì ‘',
                'INTERVIEW_2': '2ì°¨ë©´ì ‘',
                'FINAL_PASS': 'ìµœì¢…í•©ê²©',
                'REJECTED': 'ë¶ˆí•©ê²©'
            };
            
            let options = availableStatuses.map(s => 
                `<option value="${s}">${statusNames[s]}</option>`
            ).join('');
            
            const newStatus = prompt(
                `ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n` +
                availableStatuses.map((s, i) => `${i + 1}. ${statusNames[s]}`).join('\n') +
                `\n\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1-${availableStatuses.length}):`
            );
            
            if (!newStatus) return;
            
            const index = parseInt(newStatus) - 1;
            if (index < 0 || index >= availableStatuses.length) {
                alert('ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.');
                return;
            }
            
            const toStatus = availableStatuses[index];
            const reason = prompt('ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (!reason) {
                alert('ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`/api/ainjob/applications/${applicationId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fromStatus: currentStatus,
                        toStatus: toStatus,
                        reason: reason
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                }
                
                alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadApplications();
                
            } catch (error) {
                console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        async function showMatchingScore(applicationId) {
            const modal = document.getElementById('matching-modal');
            modal.style.display = 'flex';
            
            const contentDiv = document.getElementById('matching-content');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ë§¤ì¹­ ì ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/ainjob/applications/${applicationId}/matching-score`);
                
                if (!response.ok) {
                    throw new Error('ë§¤ì¹­ ì ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                const score = await response.json();
                
                const percentage = score.matchingPercentage.toFixed(1);
                const progressColor = percentage >= 75 ? '#28a745' : percentage >= 50 ? '#ffc107' : '#dc3545';
                
                let html = `
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 48px; font-weight: bold; color: ${progressColor};">
                            ${score.totalScore} / ${score.maxScore}
                        </div>
                        <div style="font-size: 18px; color: #6c757d; margin-top: 8px;">
                            ë§¤ì¹­ë¥ : ${percentage}%
                        </div>
                        <div style="width: 100%; height: 12px; background: #e9ecef; border-radius: 6px; margin-top: 16px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${progressColor}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                        <h4 style="margin: 0 0 12px 0; font-size: 16px;">ğŸ’¡ ì¶”ì²œ ì˜ê²¬</h4>
                        <p style="margin: 0; color: #495057; line-height: 1.6;">${score.recommendation}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="padding: 16px; border: 2px solid ${score.educationScore > 0 ? '#28a745' : '#dc3545'}; border-radius: 8px;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">í•™ë ¥</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${score.educationScore > 0 ? '#28a745' : '#dc3545'};">
                                ${score.educationScore} / 25
                            </div>
                        </div>
                        <div style="padding: 16px; border: 2px solid ${score.majorScore > 0 ? '#28a745' : '#dc3545'}; border-radius: 8px;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">ì „ê³µ</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${score.majorScore > 0 ? '#28a745' : '#dc3545'};">
                                ${score.majorScore} / 25
                            </div>
                        </div>
                        <div style="padding: 16px; border: 2px solid ${score.skillScore > 0 ? '#28a745' : '#dc3545'}; border-radius: 8px;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">ìŠ¤í‚¬</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${score.skillScore > 0 ? '#28a745' : '#dc3545'};">
                                ${score.skillScore} / 25
                            </div>
                        </div>
                        <div style="padding: 16px; border: 2px solid ${score.experienceScore > 0 ? '#28a745' : '#dc3545'}; border-radius: 8px;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">ê²½ë ¥</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${score.experienceScore > 0 ? '#28a745' : '#dc3545'};">
                                ${score.experienceScore} / 25
                            </div>
                        </div>
                    </div>
                `;
                
                if (score.matchedSkills && score.matchedSkills.length > 0) {
                    html += `
                        <div style="margin-bottom: 16px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #28a745;">âœ“ ë³´ìœ  ìŠ¤í‚¬</h4>
                            <div class="skill-tags">
                                ${score.matchedSkills.map(s => `<span class="skill-tag" style="background: #d4edda; color: #155724;">${s}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (score.missingSkills && score.missingSkills.length > 0) {
                    html += `
                        <div>
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #dc3545;">âœ— ë¶€ì¡±í•œ ìŠ¤í‚¬</h4>
                            <div class="skill-tags">
                                ${score.missingSkills.map(s => `<span class="skill-tag" style="background: #f8d7da; color: #721c24;">${s}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                console.error('ë§¤ì¹­ ì ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function closeMatchingModal() {
            const modal = document.getElementById('matching-modal');
            modal.style.display = 'none';
        }
        
        document.getElementById('matching-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMatchingModal();
            }
        });
        
        window.addEventListener('load', loadApplications);
    </script>
</body>
</html>
