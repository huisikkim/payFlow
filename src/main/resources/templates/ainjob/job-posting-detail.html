<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ìš© ê³µê³  ìƒì„¸ - AINJOB</title>
    <link rel="stylesheet" th:href="@{/css/ainjob.css}">
    <style th:replace="~{fragments/navigation :: nav-style}"></style>
</head>
<body>
    <header>
        <nav th:replace="~{fragments/navigation :: nav}"></nav>
    </header>
    
    <div class="ainjob-container">
        <div class="detail-container">
            <div id="job-posting-detail">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ì±„ìš© ê³µê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì§€ì›í•˜ê¸° ëª¨ë‹¬ -->
    <div id="apply-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin: 0 0 24px 0; font-size: 24px; color: #212529;">ğŸ¯ ì±„ìš© ê³µê³  ì§€ì›</h2>
            
            <div class="form-group">
                <label class="form-label">ì§€ì›ì ì„ íƒ *</label>
                <select id="applicant-select" class="form-select" required>
                    <option value="">ì§€ì›ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div id="applicant-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #495057;">ì„ íƒí•œ ì§€ì›ì ì •ë³´</h4>
                <div id="applicant-info-content"></div>
            </div>
            
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-primary" onclick="submitApplication()">ì§€ì›í•˜ê¸°</button>
                <button class="btn-secondary" onclick="closeApplyModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- í•©ê²©ì ì¡°íšŒ ëª¨ë‹¬ -->
    <div id="qualified-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 1200px; width: 95%; max-height: 85vh; overflow-y: auto;">
            <h2 style="margin: 0 0 24px 0; font-size: 24px; color: #212529;">âœ… ìê²© ìš”ê±´ ì¶©ì¡± ì§€ì›ì</h2>
            
            <div id="qualified-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ì§€ì›ì ì •ë³´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-secondary" onclick="closeQualifiedModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <script th:replace="~{fragments/navigation :: nav-script}"></script>
    <script>
        const jobPostingId = window.location.pathname.split('/').pop();
        
        async function loadJobPostingDetail() {
            try {
                const response = await fetch(`/api/ainjob/job-postings/${jobPostingId}`);
                
                if (!response.ok) {
                    throw new Error('ì±„ìš© ê³µê³  ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const jp = await response.json();
                
                const statusBadge = getStatusBadge(jp.status);
                const openDate = jp.openDate ? new Date(jp.openDate).toLocaleDateString('ko-KR') : '-';
                const closeDate = jp.closeDate ? new Date(jp.closeDate).toLocaleDateString('ko-KR') : '-';
                
                let html = `
                    <div class="detail-header">
                        <div>
                            <h1 class="detail-title">${jp.title}</h1>
                            <p style="color: #6c757d; margin-top: 8px;">${jp.position} Â· íšŒì‚¬ ID: ${jp.companyId}</p>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">ê¸°ë³¸ ì •ë³´</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">í¬ì§€ì…˜</div>
                                <div class="detail-item-value">${jp.position}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">ìƒíƒœ</div>
                                <div class="detail-item-value">${jp.status}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">ì˜¤í”ˆì¼</div>
                                <div class="detail-item-value">${openDate}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">ë§ˆê°ì¼</div>
                                <div class="detail-item-value">${closeDate}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${jp.description ? `
                    <div class="detail-section">
                        <h3 class="detail-section-title">ìƒì„¸ ì„¤ëª…</h3>
                        <p style="line-height: 1.6; color: #495057;">${jp.description}</p>
                    </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">ìê²© ìš”ê±´</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">ìµœì†Œ í•™ë ¥</div>
                                <div class="detail-item-value">${jp.qualification.minEducationLevel}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">ìµœì†Œ ê²½ë ¥</div>
                                <div class="detail-item-value">${jp.qualification.minYearsOfExperience}ë…„</div>
                            </div>
                        </div>
                        ${jp.qualification.acceptedMajors && jp.qualification.acceptedMajors.length > 0 ? `
                        <div style="margin-top: 16px;">
                            <div class="detail-item-label" style="margin-bottom: 8px;">í—ˆìš© ì „ê³µ</div>
                            <div class="skill-tags">
                                ${jp.qualification.acceptedMajors.map(major => 
                                    `<span class="skill-tag">${major}</span>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="detail-section-title">ìš”êµ¬ ìŠ¤í‚¬</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>ìŠ¤í‚¬ëª…</th>
                                    <th>í•„ìˆ˜ ì—¬ë¶€</th>
                                    <th>ìµœì†Œ ìˆ™ë ¨ë„</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${jp.requiredSkills.map(skill => `
                                    <tr>
                                        <td><strong>${skill.skillName}</strong></td>
                                        <td>${skill.isRequired ? 
                                            '<span class="badge badge-final-pass">í•„ìˆ˜</span>' : 
                                            '<span class="badge badge-applied">ì„ íƒ</span>'}</td>
                                        <td>${skill.minProficiency || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="btn-group">
                        ${jp.status === 'OPEN' ? `
                            <button class="btn-primary" onclick="showApplyModal()">ğŸ¯ ì§€ì›í•˜ê¸°</button>
                            <button class="btn-primary" onclick="showQualifiedApplicants()" style="background: #28a745;">âœ… í•©ê²©ì ì¡°íšŒ</button>
                        ` : ''}
                        ${jp.status === 'DRAFT' ? `
                            <button class="btn-primary" onclick="openJobPosting()">ê³µê³  ì˜¤í”ˆ</button>
                        ` : ''}
                        ${jp.status === 'OPEN' ? `
                            <button class="btn-secondary" onclick="closeJobPosting()">ê³µê³  ë§ˆê°</button>
                        ` : ''}
                        <button class="btn-secondary" onclick="history.back()">ëª©ë¡ìœ¼ë¡œ</button>
                    </div>
                `;
                
                document.getElementById('job-posting-detail').innerHTML = html;
                
            } catch (error) {
                console.error('ì±„ìš© ê³µê³  ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('job-posting-detail').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function getStatusBadge(status) {
            const badges = {
                'DRAFT': '<span class="badge badge-draft">ì„ì‹œì €ì¥</span>',
                'OPEN': '<span class="badge badge-open">ê³µê°œ</span>',
                'CLOSED': '<span class="badge badge-closed">ë§ˆê°</span>'
            };
            return badges[status] || status;
        }
        
        async function openJobPosting() {
            if (!confirm('ì±„ìš© ê³µê³ ë¥¼ ì˜¤í”ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/ainjob/job-postings/${jobPostingId}/open`, {
                    method: 'PATCH'
                });
                
                if (!response.ok) {
                    throw new Error('ê³µê³  ì˜¤í”ˆ ì‹¤íŒ¨');
                }
                
                alert('ì±„ìš© ê³µê³ ê°€ ì˜¤í”ˆë˜ì—ˆìŠµë‹ˆë‹¤!');
                location.reload();
            } catch (error) {
                alert('ê³µê³  ì˜¤í”ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        async function closeJobPosting() {
            if (!confirm('ì±„ìš© ê³µê³ ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/ainjob/job-postings/${jobPostingId}/close`, {
                    method: 'PATCH'
                });
                
                if (!response.ok) {
                    throw new Error('ê³µê³  ë§ˆê° ì‹¤íŒ¨');
                }
                
                alert('ì±„ìš© ê³µê³ ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                location.reload();
            } catch (error) {
                alert('ê³µê³  ë§ˆê°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        let applicantsList = [];
        
        async function loadApplicants() {
            try {
                const response = await fetch('/api/ainjob/applicants');
                if (!response.ok) throw new Error('ì§€ì›ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                
                applicantsList = await response.json();
                
                const select = document.getElementById('applicant-select');
                applicantsList.forEach(applicant => {
                    const option = document.createElement('option');
                    option.value = applicant.id;
                    option.textContent = `${applicant.name} (${applicant.email})`;
                    select.appendChild(option);
                });
                
                // ì§€ì›ì ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ
                select.addEventListener('change', function() {
                    const applicantId = this.value;
                    if (applicantId) {
                        const applicant = applicantsList.find(a => a.id == applicantId);
                        showApplicantInfo(applicant);
                    } else {
                        document.getElementById('applicant-info').style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('ì§€ì›ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        function showApplicantInfo(applicant) {
            const infoDiv = document.getElementById('applicant-info');
            const contentDiv = document.getElementById('applicant-info-content');
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
                    <div>
                        <strong>ì´ë¦„:</strong> ${applicant.name}
                    </div>
                    <div>
                        <strong>ì´ë©”ì¼:</strong> ${applicant.email}
                    </div>
                    <div>
                        <strong>ì—°ë½ì²˜:</strong> ${applicant.phone}
                    </div>
                    <div>
                        <strong>ì´ ê²½ë ¥:</strong> ${applicant.totalYearsOfExperience || 0}ë…„
                    </div>
                </div>
            `;
            
            if (applicant.careers && applicant.careers.length > 0) {
                html += `
                    <div style="margin-top: 12px;">
                        <strong>ë³´ìœ  ìŠ¤í‚¬:</strong>
                        <div class="skill-tags" style="margin-top: 8px;">
                            ${applicant.careers.flatMap(c => c.skills || [])
                                .map(s => `<span class="skill-tag">${s.skillName} (Lv.${s.proficiencyLevel})</span>`)
                                .join('')}
                        </div>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = html;
            infoDiv.style.display = 'block';
        }
        
        function showApplyModal() {
            const modal = document.getElementById('apply-modal');
            modal.style.display = 'flex';
            
            // ì§€ì›ì ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¡œë“œ
            if (applicantsList.length === 0) {
                loadApplicants();
            }
        }
        
        function closeApplyModal() {
            const modal = document.getElementById('apply-modal');
            modal.style.display = 'none';
            document.getElementById('applicant-select').value = '';
            document.getElementById('applicant-info').style.display = 'none';
        }
        
        async function submitApplication() {
            const applicantId = document.getElementById('applicant-select').value;
            
            if (!applicantId) {
                alert('ì§€ì›ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!confirm('ì„ íƒí•œ ì§€ì›ìë¡œ ì´ ê³µê³ ì— ì§€ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/ainjob/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        applicantId: parseInt(applicantId),
                        jobPostingId: parseInt(jobPostingId),
                        resumeId: null
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ì§€ì› ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                alert('ì§€ì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeApplyModal();
                
                // ì§€ì› ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í• ì§€ ë¬¼ì–´ë³´ê¸°
                if (confirm('ì§€ì› ë‚´ì—­ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    location.href = '/ainjob/applications';
                }
                
            } catch (error) {
                console.error('ì§€ì› ì‹¤íŒ¨:', error);
                alert('ì§€ì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('apply-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeApplyModal();
            }
        });
        
        document.getElementById('qualified-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeQualifiedModal();
            }
        });
        
        // í•©ê²©ì ì¡°íšŒ
        async function showQualifiedApplicants() {
            const modal = document.getElementById('qualified-modal');
            modal.style.display = 'flex';
            
            const contentDiv = document.getElementById('qualified-content');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ì§€ì›ì ì •ë³´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/ainjob/job-postings/${jobPostingId}/qualified-applicants`);
                
                if (!response.ok) {
                    throw new Error('í•©ê²©ì ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                const applicants = await response.json();
                
                if (applicants.length === 0) {
                    contentDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div class="empty-state-title">ìê²© ìš”ê±´ì„ ì¶©ì¡±í•˜ëŠ” ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-desc">ì§€ì›ìê°€ ì—†ê±°ë‚˜ ëª¨ë“  ì§€ì›ìê°€ ìê²© ìš”ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                    return;
                }
                
                // í•©ê²©ìì™€ ë¶ˆí•©ê²©ì ë¶„ë¦¬
                const qualified = applicants.filter(a => a.isQualified);
                const notQualified = applicants.filter(a => !a.isQualified);
                
                let html = '';
                
                if (qualified.length > 0) {
                    html += `
                        <div style="margin-bottom: 32px;">
                            <h3 style="color: #28a745; margin-bottom: 16px;">âœ… ìê²© ìš”ê±´ ì¶©ì¡± (${qualified.length}ëª…)</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì§€ì›ìëª…</th>
                                        <th>í•™ë ¥</th>
                                        <th>ì „ê³µ</th>
                                        <th>ê²½ë ¥</th>
                                        <th>ë³´ìœ  ìŠ¤í‚¬</th>
                                        <th>ì ìˆ˜</th>
                                        <th>ë§¤ì¹­ ìƒì„¸</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    qualified.forEach(app => {
                        html += `
                            <tr>
                                <td><strong>${app.applicantName}</strong><br><small>${app.email}</small></td>
                                <td>${app.educationLevel}</td>
                                <td>${app.majorName || '-'}</td>
                                <td>${app.totalYearsOfExperience.toFixed(1)}ë…„</td>
                                <td>
                                    <div class="skill-tags">
                                        ${app.skills.slice(0, 3).map(s => `<span class="skill-tag">${s}</span>`).join('')}
                                        ${app.skills.length > 3 ? `<span class="skill-tag">+${app.skills.length - 3}</span>` : ''}
                                    </div>
                                </td>
                                <td><span class="badge badge-final-pass">${app.matchingScore}ì </span></td>
                                <td>
                                    <small style="color: #28a745;">
                                        ${app.educationMatched ? 'âœ“ í•™ë ¥ ' : ''}
                                        ${app.majorMatched ? 'âœ“ ì „ê³µ ' : ''}
                                        ${app.skillsMatched ? 'âœ“ ìŠ¤í‚¬ ' : ''}
                                        ${app.experienceMatched ? 'âœ“ ê²½ë ¥' : ''}
                                    </small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                if (notQualified.length > 0) {
                    html += `
                        <div>
                            <h3 style="color: #dc3545; margin-bottom: 16px;">âŒ ìê²© ìš”ê±´ ë¯¸ì¶©ì¡± (${notQualified.length}ëª…)</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì§€ì›ìëª…</th>
                                        <th>í•™ë ¥</th>
                                        <th>ì „ê³µ</th>
                                        <th>ê²½ë ¥</th>
                                        <th>ì ìˆ˜</th>
                                        <th>ë¯¸ì¶©ì¡± í•­ëª©</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    notQualified.forEach(app => {
                        const failedItems = [];
                        if (!app.educationMatched) failedItems.push('í•™ë ¥');
                        if (!app.majorMatched) failedItems.push('ì „ê³µ');
                        if (!app.skillsMatched) failedItems.push('ìŠ¤í‚¬');
                        if (!app.experienceMatched) failedItems.push('ê²½ë ¥');
                        
                        html += `
                            <tr>
                                <td><strong>${app.applicantName}</strong><br><small>${app.email}</small></td>
                                <td>${app.educationLevel}</td>
                                <td>${app.majorName || '-'}</td>
                                <td>${app.totalYearsOfExperience.toFixed(1)}ë…„</td>
                                <td><span class="badge badge-rejected">${app.matchingScore}ì </span></td>
                                <td><small style="color: #dc3545;">${failedItems.join(', ')}</small></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                console.error('í•©ê²©ì ì¡°íšŒ ì‹¤íŒ¨:', error);
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function closeQualifiedModal() {
            const modal = document.getElementById('qualified-modal');
            modal.style.display = 'none';
        }
        
        window.addEventListener('load', loadJobPostingDetail);
    </script>
</body>
</html>
