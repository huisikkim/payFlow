<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ìš© ê³µê³  ëª©ë¡ - AINJOB</title>
    <link rel="stylesheet" th:href="@{/css/ainjob.css}">
    <style th:replace="~{fragments/navigation :: nav-style}"></style>
</head>
<body>
    <header>
        <nav th:replace="~{fragments/navigation :: nav}"></nav>
    </header>
    
    <div class="ainjob-container">
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">ğŸ“‹ ì±„ìš© ê³µê³  ëª©ë¡</h2>
                <button class="btn-primary" onclick="location.href='/ainjob/job-postings/create'">
                    â• ê³µê³  ì‘ì„±
                </button>
            </div>
            
            <div id="job-posting-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ì±„ìš© ê³µê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script th:replace="~{fragments/navigation :: nav-script}"></script>
    <script>
        async function loadJobPostings() {
            try {
                const response = await fetch('/api/ainjob/job-postings');
                
                if (!response.ok) {
                    throw new Error('ì±„ìš© ê³µê³  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const jobPostings = await response.json();
                
                if (jobPostings.length === 0) {
                    document.getElementById('job-posting-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div class="empty-state-title">ë“±ë¡ëœ ì±„ìš© ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-desc">ìƒˆë¡œìš´ ì±„ìš© ê³µê³ ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”</div>
                        </div>
                    `;
                    return;
                }
                
                // ê° ê³µê³ ë³„ ì§€ì›ì ìˆ˜ ì¡°íšŒ
                const applicationCounts = await Promise.all(
                    jobPostings.map(jp => 
                        fetch(`/api/ainjob/applications/job-posting/${jp.id}`)
                            .then(res => res.ok ? res.json() : { content: [] })
                            .then(data => ({ id: jp.id, count: data.content?.length || 0 }))
                            .catch(() => ({ id: jp.id, count: 0 }))
                    )
                );
                
                const countMap = Object.fromEntries(applicationCounts.map(c => [c.id, c.count]));
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ì œëª©</th>
                                <th>í¬ì§€ì…˜</th>
                                <th>ìµœì†Œ í•™ë ¥</th>
                                <th>ìµœì†Œ ê²½ë ¥</th>
                                <th>ì§€ì›ì ìˆ˜</th>
                                <th>ìƒíƒœ</th>
                                <th>ë§ˆê°ì¼</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                jobPostings.forEach(jp => {
                    const statusBadge = getStatusBadge(jp.status);
                    const closeDate = jp.closeDate ? new Date(jp.closeDate).toLocaleDateString('ko-KR') : '-';
                    const applicationCount = countMap[jp.id] || 0;
                    const educationLevel = getEducationLevelText(jp.qualification.minEducationLevel);
                    
                    html += `
                        <tr onclick="location.href='/ainjob/job-postings/${jp.id}'" style="cursor: pointer;">
                            <td><strong>${jp.title}</strong></td>
                            <td>${jp.position}</td>
                            <td>${educationLevel}</td>
                            <td>${jp.qualification.minYearsOfExperience}ë…„</td>
                            <td><span class="badge badge-applied">${applicationCount}ëª…</span></td>
                            <td>${statusBadge}</td>
                            <td>${closeDate}</td>
                            <td>
                                <button class="btn-secondary" style="padding: 6px 12px; font-size: 13px;" 
                                        onclick="event.stopPropagation(); viewDetail(${jp.id})">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('job-posting-list').innerHTML = html;
                
            } catch (error) {
                console.error('ì±„ìš© ê³µê³  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('job-posting-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function getEducationLevelText(level) {
            const levels = {
                'HIGH_SCHOOL': 'ê³ ë“±í•™êµ',
                'ASSOCIATE': 'ì „ë¬¸í•™ì‚¬',
                'BACHELOR': 'í•™ì‚¬',
                'MASTER': 'ì„ì‚¬',
                'DOCTORATE': 'ë°•ì‚¬'
            };
            return levels[level] || level;
        }
        
        function getStatusBadge(status) {
            const badges = {
                'DRAFT': '<span class="badge badge-draft">ì„ì‹œì €ì¥</span>',
                'OPEN': '<span class="badge badge-open">ê³µê°œ</span>',
                'CLOSED': '<span class="badge badge-closed">ë§ˆê°</span>'
            };
            return badges[status] || status;
        }
        
        function viewDetail(id) {
            location.href = '/ainjob/job-postings/' + id;
        }
        
        window.addEventListener('load', loadJobPostings);
    </script>
</body>
</html>
