<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìµœì¢… í•©ê²©ì - AINJOB</title>
    <link rel="stylesheet" th:href="@{/css/ainjob.css}">
    <style th:replace="~{fragments/navigation :: nav-style}"></style>
</head>
<body>
    <header>
        <nav th:replace="~{fragments/navigation :: nav}"></nav>
    </header>
    
    <div class="ainjob-container">
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">âœ… ìµœì¢… í•©ê²©ì</h2>
                <button class="btn-secondary" onclick="history.back()">
                    â† ëŒì•„ê°€ê¸°
                </button>
            </div>
            
            <div id="qualified-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>í•©ê²©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script th:replace="~{fragments/navigation :: nav-script}"></script>
    <script>
        async function loadQualifiedApplicants() {
            try {
                const response = await fetch('/api/ainjob/applications');
                
                if (!response.ok) {
                    throw new Error('ì§€ì› ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const applications = await response.json();
                const qualified = applications.filter(app => app.status === 'FINAL_PASS');
                
                if (qualified.length === 0) {
                    document.getElementById('qualified-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div class="empty-state-title">ì•„ì§ ìµœì¢… í•©ê²©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-desc">ì§€ì›ìì˜ ìƒíƒœë¥¼ ìµœì¢…í•©ê²©ìœ¼ë¡œ ë³€ê²½í•´ë³´ì„¸ìš”</div>
                        </div>
                    `;
                    return;
                }
                
                // ì§€ì›ì ì •ë³´ì™€ ê³µê³  ì •ë³´ë¥¼ í•¨ê»˜ ê°€ì ¸ì˜¤ê¸°
                const applicantIds = [...new Set(qualified.map(app => app.applicantId))];
                const jobPostingIds = [...new Set(qualified.map(app => app.jobPostingId))];
                
                const [applicantsRes, jobPostingsRes] = await Promise.all([
                    fetch('/api/ainjob/applicants'),
                    fetch('/api/ainjob/job-postings')
                ]);
                
                const applicants = applicantsRes.ok ? await applicantsRes.json() : [];
                const jobPostings = jobPostingsRes.ok ? await jobPostingsRes.json() : [];
                
                const applicantMap = Object.fromEntries(applicants.map(a => [a.id, a]));
                const jobPostingMap = Object.fromEntries(jobPostings.map(jp => [jp.id, jp]));
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ì§€ì›ì</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <th>ì±„ìš© ê³µê³ </th>
                                <th>í¬ì§€ì…˜</th>
                                <th>í•©ê²©ì¼</th>
                                <th>ê²½ë ¥</th>
                                <th>ë³´ìœ  ìŠ¤í‚¬</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                qualified.forEach(app => {
                    const applicant = applicantMap[app.applicantId] || {};
                    const jobPosting = jobPostingMap[app.jobPostingId] || {};
                    const passDate = app.updatedAt ? new Date(app.updatedAt).toLocaleDateString('ko-KR') : '-';
                    
                    const skills = applicant.careers?.flatMap(c => c.skills || []) || [];
                    const uniqueSkills = [...new Set(skills.map(s => s.skillName))];
                    
                    html += `
                        <tr onclick="location.href='/ainjob/applicants/${app.applicantId}'" style="cursor: pointer;">
                            <td><strong>${applicant.name || 'ì§€ì›ì #' + app.applicantId}</strong></td>
                            <td>${applicant.email || '-'}</td>
                            <td>${applicant.phone || '-'}</td>
                            <td>${jobPosting.title || 'ê³µê³  #' + app.jobPostingId}</td>
                            <td>${jobPosting.position || '-'}</td>
                            <td>${passDate}</td>
                            <td>${applicant.totalYearsOfExperience?.toFixed(1) || 0}ë…„</td>
                            <td>
                                <div class="skill-tags">
                                    ${uniqueSkills.slice(0, 3).map(s => 
                                        `<span class="skill-tag">${s}</span>`
                                    ).join('')}
                                    ${uniqueSkills.length > 3 ? 
                                        `<span class="skill-tag">+${uniqueSkills.length - 3}</span>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: #d4edda; border-radius: 8px; color: #155724;">
                        <strong>ì´ ${qualified.length}ëª…</strong>ì˜ ìµœì¢… í•©ê²©ìê°€ ìˆìŠµë‹ˆë‹¤.
                    </div>
                `;
                
                document.getElementById('qualified-list').innerHTML = html;
                
            } catch (error) {
                console.error('í•©ê²©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('qualified-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
        
        window.addEventListener('load', loadQualifiedApplicants);
    </script>
</body>
</html>
