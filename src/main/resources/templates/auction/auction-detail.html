<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§¤ ìƒì„¸ - PickSwap</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .header { background: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .auction-detail { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .auction-image { width: 100%; height: 400px; background: #e0e0e0; border-radius: 12px; }
        .auction-info { background: white; padding: 30px; border-radius: 12px; }
        .auction-title { font-size: 24px; font-weight: 600; margin-bottom: 20px; }
        .price-section { background: #f8f8f8; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .current-price { font-size: 32px; font-weight: bold; color: #4CAF50; }
        .timer { font-size: 24px; color: #ff5722; font-weight: 600; margin: 15px 0; }
        .bid-form { margin: 20px 0; }
        .bid-form input { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .bid-form button { width: 100%; padding: 15px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn-bid { background: #4CAF50; color: white; }
        .btn-buy-now { background: #ff9800; color: white; margin-top: 10px; }
        .auto-bid-section { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .bid-history { background: white; padding: 30px; border-radius: 12px; margin-top: 20px; }
        .bid-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .bid-item:last-child { border-bottom: none; }
        .bid-winner { background: #e8f5e9; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .info-label { color: #666; }
        .info-value { font-weight: 600; }
    </style>
</head>
<body>
    <div class="header">
        <h1><a href="/pickswap/auctions" style="text-decoration: none; color: inherit;">â† ê²½ë§¤ ìƒì„¸</a></h1>
    </div>

    <div class="container">
        <div class="auction-detail">
            <div>
                <div class="auction-image" th:if="${product != null && product.imageUrls != null && !product.imageUrls.empty}">
                    <img th:src="${product.imageUrls[0]}" alt="ìƒí’ˆ ì´ë¯¸ì§€" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
                </div>
                <div class="auction-image" th:if="${product == null || product.imageUrls == null || product.imageUrls.empty}" 
                     style="display: flex; align-items: center; justify-content: center; color: #999;">
                    ì´ë¯¸ì§€ ì—†ìŒ
                </div>
            </div>
            
            <div class="auction-info">
                <h2 class="auction-title" th:text="${product != null ? product.title : 'ê²½ë§¤ #' + auction.id}">ê²½ë§¤ ì œëª©</h2>
                <p th:if="${product != null}" style="color: #666; margin-bottom: 20px;" th:text="${product.description}">ìƒí’ˆ ì„¤ëª…</p>
                
                <div class="price-section">
                    <div style="color: #666; margin-bottom: 5px;">í˜„ì¬ê°€</div>
                    <div class="current-price" th:text="${#numbers.formatInteger(auction.currentPrice, 0, 'COMMA')} + 'ì›'">100,000ì›</div>
                    <div class="timer" th:attr="data-end-time=${auction.endTime}">ê³„ì‚° ì¤‘...</div>
                    <div style="color: #666; font-size: 14px;">ì…ì°° <span th:text="${auction.bidCount}">0</span>íšŒ Â· ì¡°íšŒ <span th:text="${auction.viewCount}">0</span>íšŒ</div>
                </div>
                
                <div class="info-row">
                    <span class="info-label">ì‹œì‘ê°€</span>
                    <span class="info-value" th:text="${#numbers.formatInteger(auction.startPrice, 0, 'COMMA')} + 'ì›'">50,000ì›</span>
                </div>
                <div class="info-row" th:if="${auction.buyNowPrice != null}">
                    <span class="info-label">ì¦‰ì‹œ êµ¬ë§¤ê°€</span>
                    <span class="info-value" th:text="${#numbers.formatInteger(auction.buyNowPrice, 0, 'COMMA')} + 'ì›'">200,000ì›</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ìµœì†Œ ì…ì°° ë‹¨ìœ„</span>
                    <span class="info-value" th:text="${#numbers.formatInteger(auction.minBidIncrement, 0, 'COMMA')} + 'ì›'">1,000ì›</span>
                </div>
                
                <div th:if="${auction.status.name() == 'ACTIVE' && !isOwner}">
                    <form class="bid-form" onsubmit="placeBid(event)">
                        <input type="number" id="bidAmount" 
                               th:value="${auction.currentPrice + auction.minBidIncrement}"
                               th:min="${auction.currentPrice + auction.minBidIncrement}"
                               th:step="${auction.minBidIncrement}"
                               placeholder="ì…ì°° ê¸ˆì•¡" required>
                        <button type="submit" class="btn-bid">ì…ì°°í•˜ê¸°</button>
                    </form>
                    
                    <button class="btn-buy-now" th:if="${auction.buyNowPrice != null}" onclick="buyNow()">
                        ì¦‰ì‹œ êµ¬ë§¤ (<span th:text="${#numbers.formatInteger(auction.buyNowPrice, 0, 'COMMA')}">200,000</span>ì›)
                    </button>
                    
                    <div class="auto-bid-section">
                        <h3 style="margin-bottom: 10px;">ğŸ¤– ìë™ ì…ì°°</h3>
                        <input type="number" id="maxAmount" placeholder="ìµœëŒ€ ì…ì°° ê¸ˆì•¡" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <button onclick="setAutoBid()" style="width: 100%; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer;">ìë™ ì…ì°° ì„¤ì •</button>
                    </div>
                </div>
                
                <div th:if="${auction.status.name() == 'ENDED'}">
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center;">
                        <h3>ê²½ë§¤ ì¢…ë£Œ</h3>
                        <p th:if="${auction.winnerId != null}">
                            ë‚™ì°°ì: <span th:text="${auction.winnerId}">user</span><br>
                            ë‚™ì°°ê°€: <span th:text="${#numbers.formatInteger(auction.currentPrice, 0, 'COMMA')} + 'ì›'">100,000ì›</span>
                        </p>
                        <p th:if="${auction.winnerId == null}">ìœ ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bid-history">
            <h3 style="margin-bottom: 20px;">ì…ì°° ë‚´ì—­</h3>
            <div th:if="${!bids.empty}">
                <div class="bid-item" th:each="bid, iterStat : ${bids}" 
                     th:classappend="${bid.isWinning} ? 'bid-winner' : ''">
                    <div>
                        <div style="font-weight: 600;" th:text="${bid.bidderName}">ì…ì°°ì</div>
                        <div style="font-size: 14px; color: #666;" th:text="${#temporals.format(bid.bidTime, 'yyyy-MM-dd HH:mm:ss')}">2025-11-20 10:00:00</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: bold; color: #4CAF50;" th:text="${#numbers.formatInteger(bid.amount, 0, 'COMMA')} + 'ì›'">100,000ì›</div>
                        <div th:if="${bid.isWinning}" style="color: #4CAF50; font-size: 14px;">ğŸ† ìµœê³ ê°€</div>
                        <div th:if="${bid.isAutoBid}" style="color: #2196F3; font-size: 12px;">ğŸ¤– ìë™</div>
                    </div>
                </div>
            </div>
            <div th:if="${bids.empty}" style="text-align: center; color: #999; padding: 40px;">
                ì•„ì§ ì…ì°°ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const auctionId = /*[[${auction.id}]]*/ 0;
        
        function updateTimer() {
            const timer = document.querySelector('.timer');
            const endTime = new Date(timer.getAttribute('data-end-time'));
            const now = new Date();
            const diff = endTime - now;
            
            if (diff <= 0) {
                timer.textContent = 'ê²½ë§¤ ì¢…ë£Œ';
                timer.style.color = '#999';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (days > 0) {
                timer.textContent = `${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ`;
            } else if (hours > 0) {
                timer.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ ë‚¨ìŒ`;
            } else {
                timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        updateTimer();
        setInterval(updateTimer, 1000);
        
        function getAuthHeaders() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }
            return { 'Content-Type': 'application/json' };
        }
        
        async function placeBid(event) {
            event.preventDefault();
            const amount = document.getElementById('bidAmount').value;
            
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login?redirect=' + encodeURIComponent(location.pathname);
                return;
            }
            
            try {
                const response = await fetch(`/api/auctions/${auctionId}/bids`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ amount: parseFloat(amount) })
                });
                
                if (response.ok) {
                    alert('ì…ì°° ì„±ê³µ!');
                    location.reload();
                } else if (response.status === 401 || response.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    localStorage.removeItem('jwt_token');
                    location.href = '/login?redirect=' + encodeURIComponent(location.pathname);
                } else {
                    const error = await response.text();
                    alert('ì…ì°° ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                alert('ì…ì°° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function buyNow() {
            if (!confirm('ì¦‰ì‹œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login?redirect=' + encodeURIComponent(location.pathname);
                return;
            }
            
            try {
                const response = await fetch(`/api/auctions/${auctionId}/buy-now`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    alert('ì¦‰ì‹œ êµ¬ë§¤ ì„±ê³µ!');
                    location.reload();
                } else if (response.status === 401 || response.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    localStorage.removeItem('jwt_token');
                    location.href = '/login?redirect=' + encodeURIComponent(location.pathname);
                } else {
                    const error = await response.text();
                    alert('ì¦‰ì‹œ êµ¬ë§¤ ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                alert('ì¦‰ì‹œ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function setAutoBid() {
            const maxAmount = document.getElementById('maxAmount').value;
            if (!maxAmount) {
                alert('ìµœëŒ€ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login?redirect=' + encodeURIComponent(location.pathname);
                return;
            }
            
            try {
                const response = await fetch(`/api/auctions/${auctionId}/auto-bid`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ maxAmount: parseFloat(maxAmount) })
                });
                
                if (response.ok) {
                    alert('ìë™ ì…ì°° ì„¤ì • ì™„ë£Œ!');
                } else if (response.status === 401 || response.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    localStorage.removeItem('jwt_token');
                    location.href = '/login?redirect=' + encodeURIComponent(location.pathname);
                } else {
                    const error = await response.text();
                    alert('ìë™ ì…ì°° ì„¤ì • ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                alert('ìë™ ì…ì°° ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
