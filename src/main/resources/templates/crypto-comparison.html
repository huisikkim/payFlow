<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í±∞ÎûòÏÜå ÏãúÏÑ∏ ÎπÑÍµê - Ïã§ÏãúÍ∞Ñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }
        
        .reference-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .reference-selector label {
            font-weight: 600;
            color: #fff;
        }
        
        .reference-selector select {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reference-selector select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2a3555;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8b92b0;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #2a3555;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #8b92b0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
        }
        
        .tab:hover {
            color: #fff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .comparison-table {
            background: #1a1f3a;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #252b4a;
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #8b92b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid #2a3555;
            transition: all 0.3s;
        }
        
        tbody tr:hover {
            background: #252b4a;
        }
        
        td {
            padding: 16px;
            font-size: 14px;
        }
        
        .coin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .coin-symbol {
            font-weight: 700;
            color: #fff;
            font-size: 16px;
        }
        
        .coin-name {
            color: #8b92b0;
            font-size: 13px;
        }
        
        .price {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
        }
        
        .premium {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 14px;
        }
        
        .premium.positive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .premium.negative {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .premium.neutral {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .volume {
            color: #8b92b0;
        }
        
        .strength {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .strength-bar {
            width: 60px;
            height: 6px;
            background: #2a3555;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .strength-fill.buy {
            background: #ef4444;
        }
        
        .strength-fill.sell {
            background: #3b82f6;
        }
        
        .chart-container {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            height: 400px;
        }
        
        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 13px;
                white-space: nowrap;
            }
            
            .comparison-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .coin-symbol {
                font-size: 14px;
            }
            
            .coin-name {
                font-size: 11px;
            }
            
            .price {
                font-size: 14px;
            }
            
            .premium {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .chart-container {
                height: 300px;
                padding: 10px;
            }
            
            .search-box input {
                font-size: 16px; /* iOS Ï§å Î∞©ÏßÄ */
            }
            
            .reference-selector {
                width: 100%;
                justify-content: space-between;
            }
            
            .reference-selector select {
                flex: 1;
                max-width: 200px;
            }
        }
        
        /* ÏûëÏùÄ Î™®Î∞îÏùº (iPhone SE Îì±) */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 20px;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            .chart-container {
                height: 250px;
                padding: 8px;
            }
        }
        
        /* ÌÉúÎ∏îÎ¶ø */
        @media (min-width: 769px) and (max-width: 1024px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 350px;
            }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b92b0;
        }
        
        .spinner {
            border: 3px solid #2a3555;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #2a3555;
            background: #1a1f3a;
            color: #fff;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #4a9eff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Í±∞ÎûòÏÜå ÏãúÏÑ∏ ÎπÑÍµê</h1>
            <div class="reference-selector">
                <label>Í∏∞Ï§Ä Í±∞ÎûòÏÜå:</label>
                <select id="referenceExchange">
                    <option value="UPBIT" selected>ÏóÖÎπÑÌä∏</option>
                    <option value="BITHUMB">ÎπóÏç∏</option>
                </select>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Ï¥ù ÏΩîÏù∏ Ïàò</div>
                <div class="stat-value" id="totalCoins">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ÏµúÎåÄ ÌîÑÎ¶¨ÎØ∏ÏóÑ</div>
                <div class="stat-value" id="maxPremium">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ï∞®ÏùµÍ±∞Îûò Í∏∞Ìöå</div>
                <div class="stat-value" id="arbitrageCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ÌèâÍ∑† VWAP</div>
                <div class="stat-value" id="avgVwap">-</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="price">Í∞ÄÍ≤© ÎπÑÍµê</button>
            <button class="tab" data-tab="orderbook">Ìò∏Í∞Ä Ïä§ÌîÑÎ†àÎìú</button>
            <button class="tab" data-tab="volume">Í±∞ÎûòÎüâ & Ï≤¥Í≤∞Í∞ïÎèÑ</button>
            <button class="tab" data-tab="arbitrage">Ï∞®ÏùµÍ±∞Îûò Í∏∞Ìöå</button>
            <button class="tab" data-tab="chart">Ïã§ÏãúÍ∞Ñ Ï∞®Ìä∏</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ÏΩîÏù∏ Í≤ÄÏÉâ (Ïòà: ÎπÑÌä∏ÏΩîÏù∏, BTC)">
        </div>
        
        <!-- Í∞ÄÍ≤© ÎπÑÍµê ÌÉ≠ -->
        <div id="price-tab" class="tab-content active">
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ÏΩîÏù∏</th>
                            <th>Í∏∞Ï§ÄÍ∞Ä</th>
                            <th>ÏóÖÎπÑÌä∏</th>
                            <th>ÎπóÏç∏</th>
                            <th>VWAP</th>
                            <th>ÏµúÎåÄ ÌîÑÎ¶¨ÎØ∏ÏóÑ</th>
                            <th>Ïä§ÌîÑÎ†àÎìú</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="spinner"></div>
                                Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Ìò∏Í∞Ä Ïä§ÌîÑÎ†àÎìú ÌÉ≠ -->
        <div id="orderbook-tab" class="tab-content">
            <div class="alert info">
                <span>üìä</span>
                <span>Í±∞ÎûòÏÜåÎ≥Ñ ÏµúÏö∞ÏÑ† Îß§Ïàò/Îß§ÎèÑ Ìò∏Í∞ÄÏôÄ Ïä§ÌîÑÎ†àÎìúÎ•º ÎπÑÍµêÌï©ÎãàÎã§</span>
            </div>
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ÏΩîÏù∏</th>
                            <th>Í±∞ÎûòÏÜå</th>
                            <th>Îß§ÏàòÌò∏Í∞Ä</th>
                            <th>Îß§ÎèÑÌò∏Í∞Ä</th>
                            <th>Ïä§ÌîÑÎ†àÎìú</th>
                            <th>Ïä§ÌîÑÎ†àÎìú %</th>
                        </tr>
                    </thead>
                    <tbody id="orderbookTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Í±∞ÎûòÎüâ & Ï≤¥Í≤∞Í∞ïÎèÑ ÌÉ≠ -->
        <div id="volume-tab" class="tab-content">
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ÏΩîÏù∏</th>
                            <th>Í±∞ÎûòÏÜå</th>
                            <th>24h Í±∞ÎûòÎåÄÍ∏à</th>
                            <th>1Î∂Ñ Î≥ÄÌôîÏú®</th>
                            <th>5Î∂Ñ Î≥ÄÌôîÏú®</th>
                            <th>Ï≤¥Í≤∞Í∞ïÎèÑ</th>
                        </tr>
                    </thead>
                    <tbody id="volumeTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Ï∞®ÏùµÍ±∞Îûò Í∏∞Ìöå ÌÉ≠ -->
        <div id="arbitrage-tab" class="tab-content">
            <div class="alert info">
                <span>üí°</span>
                <span>ÌîÑÎ¶¨ÎØ∏ÏóÑ 1% Ïù¥ÏÉÅÏù∏ ÏΩîÏù∏Îßå ÌëúÏãúÎê©ÎãàÎã§</span>
            </div>
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ÏΩîÏù∏</th>
                            <th>Ï†ÄÎ†¥Ìïú Í±∞ÎûòÏÜå</th>
                            <th>ÎπÑÏãº Í±∞ÎûòÏÜå</th>
                            <th>Í∞ÄÍ≤© Ï∞®Ïù¥</th>
                            <th>ÌîÑÎ¶¨ÎØ∏ÏóÑ</th>
                            <th>ÏòàÏÉÅ ÏàòÏùµÎ•†</th>
                        </tr>
                    </thead>
                    <tbody id="arbitrageTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Ïã§ÏãúÍ∞Ñ Ï∞®Ìä∏ ÌÉ≠ -->
        <div id="chart-tab" class="tab-content">
            <div class="alert info">
                <span>üìà</span>
                <span>Í±∞ÎûòÏÜåÎ≥Ñ Í∞ÄÍ≤© Î≥ÄÎèôÏùÑ Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÎπÑÍµêÌï©ÎãàÎã§</span>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label style="color: #8b92b0;">ÏΩîÏù∏ ÏÑ†ÌÉù:</label>
                <select id="chartCoinSelect" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #2a3555; background: #1a1f3a; color: #fff; font-size: 14px; flex: 1; min-width: 200px; max-width: 300px;">
                    <option value="KRW-BTC">ÎπÑÌä∏ÏΩîÏù∏ (BTC)</option>
                    <option value="KRW-ETH">Ïù¥ÎçîÎ¶¨ÏõÄ (ETH)</option>
                    <option value="KRW-XRP">Î¶¨Ìîå (XRP)</option>
                    <option value="KRW-ADA">ÏóêÏù¥Îã§ (ADA)</option>
                    <option value="KRW-SOL">ÏÜîÎùºÎÇò (SOL)</option>
                    <option value="KRW-DOGE">ÎèÑÏßÄÏΩîÏù∏ (DOGE)</option>
                    <option value="KRW-AVAX">ÏïÑÎ∞úÎûÄÏ≤¥ (AVAX)</option>
                    <option value="KRW-MATIC">Ìè¥Î¶¨Í≥§ (MATIC)</option>
                </select>
                <div id="chartInfo" style="color: #8b92b0; font-size: 13px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <span>üìä <span id="chartDataPoints">0</span>Í∞ú Îç∞Ïù¥ÌÑ∞</span>
                    <span id="chartPremium"></span>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let currentReference = 'UPBIT';
        let allPremiums = [];
        let eventSource = null;
        let priceChart = null;
        let chartData = {
            labels: [],
            upbit: [],
            bithumb: [],
            vwap: []
        };
        
        // ÌÉ≠ Ï†ÑÌôò
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });
        
        // Í∏∞Ï§Ä Í±∞ÎûòÏÜå Î≥ÄÍ≤Ω
        document.getElementById('referenceExchange').addEventListener('change', (e) => {
            currentReference = e.target.value;
            connectEventSource();
        });
        
        // Í≤ÄÏÉâ
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterTable(searchTerm);
        });
        
        // EventSource Ïó∞Í≤∞
        function connectEventSource() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/crypto/comparison/premiums/stream?referenceExchange=${currentReference}`);
            
            eventSource.onmessage = (event) => {
                allPremiums = JSON.parse(event.data);
                updateUI(allPremiums);
            };
            
            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                setTimeout(connectEventSource, 5000);
            };
        }
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateUI(premiums) {
            updateStats(premiums);
            updatePriceTable(premiums);
            updateOrderbookTable(premiums);
            updateVolumeTable(premiums);
            updateArbitrageTable(premiums);
            updateChart(premiums);
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats(premiums) {
            document.getElementById('totalCoins').textContent = premiums.length;
            
            if (premiums.length > 0) {
                const maxPremium = Math.max(...premiums.map(p => Math.abs(p.maxPremium)));
                document.getElementById('maxPremium').textContent = maxPremium.toFixed(2) + '%';
                
                const arbitrageCount = premiums.filter(p => Math.abs(p.maxPremium) >= 1.0).length;
                document.getElementById('arbitrageCount').textContent = arbitrageCount;
                
                const avgVwap = premiums.reduce((sum, p) => sum + p.vwap, 0) / premiums.length;
                document.getElementById('avgVwap').textContent = formatPrice(avgVwap);
            }
        }
        
        // Í∞ÄÍ≤© ÎπÑÍµê ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updatePriceTable(premiums) {
            const tbody = document.getElementById('priceTableBody');
            tbody.innerHTML = premiums.map(premium => {
                const upbitPrice = premium.exchangePrices.UPBIT;
                const bithumbPrice = premium.exchangePrices.BITHUMB;
                
                return `
                    <tr>
                        <td>
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td class="price">${formatPrice(premium.referencePrice)}</td>
                        <td>
                            <div class="price">${formatPrice(upbitPrice.price)}</div>
                            <div class="premium ${getPremiumClass(upbitPrice.premium)}">
                                ${formatPremium(upbitPrice.premium)}
                            </div>
                        </td>
                        <td>
                            <div class="price">${formatPrice(bithumbPrice.price)}</div>
                            <div class="premium ${getPremiumClass(bithumbPrice.premium)}">
                                ${formatPremium(bithumbPrice.premium)}
                            </div>
                        </td>
                        <td class="price">${formatPrice(premium.vwap)}</td>
                        <td>
                            <div class="premium ${getPremiumClass(premium.maxPremium)}">
                                ${formatPremium(premium.maxPremium)}
                            </div>
                        </td>
                        <td class="volume">${formatPrice(Math.abs(upbitPrice.spread))}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Í±∞ÎûòÎüâ ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateVolumeTable(premiums) {
            const tbody = document.getElementById('volumeTableBody');
            const rows = [];
            
            premiums.forEach(premium => {
                const upbitPrice = premium.exchangePrices.UPBIT;
                const bithumbPrice = premium.exchangePrices.BITHUMB;
                
                rows.push(`
                    <tr>
                        <td rowspan="2">
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td>ÏóÖÎπÑÌä∏</td>
                        <td class="volume">${formatVolume(upbitPrice.volume24h)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="strength">
                                <span>-</span>
                                <div class="strength-bar">
                                    <div class="strength-fill buy" style="width: 50%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>ÎπóÏç∏</td>
                        <td class="volume">${formatVolume(bithumbPrice.volume24h)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="strength">
                                <span>-</span>
                                <div class="strength-bar">
                                    <div class="strength-fill sell" style="width: 50%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `);
            });
            
            tbody.innerHTML = rows.join('');
        }
        
        // Ï∞®ÏùµÍ±∞Îûò ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateArbitrageTable(premiums) {
            const opportunities = premiums.filter(p => Math.abs(p.maxPremium) >= 1.0);
            const tbody = document.getElementById('arbitrageTableBody');
            
            if (opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Ï∞®ÏùµÍ±∞Îûò Í∏∞ÌöåÍ∞Ä ÏóÜÏäµÎãàÎã§</td></tr>';
                return;
            }
            
            tbody.innerHTML = opportunities.map(premium => {
                const cheaper = premium.minPremiumExchange;
                const expensive = premium.maxPremiumExchange;
                const cheaperPrice = premium.exchangePrices[cheaper].price;
                const expensivePrice = premium.exchangePrices[expensive].price;
                const priceDiff = expensivePrice - cheaperPrice;
                
                return `
                    <tr>
                        <td>
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong>${cheaper === 'UPBIT' ? 'ÏóÖÎπÑÌä∏' : 'ÎπóÏç∏'}</strong><br>
                            <span class="price">${formatPrice(cheaperPrice)}</span>
                        </td>
                        <td>
                            <strong>${expensive === 'UPBIT' ? 'ÏóÖÎπÑÌä∏' : 'ÎπóÏç∏'}</strong><br>
                            <span class="price">${formatPrice(expensivePrice)}</span>
                        </td>
                        <td class="price">${formatPrice(priceDiff)}</td>
                        <td>
                            <div class="premium positive">
                                ${formatPremium(premium.maxPremium)}
                            </div>
                        </td>
                        <td>
                            <div class="premium positive">
                                ${(Math.abs(premium.maxPremium) - 0.5).toFixed(2)}%
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ÌÖåÏù¥Î∏î ÌïÑÌÑ∞ÎßÅ
        function filterTable(searchTerm) {
            const rows = document.querySelectorAll('#priceTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        function formatPrice(price) {
            return new Intl.NumberFormat('ko-KR').format(Math.round(price)) + 'Ïõê';
        }
        
        function formatVolume(volume) {
            if (volume >= 1000000000) {
                return (volume / 1000000000).toFixed(1) + 'Ïñµ';
            } else if (volume >= 100000000) {
                return (volume / 100000000).toFixed(1) + 'Ïñµ';
            } else {
                return (volume / 10000).toFixed(0) + 'Îßå';
            }
        }
        
        function formatPremium(premium) {
            const sign = premium >= 0 ? '+' : '';
            return sign + premium.toFixed(2) + '%';
        }
        
        function getPremiumClass(premium) {
            if (Math.abs(premium) < 0.1) return 'neutral';
            return premium > 0 ? 'positive' : 'negative';
        }
        
        // Ï¥àÍ∏∞ Ïó∞Í≤∞
        connectEventSource();
        
        // Ìò∏Í∞Ä Ïä§ÌîÑÎ†àÎìú ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateOrderbookTable(premiums) {
            const tbody = document.getElementById('orderbookTableBody');
            const rows = [];
            
            // ÏÉÅÏúÑ 5Í∞ú ÏΩîÏù∏Îßå ÌëúÏãú
            premiums.slice(0, 5).forEach(premium => {
                const upbitPrice = premium.exchangePrices.UPBIT;
                const bithumbPrice = premium.exchangePrices.BITHUMB;
                
                // Í∞ÑÎã®Ìïú Ïä§ÌîÑÎ†àÎìú Ï∂îÏ†ï (Ïã§Ï†úÎ°úÎäî Ìò∏Í∞Ä API Ìò∏Ï∂ú ÌïÑÏöî)
                const upbitSpread = upbitPrice.price * 0.0005; // 0.05% Ï∂îÏ†ï
                const bithumbSpread = bithumbPrice.price * 0.0005;
                
                rows.push(`
                    <tr>
                        <td rowspan="2">
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td>ÏóÖÎπÑÌä∏</td>
                        <td class="price">${formatPrice(upbitPrice.price * 0.9995)}</td>
                        <td class="price">${formatPrice(upbitPrice.price * 1.0005)}</td>
                        <td class="volume">${formatPrice(upbitSpread)}</td>
                        <td class="premium neutral">0.05%</td>
                    </tr>
                    <tr>
                        <td>ÎπóÏç∏</td>
                        <td class="price">${formatPrice(bithumbPrice.price * 0.9995)}</td>
                        <td class="price">${formatPrice(bithumbPrice.price * 1.0005)}</td>
                        <td class="volume">${formatPrice(bithumbSpread)}</td>
                        <td class="premium neutral">0.05%</td>
                    </tr>
                `);
            });
            
            tbody.innerHTML = rows.join('');
        }
        
        // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
        function initChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            priceChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'ÏóÖÎπÑÌä∏',
                            data: chartData.upbit,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.15)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#ef4444',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: 'ÎπóÏç∏',
                            data: chartData.bithumb,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.15)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#3b82f6',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: 'VWAP',
                            data: chartData.vwap,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [8, 4],
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointHoverBackgroundColor: '#10b981',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 300
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: window.innerWidth < 768 ? 'bottom' : 'top',
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    size: window.innerWidth < 768 ? 11 : 13,
                                    weight: '600'
                                },
                                padding: window.innerWidth < 768 ? 10 : 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: window.innerWidth < 768 ? 8 : 12
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(26, 31, 58, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#e0e0e0',
                            borderColor: '#4a9eff',
                            borderWidth: 1,
                            padding: window.innerWidth < 768 ? 8 : 12,
                            displayColors: true,
                            titleFont: {
                                size: window.innerWidth < 768 ? 11 : 13
                            },
                            bodyFont: {
                                size: window.innerWidth < 768 ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    const price = formatPrice(context.parsed.y);
                                    return context.dataset.label + ': ' + price;
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex < 2) {
                                        const premium = allPremiums.find(p => p.market === document.getElementById('chartCoinSelect')?.value);
                                        if (premium) {
                                            const exchange = context.datasetIndex === 0 ? 'UPBIT' : 'BITHUMB';
                                            const prem = premium.exchangePrices[exchange].premium;
                                            return 'ÌîÑÎ¶¨ÎØ∏ÏóÑ: ' + (prem >= 0 ? '+' : '') + prem.toFixed(2) + '%';
                                        }
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: { 
                                color: '#8b92b0',
                                font: {
                                    size: window.innerWidth < 768 ? 9 : 11
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: window.innerWidth < 768 ? 6 : 10
                            },
                            grid: { 
                                color: 'rgba(42, 53, 85, 0.5)',
                                drawBorder: false,
                                display: window.innerWidth >= 768
                            }
                        },
                        y: {
                            display: true,
                            ticks: { 
                                color: '#8b92b0',
                                font: {
                                    size: window.innerWidth < 768 ? 9 : 11
                                },
                                callback: function(value) {
                                    if (window.innerWidth < 768) {
                                        // Î™®Î∞îÏùº: Îçî ÏßßÏùÄ ÌëúÍ∏∞
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(0) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(0) + 'K';
                                        }
                                        return value;
                                    } else {
                                        // Îç∞Ïä§ÌÅ¨ÌÜ±: ÏùºÎ∞ò ÌëúÍ∏∞
                                        return new Intl.NumberFormat('ko-KR', {
                                            notation: 'compact',
                                            compactDisplay: 'short'
                                        }).format(value);
                                    }
                                }
                            },
                            grid: { 
                                color: 'rgba(42, 53, 85, 0.5)',
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }
        
        // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateChart(premiums) {
            // Ï∞®Ìä∏ ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏßÄ ÏïäÏùå
            const chartTab = document.getElementById('chart-tab');
            if (!chartTab || !chartTab.classList.contains('active')) {
                return;
            }
            
            if (!priceChart) {
                initChart();
            }
            
            if (!priceChart) return;
            
            const selectedCoin = document.getElementById('chartCoinSelect')?.value || 'KRW-BTC';
            const premium = premiums.find(p => p.market === selectedCoin);
            
            if (premium) {
                const now = new Date().toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                // ÏµúÎåÄ 60Í∞ú Îç∞Ïù¥ÌÑ∞ Ìè¨Ïù∏Ìä∏ Ïú†ÏßÄ (1Î∂Ñ)
                if (chartData.labels.length >= 60) {
                    chartData.labels.shift();
                    chartData.upbit.shift();
                    chartData.bithumb.shift();
                    chartData.vwap.shift();
                }
                
                chartData.labels.push(now);
                chartData.upbit.push(premium.exchangePrices.UPBIT.price);
                chartData.bithumb.push(premium.exchangePrices.BITHUMB.price);
                chartData.vwap.push(premium.vwap);
                
                priceChart.data.labels = chartData.labels;
                priceChart.data.datasets[0].data = chartData.upbit;
                priceChart.data.datasets[1].data = chartData.bithumb;
                priceChart.data.datasets[2].data = chartData.vwap;
                
                // Ï∞®Ìä∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                updateChartInfo(premium);
                
                // Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                priceChart.update('active');
            }
        }
        
        // Ï∞®Ìä∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateChartInfo(premium) {
            const dataPointsEl = document.getElementById('chartDataPoints');
            const premiumEl = document.getElementById('chartPremium');
            
            if (dataPointsEl) {
                dataPointsEl.textContent = chartData.labels.length;
            }
            
            if (premiumEl && premium) {
                const maxPremium = premium.maxPremium;
                const premiumClass = maxPremium > 0 ? 'üî¥' : maxPremium < 0 ? 'üîµ' : '‚ö™';
                const premiumText = (maxPremium >= 0 ? '+' : '') + maxPremium.toFixed(2) + '%';
                premiumEl.innerHTML = `${premiumClass} ÌîÑÎ¶¨ÎØ∏ÏóÑ: <strong style="color: ${maxPremium > 0 ? '#ef4444' : maxPremium < 0 ? '#3b82f6' : '#6b7280'}">${premiumText}</strong>`;
            }
        }
        
        // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function resetChartData() {
            chartData.labels = [];
            chartData.upbit = [];
            chartData.bithumb = [];
            chartData.vwap = [];
            
            if (priceChart) {
                priceChart.data.labels = chartData.labels;
                priceChart.data.datasets[0].data = chartData.upbit;
                priceChart.data.datasets[1].data = chartData.bithumb;
                priceChart.data.datasets[2].data = chartData.vwap;
                priceChart.update();
            }
        }
        
        // Ï∞®Ìä∏ ÏΩîÏù∏ ÏÑ†ÌÉù Î≥ÄÍ≤Ω
        document.addEventListener('DOMContentLoaded', () => {
            const chartSelect = document.getElementById('chartCoinSelect');
            if (chartSelect) {
                chartSelect.addEventListener('change', () => {
                    console.log('ÏΩîÏù∏ Î≥ÄÍ≤Ω:', chartSelect.value);
                    resetChartData();
                });
            }
            
            // ÌÉ≠ Ï†ÑÌôò Ïãú Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.dataset.tab === 'chart') {
                        setTimeout(() => {
                            if (!priceChart) {
                                initChart();
                            }
                        }, 100);
                    }
                });
            });
        });
        
        // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú Ïó∞Í≤∞ Ìï¥Ï†ú
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
