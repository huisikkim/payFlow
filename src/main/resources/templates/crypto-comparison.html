<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê±°ë˜ì†Œ ì‹œì„¸ ë¹„êµ - ì‹¤ì‹œê°„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }
        
        .reference-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .reference-selector label {
            font-weight: 600;
            color: #fff;
        }
        
        .reference-selector select {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reference-selector select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2a3555;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8b92b0;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #2a3555;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #8b92b0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
        }
        
        .tab:hover {
            color: #fff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .comparison-table {
            background: #1a1f3a;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #252b4a;
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #8b92b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid #2a3555;
            transition: all 0.3s;
        }
        
        tbody tr:hover {
            background: #252b4a;
        }
        
        td {
            padding: 16px;
            font-size: 14px;
        }
        
        .coin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .coin-symbol {
            font-weight: 700;
            color: #fff;
            font-size: 16px;
        }
        
        .coin-name {
            color: #8b92b0;
            font-size: 13px;
        }
        
        .price {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
        }
        
        .premium {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 14px;
        }
        
        .premium.positive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .premium.negative {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .premium.neutral {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .volume {
            color: #8b92b0;
        }
        
        .strength {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .strength-bar {
            width: 60px;
            height: 6px;
            background: #2a3555;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .strength-fill.buy {
            background: #ef4444;
        }
        
        .strength-fill.sell {
            background: #3b82f6;
        }
        
        .chart-container {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            height: 400px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b92b0;
        }
        
        .spinner {
            border: 3px solid #2a3555;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #2a3555;
            background: #1a1f3a;
            color: #fff;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #4a9eff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¥ ê±°ë˜ì†Œ ì‹œì„¸ ë¹„êµ</h1>
            <div class="reference-selector">
                <label>ê¸°ì¤€ ê±°ë˜ì†Œ:</label>
                <select id="referenceExchange">
                    <option value="UPBIT" selected>ì—…ë¹„íŠ¸</option>
                    <option value="BITHUMB">ë¹—ì¸</option>
                </select>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">ì´ ì½”ì¸ ìˆ˜</div>
                <div class="stat-value" id="totalCoins">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìµœëŒ€ í”„ë¦¬ë¯¸ì—„</div>
                <div class="stat-value" id="maxPremium">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì°¨ìµê±°ë˜ ê¸°íšŒ</div>
                <div class="stat-value" id="arbitrageCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">í‰ê·  VWAP</div>
                <div class="stat-value" id="avgVwap">-</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="price">ê°€ê²© ë¹„êµ</button>
            <button class="tab" data-tab="orderbook">í˜¸ê°€ ìŠ¤í”„ë ˆë“œ</button>
            <button class="tab" data-tab="volume">ê±°ë˜ëŸ‰ & ì²´ê²°ê°•ë„</button>
            <button class="tab" data-tab="arbitrage">ì°¨ìµê±°ë˜ ê¸°íšŒ</button>
            <button class="tab" data-tab="chart">ì‹¤ì‹œê°„ ì°¨íŠ¸</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ì½”ì¸ ê²€ìƒ‰ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, BTC)">
        </div>
        
        <!-- ê°€ê²© ë¹„êµ íƒ­ -->
        <div id="price-tab" class="tab-content active">
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì½”ì¸</th>
                            <th>ê¸°ì¤€ê°€</th>
                            <th>ì—…ë¹„íŠ¸</th>
                            <th>ë¹—ì¸</th>
                            <th>VWAP</th>
                            <th>ìµœëŒ€ í”„ë¦¬ë¯¸ì—„</th>
                            <th>ìŠ¤í”„ë ˆë“œ</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="spinner"></div>
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- í˜¸ê°€ ìŠ¤í”„ë ˆë“œ íƒ­ -->
        <div id="orderbook-tab" class="tab-content">
            <div class="alert info">
                <span>ğŸ“Š</span>
                <span>ê±°ë˜ì†Œë³„ ìµœìš°ì„  ë§¤ìˆ˜/ë§¤ë„ í˜¸ê°€ì™€ ìŠ¤í”„ë ˆë“œë¥¼ ë¹„êµí•©ë‹ˆë‹¤</span>
            </div>
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì½”ì¸</th>
                            <th>ê±°ë˜ì†Œ</th>
                            <th>ë§¤ìˆ˜í˜¸ê°€</th>
                            <th>ë§¤ë„í˜¸ê°€</th>
                            <th>ìŠ¤í”„ë ˆë“œ</th>
                            <th>ìŠ¤í”„ë ˆë“œ %</th>
                        </tr>
                    </thead>
                    <tbody id="orderbookTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ê±°ë˜ëŸ‰ & ì²´ê²°ê°•ë„ íƒ­ -->
        <div id="volume-tab" class="tab-content">
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì½”ì¸</th>
                            <th>ê±°ë˜ì†Œ</th>
                            <th>24h ê±°ë˜ëŒ€ê¸ˆ</th>
                            <th>1ë¶„ ë³€í™”ìœ¨</th>
                            <th>5ë¶„ ë³€í™”ìœ¨</th>
                            <th>ì²´ê²°ê°•ë„</th>
                        </tr>
                    </thead>
                    <tbody id="volumeTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ì°¨ìµê±°ë˜ ê¸°íšŒ íƒ­ -->
        <div id="arbitrage-tab" class="tab-content">
            <div class="alert info">
                <span>ğŸ’¡</span>
                <span>í”„ë¦¬ë¯¸ì—„ 1% ì´ìƒì¸ ì½”ì¸ë§Œ í‘œì‹œë©ë‹ˆë‹¤</span>
            </div>
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì½”ì¸</th>
                            <th>ì €ë ´í•œ ê±°ë˜ì†Œ</th>
                            <th>ë¹„ì‹¼ ê±°ë˜ì†Œ</th>
                            <th>ê°€ê²© ì°¨ì´</th>
                            <th>í”„ë¦¬ë¯¸ì—„</th>
                            <th>ì˜ˆìƒ ìˆ˜ìµë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="arbitrageTableBody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="spinner"></div>
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ì‹¤ì‹œê°„ ì°¨íŠ¸ íƒ­ -->
        <div id="chart-tab" class="tab-content">
            <div class="alert info">
                <span>ğŸ“ˆ</span>
                <span>ê±°ë˜ì†Œë³„ ê°€ê²© ë³€ë™ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¹„êµí•©ë‹ˆë‹¤</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #8b92b0; margin-right: 10px;">ì½”ì¸ ì„ íƒ:</label>
                <select id="chartCoinSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #2a3555; background: #1a1f3a; color: #fff; font-size: 14px;">
                    <option value="KRW-BTC">ë¹„íŠ¸ì½”ì¸ (BTC)</option>
                    <option value="KRW-ETH">ì´ë”ë¦¬ì›€ (ETH)</option>
                    <option value="KRW-XRP">ë¦¬í”Œ (XRP)</option>
                    <option value="KRW-ADA">ì—ì´ë‹¤ (ADA)</option>
                    <option value="KRW-SOL">ì†”ë¼ë‚˜ (SOL)</option>
                </select>
            </div>
            
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let currentReference = 'UPBIT';
        let allPremiums = [];
        let eventSource = null;
        let priceChart = null;
        let chartData = {
            labels: [],
            upbit: [],
            bithumb: [],
            vwap: []
        };
        
        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });
        
        // ê¸°ì¤€ ê±°ë˜ì†Œ ë³€ê²½
        document.getElementById('referenceExchange').addEventListener('change', (e) => {
            currentReference = e.target.value;
            connectEventSource();
        });
        
        // ê²€ìƒ‰
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterTable(searchTerm);
        });
        
        // EventSource ì—°ê²°
        function connectEventSource() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/crypto/comparison/premiums/stream?referenceExchange=${currentReference}`);
            
            eventSource.onmessage = (event) => {
                allPremiums = JSON.parse(event.data);
                updateUI(allPremiums);
            };
            
            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                setTimeout(connectEventSource, 5000);
            };
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI(premiums) {
            updateStats(premiums);
            updatePriceTable(premiums);
            updateOrderbookTable(premiums);
            updateVolumeTable(premiums);
            updateArbitrageTable(premiums);
            updateChart(premiums);
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(premiums) {
            document.getElementById('totalCoins').textContent = premiums.length;
            
            if (premiums.length > 0) {
                const maxPremium = Math.max(...premiums.map(p => Math.abs(p.maxPremium)));
                document.getElementById('maxPremium').textContent = maxPremium.toFixed(2) + '%';
                
                const arbitrageCount = premiums.filter(p => Math.abs(p.maxPremium) >= 1.0).length;
                document.getElementById('arbitrageCount').textContent = arbitrageCount;
                
                const avgVwap = premiums.reduce((sum, p) => sum + p.vwap, 0) / premiums.length;
                document.getElementById('avgVwap').textContent = formatPrice(avgVwap);
            }
        }
        
        // ê°€ê²© ë¹„êµ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updatePriceTable(premiums) {
            const tbody = document.getElementById('priceTableBody');
            tbody.innerHTML = premiums.map(premium => {
                const upbitPrice = premium.exchangePrices.UPBIT;
                const bithumbPrice = premium.exchangePrices.BITHUMB;
                
                return `
                    <tr>
                        <td>
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td class="price">${formatPrice(premium.referencePrice)}</td>
                        <td>
                            <div class="price">${formatPrice(upbitPrice.price)}</div>
                            <div class="premium ${getPremiumClass(upbitPrice.premium)}">
                                ${formatPremium(upbitPrice.premium)}
                            </div>
                        </td>
                        <td>
                            <div class="price">${formatPrice(bithumbPrice.price)}</div>
                            <div class="premium ${getPremiumClass(bithumbPrice.premium)}">
                                ${formatPremium(bithumbPrice.premium)}
                            </div>
                        </td>
                        <td class="price">${formatPrice(premium.vwap)}</td>
                        <td>
                            <div class="premium ${getPremiumClass(premium.maxPremium)}">
                                ${formatPremium(premium.maxPremium)}
                            </div>
                        </td>
                        <td class="volume">${formatPrice(Math.abs(upbitPrice.spread))}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ê±°ë˜ëŸ‰ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateVolumeTable(premiums) {
            const tbody = document.getElementById('volumeTableBody');
            const rows = [];
            
            premiums.forEach(premium => {
                const upbitPrice = premium.exchangePrices.UPBIT;
                const bithumbPrice = premium.exchangePrices.BITHUMB;
                
                rows.push(`
                    <tr>
                        <td rowspan="2">
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td>ì—…ë¹„íŠ¸</td>
                        <td class="volume">${formatVolume(upbitPrice.volume24h)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="strength">
                                <span>-</span>
                                <div class="strength-bar">
                                    <div class="strength-fill buy" style="width: 50%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>ë¹—ì¸</td>
                        <td class="volume">${formatVolume(bithumbPrice.volume24h)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <div class="strength">
                                <span>-</span>
                                <div class="strength-bar">
                                    <div class="strength-fill sell" style="width: 50%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `);
            });
            
            tbody.innerHTML = rows.join('');
        }
        
        // ì°¨ìµê±°ë˜ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateArbitrageTable(premiums) {
            const opportunities = premiums.filter(p => Math.abs(p.maxPremium) >= 1.0);
            const tbody = document.getElementById('arbitrageTableBody');
            
            if (opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">ì°¨ìµê±°ë˜ ê¸°íšŒê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = opportunities.map(premium => {
                const cheaper = premium.minPremiumExchange;
                const expensive = premium.maxPremiumExchange;
                const cheaperPrice = premium.exchangePrices[cheaper].price;
                const expensivePrice = premium.exchangePrices[expensive].price;
                const priceDiff = expensivePrice - cheaperPrice;
                
                return `
                    <tr>
                        <td>
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong>${cheaper === 'UPBIT' ? 'ì—…ë¹„íŠ¸' : 'ë¹—ì¸'}</strong><br>
                            <span class="price">${formatPrice(cheaperPrice)}</span>
                        </td>
                        <td>
                            <strong>${expensive === 'UPBIT' ? 'ì—…ë¹„íŠ¸' : 'ë¹—ì¸'}</strong><br>
                            <span class="price">${formatPrice(expensivePrice)}</span>
                        </td>
                        <td class="price">${formatPrice(priceDiff)}</td>
                        <td>
                            <div class="premium positive">
                                ${formatPremium(premium.maxPremium)}
                            </div>
                        </td>
                        <td>
                            <div class="premium positive">
                                ${(Math.abs(premium.maxPremium) - 0.5).toFixed(2)}%
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // í…Œì´ë¸” í•„í„°ë§
        function filterTable(searchTerm) {
            const rows = document.querySelectorAll('#priceTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function formatPrice(price) {
            return new Intl.NumberFormat('ko-KR').format(Math.round(price)) + 'ì›';
        }
        
        function formatVolume(volume) {
            if (volume >= 1000000000) {
                return (volume / 1000000000).toFixed(1) + 'ì–µ';
            } else if (volume >= 100000000) {
                return (volume / 100000000).toFixed(1) + 'ì–µ';
            } else {
                return (volume / 10000).toFixed(0) + 'ë§Œ';
            }
        }
        
        function formatPremium(premium) {
            const sign = premium >= 0 ? '+' : '';
            return sign + premium.toFixed(2) + '%';
        }
        
        function getPremiumClass(premium) {
            if (Math.abs(premium) < 0.1) return 'neutral';
            return premium > 0 ? 'positive' : 'negative';
        }
        
        // ì´ˆê¸° ì—°ê²°
        connectEventSource();
        
        // í˜¸ê°€ ìŠ¤í”„ë ˆë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateOrderbookTable(premiums) {
            const tbody = document.getElementById('orderbookTableBody');
            const rows = [];
            
            // ìƒìœ„ 5ê°œ ì½”ì¸ë§Œ í‘œì‹œ
            premiums.slice(0, 5).forEach(premium => {
                const upbitPrice = premium.exchangePrices.UPBIT;
                const bithumbPrice = premium.exchangePrices.BITHUMB;
                
                // ê°„ë‹¨í•œ ìŠ¤í”„ë ˆë“œ ì¶”ì • (ì‹¤ì œë¡œëŠ” í˜¸ê°€ API í˜¸ì¶œ í•„ìš”)
                const upbitSpread = upbitPrice.price * 0.0005; // 0.05% ì¶”ì •
                const bithumbSpread = bithumbPrice.price * 0.0005;
                
                rows.push(`
                    <tr>
                        <td rowspan="2">
                            <div class="coin-info">
                                <div>
                                    <div class="coin-symbol">${premium.market.split('-')[1]}</div>
                                    <div class="coin-name">${premium.koreanName}</div>
                                </div>
                            </div>
                        </td>
                        <td>ì—…ë¹„íŠ¸</td>
                        <td class="price">${formatPrice(upbitPrice.price * 0.9995)}</td>
                        <td class="price">${formatPrice(upbitPrice.price * 1.0005)}</td>
                        <td class="volume">${formatPrice(upbitSpread)}</td>
                        <td class="premium neutral">0.05%</td>
                    </tr>
                    <tr>
                        <td>ë¹—ì¸</td>
                        <td class="price">${formatPrice(bithumbPrice.price * 0.9995)}</td>
                        <td class="price">${formatPrice(bithumbPrice.price * 1.0005)}</td>
                        <td class="volume">${formatPrice(bithumbSpread)}</td>
                        <td class="premium neutral">0.05%</td>
                    </tr>
                `);
            });
            
            tbody.innerHTML = rows.join('');
        }
        
        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            priceChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'ì—…ë¹„íŠ¸',
                            data: chartData.upbit,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'ë¹—ì¸',
                            data: chartData.bithumb,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'VWAP',
                            data: chartData.vwap,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatPrice(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b92b0' },
                            grid: { color: '#2a3555' }
                        },
                        y: {
                            ticks: { 
                                color: '#8b92b0',
                                callback: function(value) {
                                    return new Intl.NumberFormat('ko-KR').format(value);
                                }
                            },
                            grid: { color: '#2a3555' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateChart(premiums) {
            // ì°¨íŠ¸ íƒ­ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
            const chartTab = document.getElementById('chart-tab');
            if (!chartTab || !chartTab.classList.contains('active')) {
                return;
            }
            
            if (!priceChart) {
                initChart();
            }
            
            if (!priceChart) return;
            
            const selectedCoin = document.getElementById('chartCoinSelect')?.value || 'KRW-BTC';
            const premium = premiums.find(p => p.market === selectedCoin);
            
            if (premium) {
                const now = new Date().toLocaleTimeString('ko-KR');
                
                // ìµœëŒ€ 30ê°œ ë°ì´í„° í¬ì¸íŠ¸ ìœ ì§€
                if (chartData.labels.length >= 30) {
                    chartData.labels.shift();
                    chartData.upbit.shift();
                    chartData.bithumb.shift();
                    chartData.vwap.shift();
                }
                
                chartData.labels.push(now);
                chartData.upbit.push(premium.exchangePrices.UPBIT.price);
                chartData.bithumb.push(premium.exchangePrices.BITHUMB.price);
                chartData.vwap.push(premium.vwap);
                
                priceChart.data.labels = chartData.labels;
                priceChart.data.datasets[0].data = chartData.upbit;
                priceChart.data.datasets[1].data = chartData.bithumb;
                priceChart.data.datasets[2].data = chartData.vwap;
                priceChart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì—…ë°ì´íŠ¸
            }
        }
        
        // ì°¨íŠ¸ ë°ì´í„° ì´ˆê¸°í™”
        function resetChartData() {
            chartData.labels = [];
            chartData.upbit = [];
            chartData.bithumb = [];
            chartData.vwap = [];
            
            if (priceChart) {
                priceChart.data.labels = chartData.labels;
                priceChart.data.datasets[0].data = chartData.upbit;
                priceChart.data.datasets[1].data = chartData.bithumb;
                priceChart.data.datasets[2].data = chartData.vwap;
                priceChart.update();
            }
        }
        
        // ì°¨íŠ¸ ì½”ì¸ ì„ íƒ ë³€ê²½
        document.addEventListener('DOMContentLoaded', () => {
            const chartSelect = document.getElementById('chartCoinSelect');
            if (chartSelect) {
                chartSelect.addEventListener('change', () => {
                    console.log('ì½”ì¸ ë³€ê²½:', chartSelect.value);
                    resetChartData();
                });
            }
            
            // íƒ­ ì „í™˜ ì‹œ ì°¨íŠ¸ ì´ˆê¸°í™”
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.dataset.tab === 'chart') {
                        setTimeout(() => {
                            if (!priceChart) {
                                initChart();
                            }
                        }, 100);
                    }
                });
            });
        });
        
        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
