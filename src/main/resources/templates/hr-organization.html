<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조직도 & 인사정보</title>
    <link rel="stylesheet" th:href="@{/css/hr-organization.css}">
</head>
<body>
    <header>
        <nav>
            <div class="logo">조직도 & 인사정보</div>
            <ul class="nav-links">
                <li><a href="/">홈</a></li>
                <li><a href="/hr/attendance">근태관리</a></li>
                <li><a href="/hr/organization">조직도</a></li>
            </ul>
        </nav>
    </header>
    
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">조직도 & 인사정보 관리</h1>
            <p class="page-description">회사의 조직 구조와 직원 정보를 확인하고 관리합니다</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('chart')">조직도</button>
            <button class="tab" onclick="switchTab('employees')">직원 목록</button>
            <button class="tab" id="admin-tab-btn" onclick="switchTab('manage')" style="display: none;">인사정보 관리 (관리자)</button>
        </div>
        
        <!-- 조직도 탭 -->
        <div id="chart-tab" class="tab-content active">
            <div class="org-chart">
                <div id="org-chart-container" class="loading">
                    <div class="loading-spinner"></div>
                    <p>조직도를 불러오는 중...</p>
                </div>
            </div>
        </div>
        
        <!-- 직원 목록 탭 -->
        <div id="employees-tab" class="tab-content">
            <div class="employee-grid" id="employee-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>직원 목록을 불러오는 중...</p>
                </div>
            </div>
        </div>
        
        <!-- 인사정보 관리 탭 (관리자) -->
        <div id="manage-tab" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- 부서 관리 -->
                <div class="card" style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <h2 style="margin-bottom: 24px; font-size: 20px; font-weight: 700;">부서 등록</h2>
                    <form id="dept-form" onsubmit="createDepartment(event)">
                        <div class="form-group">
                            <label>부서 코드</label>
                            <input type="text" name="code" required placeholder="예: DEV-BE">
                        </div>
                        <div class="form-group">
                            <label>부서명</label>
                            <input type="text" name="name" required placeholder="예: 백엔드팀">
                        </div>
                        <div class="form-group">
                            <label>상위 부서</label>
                            <select name="parentId" id="parent-dept-select">
                                <option value="">없음 (최상위 부서)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>설명</label>
                            <textarea name="description" placeholder="부서 설명"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">부서 등록</button>
                    </form>
                    
                    <h3 style="margin-top: 32px; margin-bottom: 16px; font-size: 16px; font-weight: 700;">등록된 부서 목록</h3>
                    <div id="dept-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <!-- 직원 관리 -->
                <div class="card" style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <h2 style="margin-bottom: 24px; font-size: 20px; font-weight: 700;">직원 등록</h2>
                    <form id="emp-form" onsubmit="createEmployee(event)">
                        <div class="form-group">
                            <label>사번</label>
                            <input type="text" name="employeeNumber" required placeholder="예: EMP001">
                        </div>
                        <div class="form-group">
                            <label>이름</label>
                            <input type="text" name="name" required placeholder="예: 홍길동">
                        </div>
                        <div class="form-group">
                            <label>이메일</label>
                            <input type="email" name="email" required placeholder="예: hong@company.com">
                        </div>
                        <div class="form-group">
                            <label>전화번호</label>
                            <input type="tel" name="phone" required placeholder="예: 010-1234-5678">
                        </div>
                        <div class="form-group">
                            <label>부서</label>
                            <select name="departmentId" id="emp-dept-select" required>
                                <option value="">부서 선택</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>직급</label>
                            <select name="position" required>
                                <option value="CEO">대표이사</option>
                                <option value="CTO">기술이사</option>
                                <option value="CFO">재무이사</option>
                                <option value="DIRECTOR">이사</option>
                                <option value="GENERAL_MANAGER">부장</option>
                                <option value="MANAGER">차장</option>
                                <option value="ASSISTANT_MANAGER">과장</option>
                                <option value="SENIOR">대리</option>
                                <option value="STAFF">사원</option>
                                <option value="INTERN">인턴</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>입사일</label>
                            <input type="date" name="joinDate" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">직원 등록</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 직원 상세/수정 모달 -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">직원 정보 수정</h2>
                <button class="btn-close" onclick="closeEmployeeModal()">×</button>
            </div>
            
            <div class="profile-section">
                <div id="profile-image-container"></div>
                <input type="file" id="profile-image-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <label for="profile-image-input" class="btn-upload">프로필 사진 변경</label>
            </div>
            
            <form id="employee-edit-form" onsubmit="updateEmployee(event)">
                <input type="hidden" id="edit-employee-id">
                
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" id="edit-name" required>
                </div>
                
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="edit-email" required>
                </div>
                
                <div class="form-group">
                    <label>전화번호</label>
                    <input type="tel" id="edit-phone" required>
                </div>
                
                <div class="form-group">
                    <label>주소</label>
                    <input type="text" id="edit-address">
                </div>
                
                <div class="form-group">
                    <label>생년월일</label>
                    <input type="date" id="edit-birthdate">
                </div>
                
                <div class="form-group">
                    <label>메모</label>
                    <textarea id="edit-notes" rows="3"></textarea>
                </div>
                
                <div class="btn-group-modal">
                    <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    
    <script>
        const API_BASE = '/api/hr';
        
        function getToken() {
            return localStorage.getItem('accessToken');
        }
        
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            };
        }
        
        // 탭 전환
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            
            if (tab === 'chart') {
                loadOrganizationChart();
            } else if (tab === 'employees') {
                loadEmployees();
            } else if (tab === 'manage') {
                loadDepartments();
            }
        }
        
        // 조직도 로드
        async function loadOrganizationChart() {
            try {
                const response = await fetch(API_BASE + '/organization/chart', {
                    headers: getHeaders()
                });
                
                if (!response.ok) throw new Error('조직도 조회 실패');
                
                const data = await response.json();
                const container = document.getElementById('org-chart-container');
                
                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">조직도 데이터가 없습니다.</p>';
                    return;
                }
                
                container.innerHTML = '';
                data.forEach(dept => {
                    container.appendChild(buildDepartmentNode(dept));
                });
            } catch (error) {
                console.error('조직도 로드 실패:', error);
                document.getElementById('org-chart-container').innerHTML = 
                    '<p style="text-align: center; color: #f44336;">조직도를 불러올 수 없습니다.</p>';
            }
        }
        
        // 부서 노드 생성
        function buildDepartmentNode(dept) {
            const node = document.createElement('div');
            node.className = 'org-node';
            
            const card = document.createElement('div');
            card.className = 'dept-card';
            
            card.innerHTML = `
                <div class="dept-header">
                    <div class="dept-name">${dept.name}</div>
                    <div class="dept-code">${dept.code}</div>
                </div>
                ${dept.description ? `<div class="dept-description">${dept.description}</div>` : ''}
                <div class="employee-list">
                    ${dept.employees.map(emp => `
                        <div class="employee-item">
                            <div class="employee-avatar">${emp.name.charAt(0)}</div>
                            <div class="employee-info">
                                <div class="employee-name">${emp.name}</div>
                                <div class="employee-position">${emp.positionName}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            node.appendChild(card);
            
            if (dept.children && dept.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'org-children';
                
                dept.children.forEach(child => {
                    childrenContainer.appendChild(buildDepartmentNode(child));
                });
                
                node.appendChild(childrenContainer);
            }
            
            return node;
        }
        
        // 직원 목록 로드
        async function loadEmployees() {
            try {
                const response = await fetch(API_BASE + '/employees', {
                    headers: getHeaders()
                });
                
                if (!response.ok) throw new Error('직원 목록 조회 실패');
                
                const data = await response.json();
                const grid = document.getElementById('employee-grid');
                
                if (data.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #999;">등록된 직원이 없습니다.</p>';
                    return;
                }
                
                grid.innerHTML = data.map(emp => `
                    <div class="employee-card" onclick="openEmployeeModal(${emp.id})" style="cursor: pointer;">
                        <div class="employee-card-header">
                            <div class="employee-card-avatar">${emp.name.charAt(0)}</div>
                            <div class="employee-card-info">
                                <h3>${emp.name}</h3>
                                <div class="employee-card-position">${emp.positionName}</div>
                            </div>
                        </div>
                        <div class="employee-card-details">
                            <div class="detail-row">
                                <span class="detail-label">사번:</span>
                                <span>${emp.employeeNumber}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">부서:</span>
                                <span>${emp.departmentName || '-'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">이메일:</span>
                                <span>${emp.email}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">전화번호:</span>
                                <span>${emp.phone}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">입사일:</span>
                                <span>${emp.joinDate}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">상태:</span>
                                <span class="status-badge ${emp.status === 'ACTIVE' ? 'active' : 'resigned'}">
                                    ${emp.status === 'ACTIVE' ? '재직' : '퇴사'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('직원 목록 로드 실패:', error);
                document.getElementById('employee-grid').innerHTML = 
                    '<p style="text-align: center; color: #f44336;">직원 목록을 불러올 수 없습니다.</p>';
            }
        }
        
        // 부서 목록 로드
        async function loadDepartments() {
            try {
                const response = await fetch(API_BASE + '/departments', {
                    headers: getHeaders()
                });
                
                if (!response.ok) throw new Error('부서 목록 조회 실패');
                
                const data = await response.json();
                
                // 부서 선택 옵션 업데이트
                const parentSelect = document.getElementById('parent-dept-select');
                const empDeptSelect = document.getElementById('emp-dept-select');
                
                parentSelect.innerHTML = '<option value="">없음 (최상위 부서)</option>';
                empDeptSelect.innerHTML = '<option value="">부서 선택</option>';
                
                data.forEach(dept => {
                    parentSelect.innerHTML += `<option value="${dept.id}">${dept.name} (${dept.code})</option>`;
                    empDeptSelect.innerHTML += `<option value="${dept.id}">${dept.name} (${dept.code})</option>`;
                });
                
                // 부서 목록 표시
                const deptList = document.getElementById('dept-list');
                deptList.innerHTML = data.map(dept => `
                    <div style="padding: 12px; border-bottom: 1px solid #e9ecef;">
                        <div style="font-weight: 600;">${dept.name}</div>
                        <div style="font-size: 13px; color: #6c757d;">${dept.code}${dept.parentName ? ' → ' + dept.parentName : ''}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('부서 목록 로드 실패:', error);
            }
        }
        
        // 부서 등록
        async function createDepartment(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                code: formData.get('code'),
                name: formData.get('name'),
                description: formData.get('description'),
                parentId: formData.get('parentId') || null
            };
            
            try {
                const response = await fetch(API_BASE + '/departments', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('부서 등록 실패');
                
                alert('부서가 등록되었습니다!');
                e.target.reset();
                loadDepartments();
                loadOrganizationChart();
            } catch (error) {
                alert(error.message);
            }
        }
        
        // 직원 등록
        async function createEmployee(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                employeeNumber: formData.get('employeeNumber'),
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                departmentId: parseInt(formData.get('departmentId')),
                position: formData.get('position'),
                joinDate: formData.get('joinDate')
            };
            
            try {
                const response = await fetch(API_BASE + '/employees', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('직원 등록 실패');
                
                alert('직원이 등록되었습니다!');
                e.target.reset();
                loadOrganizationChart();
                loadEmployees();
            } catch (error) {
                alert(error.message);
            }
        }
        
        // 관리자 권한 확인
        async function checkAdminRole() {
            try {
                const response = await fetch(API_BASE + '/departments', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({code: 'TEST', name: 'TEST'})
                });
                
                // 403이 아니면 관리자
                if (response.status !== 403) {
                    document.getElementById('admin-tab-btn').style.display = 'block';
                }
            } catch (error) {
                console.log('관리자 권한 없음');
            }
        }
        
        // 직원 모달 열기
        async function openEmployeeModal(employeeId) {
            try {
                const response = await fetch(API_BASE + `/employees/${employeeId}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) throw new Error('직원 정보 조회 실패');
                
                const emp = await response.json();
                
                // 폼에 데이터 채우기
                document.getElementById('edit-employee-id').value = emp.id;
                document.getElementById('edit-name').value = emp.name;
                document.getElementById('edit-email').value = emp.email;
                document.getElementById('edit-phone').value = emp.phone;
                document.getElementById('edit-address').value = emp.address || '';
                document.getElementById('edit-birthdate').value = emp.birthDate || '';
                document.getElementById('edit-notes').value = emp.notes || '';
                
                // 프로필 이미지 표시
                const imageContainer = document.getElementById('profile-image-container');
                if (emp.profileImageUrl) {
                    imageContainer.innerHTML = `<img src="${emp.profileImageUrl}" class="profile-image-large" alt="${emp.name}">`;
                } else {
                    imageContainer.innerHTML = `<div class="profile-placeholder">${emp.name.charAt(0)}</div>`;
                }
                
                // 모달 열기
                document.getElementById('employee-modal').classList.add('active');
            } catch (error) {
                alert('직원 정보를 불러올 수 없습니다.');
            }
        }
        
        // 직원 모달 닫기
        function closeEmployeeModal() {
            document.getElementById('employee-modal').classList.remove('active');
        }
        
        // 직원 정보 수정
        async function updateEmployee(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('edit-employee-id').value;
            const data = {
                name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                address: document.getElementById('edit-address').value,
                birthDate: document.getElementById('edit-birthdate').value || null,
                notes: document.getElementById('edit-notes').value
            };
            
            try {
                const response = await fetch(API_BASE + `/employees/${employeeId}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('직원 정보 수정 실패');
                
                alert('직원 정보가 수정되었습니다!');
                closeEmployeeModal();
                loadEmployees();
                loadOrganizationChart();
            } catch (error) {
                alert(error.message);
            }
        }
        
        // 프로필 이미지 업로드
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 이미지 미리보기
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageContainer = document.getElementById('profile-image-container');
                imageContainer.innerHTML = `<img src="${e.target.result}" class="profile-image-large" alt="Profile">`;
                
                // 실제로는 서버에 업로드해야 하지만, 여기서는 Base64로 저장
                // TODO: 실제 파일 업로드 API 구현
                alert('프로필 사진이 변경되었습니다. (미리보기만 적용됨)');
            };
            reader.readAsDataURL(file);
        }
        
        // 모달 외부 클릭 시 닫기
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('employee-modal');
            if (e.target === modal) {
                closeEmployeeModal();
            }
        });
        
        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            const token = getToken();
            if (!token) {
                alert('로그인이 필요합니다.');
                location.href = '/';
                return;
            }
            
            loadOrganizationChart();
            checkAdminRole();
        });
    </script>
</body>
</html>
