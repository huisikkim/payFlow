<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ê°€ í•™ìŠµ & ê¸‰ë“± ê²½ê³  - PayFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .alert-card {
            border-left: 4px solid;
            margin-bottom: 1rem;
        }
        .alert-moderate { border-left-color: #ffc107; }
        .alert-high { border-left-color: #ff9800; }
        .alert-extreme { border-left-color: #f44336; }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .price-badge {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .volatility-low { color: #4caf50; }
        .volatility-medium { color: #ff9800; }
        .volatility-high { color: #f44336; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ğŸ’° PayFlow</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/ingredient/orders">ë°œì£¼ ê´€ë¦¬</a>
                <a class="nav-link active" href="/ingredient/price-learning">ë‹¨ê°€ í•™ìŠµ</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>ğŸ“Š ë‹¨ê°€ ìë™ í•™ìŠµ & ê¸‰ë“± ê²½ê³  ì‹œìŠ¤í…œ</h2>
        <p class="text-muted">ì‹ìì¬ ë‹¨ê°€ë¥¼ ìë™ìœ¼ë¡œ í•™ìŠµí•˜ê³  ê¸‰ë“± ì‹œ ì‹¤ì‹œê°„ ê²½ê³ ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>

        <!-- íƒ­ ë©”ë‰´ -->
        <ul class="nav nav-tabs mt-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#alerts">ğŸš¨ ê¸‰ë“± ê²½ê³ </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#statistics">ğŸ“ˆ ë‹¨ê°€ í†µê³„</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#history">ğŸ“‹ ë‹¨ê°€ ì´ë ¥</a>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- ê¸‰ë“± ê²½ê³  íƒ­ -->
            <div id="alerts" class="tab-pane fade show active">
                <div class="row">
                    <div class="col-md-12">
                        <h4>í™œì„± ê²½ê³ </h4>
                        <div id="activeAlerts"></div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h4>ìµœê·¼ ê²½ê³  ë‚´ì—­</h4>
                        <div id="recentAlerts"></div>
                    </div>
                </div>
            </div>

            <!-- ë‹¨ê°€ í†µê³„ íƒ­ -->
            <div id="statistics" class="tab-pane fade">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>í’ˆëª© ì„ íƒ</label>
                        <select id="itemSelect" class="form-select">
                            <option value="">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>ê¸°ê°„</label>
                        <select id="periodSelect" class="form-select">
                            <option value="7">ìµœê·¼ 7ì¼</option>
                            <option value="30" selected>ìµœê·¼ 30ì¼</option>
                            <option value="90">ìµœê·¼ 90ì¼</option>
                        </select>
                    </div>
                </div>
                
                <div id="statisticsContent"></div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ë‹¨ê°€ ì´ë ¥ íƒ­ -->
            <div id="history" class="tab-pane fade">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>í’ˆëª© ì„ íƒ</label>
                        <select id="historyItemSelect" class="form-select">
                            <option value="">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>ê¸°ê°„</label>
                        <select id="historyPeriodSelect" class="form-select">
                            <option value="7">ìµœê·¼ 7ì¼</option>
                            <option value="30" selected>ìµœê·¼ 30ì¼</option>
                            <option value="90">ìµœê·¼ 90ì¼</option>
                        </select>
                    </div>
                </div>
                
                <div id="historyContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let priceChart = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveAlerts();
            loadRecentAlerts();
            loadItems();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('itemSelect').addEventListener('change', loadStatistics);
            document.getElementById('periodSelect').addEventListener('change', loadStatistics);
            document.getElementById('historyItemSelect').addEventListener('change', loadHistory);
            document.getElementById('historyPeriodSelect').addEventListener('change', loadHistory);
        });

        // í™œì„± ê²½ê³  ë¡œë“œ
        async function loadActiveAlerts() {
            try {
                const response = await fetch('/api/price-learning/alerts/active');
                const alerts = await response.json();
                
                const container = document.getElementById('activeAlerts');
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="alert alert-success">âœ… í˜„ì¬ í™œì„± ê²½ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                container.innerHTML = alerts.map(alert => `
                    <div class="card alert-card alert-${alert.alertType.toLowerCase().replace('_surge', '')}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${alert.itemName}</h5>
                                    <p class="card-text">${alert.message}</p>
                                    <small class="text-muted">
                                        ë°œì£¼ ID: ${alert.orderId} | 
                                        ìœ í†µì‚¬: ${alert.distributorId} | 
                                        ${new Date(alert.createdAt).toLocaleString('ko-KR')}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-danger">${alert.surgePercentage.toFixed(1)}% ê¸‰ë“±</span>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-warning" onclick="acknowledgeAlert('${alert.alertId}')">í™•ì¸</button>
                                        <button class="btn btn-sm btn-success" onclick="resolveAlert('${alert.alertId}')">í•´ê²°</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('í™œì„± ê²½ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìµœê·¼ ê²½ê³  ë¡œë“œ
        async function loadRecentAlerts() {
            try {
                const response = await fetch('/api/price-learning/alerts/recent');
                const alerts = await response.json();
                
                const container = document.getElementById('recentAlerts');
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">ê²½ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>í’ˆëª©</th>
                                <th>ê¸‰ë“±ë¥ </th>
                                <th>í‰ê·  ë‹¨ê°€</th>
                                <th>í˜„ì¬ ë‹¨ê°€</th>
                                <th>ìƒíƒœ</th>
                                <th>ë°œìƒ ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${alerts.map(alert => `
                                <tr>
                                    <td>${alert.itemName}</td>
                                    <td><span class="badge bg-danger">${alert.surgePercentage.toFixed(1)}%</span></td>
                                    <td>${alert.averagePrice.toLocaleString()}ì›</td>
                                    <td>${alert.currentPrice.toLocaleString()}ì›</td>
                                    <td><span class="badge bg-${getStatusColor(alert.status)}">${getStatusText(alert.status)}</span></td>
                                    <td>${new Date(alert.createdAt).toLocaleString('ko-KR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('ìµœê·¼ ê²½ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í’ˆëª© ëª©ë¡ ë¡œë“œ
        async function loadItems() {
            try {
                const response = await fetch('/api/price-learning/items');
                const items = await response.json();
                
                const itemSelect = document.getElementById('itemSelect');
                const historyItemSelect = document.getElementById('historyItemSelect');
                
                items.forEach(item => {
                    itemSelect.add(new Option(item, item));
                    historyItemSelect.add(new Option(item, item));
                });
            } catch (error) {
                console.error('í’ˆëª© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‹¨ê°€ í†µê³„ ë¡œë“œ
        async function loadStatistics() {
            const itemName = document.getElementById('itemSelect').value;
            const days = document.getElementById('periodSelect').value;
            
            if (!itemName) return;
            
            try {
                const response = await fetch(`/api/price-learning/items/${encodeURIComponent(itemName)}/statistics?days=${days}`);
                const stats = await response.json();
                
                const container = document.getElementById('statisticsContent');
                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6>í‰ê·  ë‹¨ê°€</h6>
                                <div class="price-badge">${stats.averagePrice.toLocaleString()}ì›</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6>ì¶”ì²œ ë‹¨ê°€</h6>
                                <div class="price-badge">${stats.recommendedPrice.toLocaleString()}ì›</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6>ìµœê·¼ ë‹¨ê°€</h6>
                                <div class="price-badge">${stats.recentPrice.toLocaleString()}ì›</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6>ë³€ë™ì„±</h6>
                                <div class="price-badge volatility-${stats.volatilityLevel.toLowerCase()}">
                                    ${stats.volatility.toFixed(1)}%
                                </div>
                                <small>${stats.volatilityLevel}</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <p><strong>ìµœì €ê°€:</strong> ${stats.minPrice.toLocaleString()}ì›</p>
                                    <p><strong>ìµœê³ ê°€:</strong> ${stats.maxPrice.toLocaleString()}ì›</p>
                                    <p><strong>ë°ì´í„° í¬ì¸íŠ¸:</strong> ${stats.dataPoints}ê°œ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                await drawPriceChart(itemName, days);
                
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‹¨ê°€ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        async function drawPriceChart(itemName, days) {
            try {
                const response = await fetch(`/api/price-learning/items/${encodeURIComponent(itemName)}/history?days=${days}`);
                const history = await response.json();
                
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                if (priceChart) {
                    priceChart.destroy();
                }
                
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => new Date(h.recordedAt).toLocaleDateString('ko-KR')).reverse(),
                        datasets: [{
                            label: 'ë‹¨ê°€ ì¶”ì´',
                            data: history.map(h => h.unitPrice).reverse(),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${itemName} ë‹¨ê°€ ì¶”ì´`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + 'ì›';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì‹¤íŒ¨:', error);
            }
        }

        // ë‹¨ê°€ ì´ë ¥ ë¡œë“œ
        async function loadHistory() {
            const itemName = document.getElementById('historyItemSelect').value;
            const days = document.getElementById('historyPeriodSelect').value;
            
            if (!itemName) return;
            
            try {
                const response = await fetch(`/api/price-learning/items/${encodeURIComponent(itemName)}/history?days=${days}`);
                const history = await response.json();
                
                const container = document.getElementById('historyContent');
                if (history.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>í’ˆëª©</th>
                                <th>ë‹¨ê°€</th>
                                <th>ë‹¨ìœ„</th>
                                <th>ë°œì£¼ ID</th>
                                <th>ìœ í†µì‚¬</th>
                                <th>ë§¤ì¥</th>
                                <th>ê¸°ë¡ ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(h => `
                                <tr>
                                    <td>${h.itemName}</td>
                                    <td>${h.unitPrice.toLocaleString()}ì›</td>
                                    <td>${h.unit}</td>
                                    <td>${h.orderId}</td>
                                    <td>${h.distributorId}</td>
                                    <td>${h.storeId}</td>
                                    <td>${new Date(h.recordedAt).toLocaleString('ko-KR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê²½ê³  í™•ì¸
        async function acknowledgeAlert(alertId) {
            try {
                await fetch(`/api/price-learning/alerts/${alertId}/acknowledge`, { method: 'POST' });
                alert('ê²½ê³ ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.');
                loadActiveAlerts();
                loadRecentAlerts();
            } catch (error) {
                console.error('ê²½ê³  í™•ì¸ ì‹¤íŒ¨:', error);
                alert('ê²½ê³  í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²½ê³  í•´ê²°
        async function resolveAlert(alertId) {
            try {
                await fetch(`/api/price-learning/alerts/${alertId}/resolve`, { method: 'POST' });
                alert('ê²½ê³ ë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.');
                loadActiveAlerts();
                loadRecentAlerts();
            } catch (error) {
                console.error('ê²½ê³  í•´ê²° ì‹¤íŒ¨:', error);
                alert('ê²½ê³  í•´ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒíƒœ ìƒ‰ìƒ
        function getStatusColor(status) {
            switch(status) {
                case 'ACTIVE': return 'danger';
                case 'ACKNOWLEDGED': return 'warning';
                case 'RESOLVED': return 'success';
                default: return 'secondary';
            }
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸
        function getStatusText(status) {
            switch(status) {
                case 'ACTIVE': return 'í™œì„±';
                case 'ACKNOWLEDGED': return 'í™•ì¸ë¨';
                case 'RESOLVED': return 'í•´ê²°ë¨';
                default: return status;
            }
        }
    </script>
</body>
</html>
