<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì§€ì› í˜„í™©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        header h1 { font-size: 32px; margin-bottom: 10px; }
        
        .nav { display: flex; gap: 15px; margin-bottom: 20px; }
        .nav a { padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 5px; transition: all 0.3s; }
        .nav a:hover, .nav a.active { background: #667eea; color: white; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 32px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 5px; }
        
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; }
        .filters select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        
        .application-list { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .application-card { padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .application-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        
        .app-info h3 { margin-bottom: 5px; }
        .app-info p { color: #666; font-size: 14px; }
        
        .app-score { text-align: right; }
        .score { font-size: 32px; font-weight: bold; color: #667eea; }
        .score-bar { width: 200px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .score-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); }
        
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-APPLIED { background: #e3f2fd; color: #1976d2; }
        .status-SCREENING { background: #fff3e0; color: #f57c00; }
        .status-SCREENING_PASSED { background: #e8f5e9; color: #388e3c; }
        .status-OFFER { background: #f3e5f5; color: #7b1fa2; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ì§€ì› í˜„í™©</h1>
            <p>ì˜¨í†¨ë¡œì§€ ê¸°ë°˜ ë§¤ì¹­ ìŠ¤ì½”ì–´ë¡œ ìµœì ì˜ ì¸ì¬ë¥¼ ì„ ë³„í•˜ì„¸ìš”</p>
        </header>
        
        <div class="nav">
            <a href="/recruitment/dashboard">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/recruitment/jobs">ì±„ìš© ê³µê³ </a>
            <a href="/recruitment/candidates">ì§€ì›ì</a>
            <a href="/recruitment/applications" class="active">ì§€ì› í˜„í™©</a>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">ì „ì²´ ì§€ì›</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgScore">-</div>
                <div class="stat-label">í‰ê·  ë§¤ì¹­ ìŠ¤ì½”ì–´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highScoreCount">-</div>
                <div class="stat-label">ê³ ë“ì  (90ì  ì´ìƒ)</div>
            </div>
        </div>
        
        <div class="filters">
            <select id="jobFilter">
                <option value="">ì „ì²´ ê³µê³ </option>
            </select>
            <select id="statusFilter">
                <option value="">ì „ì²´ ìƒíƒœ</option>
                <option value="APPLIED">ì§€ì› ì™„ë£Œ</option>
                <option value="SCREENING">ì„œë¥˜ ì‹¬ì‚¬ ì¤‘</option>
                <option value="SCREENING_PASSED">ì„œë¥˜ í•©ê²©</option>
                <option value="INTERVIEW_SCHEDULED">ë©´ì ‘ ì˜ˆì •</option>
                <option value="OFFER">ìµœì¢… í•©ê²©</option>
            </select>
            <select id="sortFilter">
                <option value="score">ë§¤ì¹­ ìŠ¤ì½”ì–´ ìˆœ</option>
                <option value="date">ì§€ì›ì¼ ìˆœ</option>
            </select>
        </div>
        
        <div class="application-list">
            <h2 style="margin-bottom: 20px;">ì§€ì› ëª©ë¡</h2>
            <div id="applicationList" class="loading">ë¡œë”© ì¤‘...</div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/recruitment';
        let token = localStorage.getItem('jwt_token');
        let allApplications = [];
        let allJobs = [];
        
        async function fetchWithAuth(url) {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
            return response.json();
        }
        
        function getStatusName(status) {
            const names = {
                'APPLIED': 'ì§€ì› ì™„ë£Œ', 'SCREENING': 'ì„œë¥˜ ì‹¬ì‚¬ ì¤‘',
                'SCREENING_PASSED': 'ì„œë¥˜ í•©ê²©', 'SCREENING_FAILED': 'ì„œë¥˜ ë¶ˆí•©ê²©',
                'INTERVIEW_SCHEDULED': 'ë©´ì ‘ ì˜ˆì •', 'INTERVIEW_COMPLETED': 'ë©´ì ‘ ì™„ë£Œ',
                'OFFER': 'ìµœì¢… í•©ê²©', 'REJECTED': 'ë¶ˆí•©ê²©', 'WITHDRAWN': 'ì§€ì› ì·¨ì†Œ'
            };
            return names[status] || status;
        }
        
        function renderApplications(applications) {
            const container = document.getElementById('applicationList');
            
            if (applications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">ì§€ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            container.innerHTML = applications.map(app => `
                <div class="application-card">
                    <div class="app-info">
                        <h3>${app.candidateName}</h3>
                        <p>${app.jobTitle}</p>
                        <p style="margin-top: 5px;">
                            <span class="status-badge status-${app.status}">${getStatusName(app.status)}</span>
                            <span style="margin-left: 10px; color: #999;">ì§€ì›ì¼: ${new Date(app.appliedAt).toLocaleDateString()}</span>
                        </p>
                    </div>
                    <div class="app-score">
                        <div class="score">${app.matchingScore.toFixed(1)}</div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ë§¤ì¹­ ì ìˆ˜</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${Math.min(app.matchingScore, 100)}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateStats(applications) {
            document.getElementById('totalCount').textContent = applications.length;
            
            if (applications.length > 0) {
                const avgScore = applications.reduce((sum, app) => sum + app.matchingScore, 0) / applications.length;
                document.getElementById('avgScore').textContent = avgScore.toFixed(1);
                
                const highScoreCount = applications.filter(app => app.matchingScore >= 90).length;
                document.getElementById('highScoreCount').textContent = highScoreCount;
            }
        }
        
        function filterApplications() {
            const jobFilter = document.getElementById('jobFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            let filtered = allApplications.filter(app => {
                const matchJob = !jobFilter || app.jobPostingId == jobFilter;
                const matchStatus = !statusFilter || app.status === statusFilter;
                return matchJob && matchStatus;
            });
            
            if (sortFilter === 'score') {
                filtered.sort((a, b) => b.matchingScore - a.matchingScore);
            } else {
                filtered.sort((a, b) => new Date(b.appliedAt) - new Date(a.appliedAt));
            }
            
            renderApplications(filtered);
            updateStats(filtered);
        }
        
        async function loadData() {
            try {
                allJobs = await fetchWithAuth(`${API_BASE}/jobs`);
                
                const jobFilter = document.getElementById('jobFilter');
                jobFilter.innerHTML = '<option value="">ì „ì²´ ê³µê³ </option>' + 
                    allJobs.map(job => `<option value="${job.id}">${job.title}</option>`).join('');
                
                const promises = allJobs.map(job => 
                    fetchWithAuth(`${API_BASE}/applications/job/${job.id}`)
                );
                const results = await Promise.all(promises);
                allApplications = results.flat();
                
                filterApplications();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                document.getElementById('applicationList').innerHTML = '<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
            }
        }
        
        document.getElementById('jobFilter').addEventListener('change', filterApplications);
        document.getElementById('statusFilter').addEventListener('change', filterApplications);
        document.getElementById('sortFilter').addEventListener('change', filterApplications);
        
        if (!token) {
            window.location.href = '/recruitment/dashboard';
        } else {
            loadData();
        }
    </script>
</body>
</html>
