<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ìš© ê³µê³  ìƒì„¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .back-btn { display: inline-block; padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 5px; margin-bottom: 20px; }
        .back-btn:hover { background: #f0f0f0; }
        
        .job-header { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .job-title { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 15px; }
        .job-meta { display: flex; gap: 20px; flex-wrap: wrap; color: #666; margin-bottom: 20px; }
        .job-meta span { display: flex; align-items: center; gap: 5px; }
        
        .section { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { margin-bottom: 20px; color: #333; font-size: 20px; }
        
        .requirements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .requirement-card { padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .requirement-card.required { border-left: 4px solid #c33; background: #fff5f5; }
        .requirement-card.preferred { border-left: 4px solid #3c3; background: #f5fff5; }
        .requirement-title { font-weight: bold; margin-bottom: 10px; }
        .requirement-detail { font-size: 14px; color: #666; }
        
        .applicants-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .applicant-card { padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .applicant-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .applicant-info h3 { margin-bottom: 5px; }
        .applicant-info p { color: #666; font-size: 14px; }
        .score-section { text-align: right; }
        .score { font-size: 32px; font-weight: bold; color: #667eea; }
        .score-label { font-size: 12px; color: #999; }
        .score-bar { width: 200px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .score-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s; }
        
        .btn { display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; transition: all 0.3s; border: none; cursor: pointer; }
        .btn:hover { background: #5568d3; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/recruitment/jobs" class="back-btn">â† ëª©ë¡ìœ¼ë¡œ</a>
        
        <div id="jobDetail" class="loading">ë¡œë”© ì¤‘...</div>
        
        <div id="applicantsSection" style="display: none;" class="applicants-section">
            <h2>ğŸ¯ ë§¤ì¹­ ì§€ì›ì (ë§¤ì¹­ ìŠ¤ì½”ì–´ ìˆœ)</h2>
            <div id="applicantsList"></div>
        </div>
        
        <div id="recommendationsSection" style="display: none;" class="applicants-section">
            <h2>ğŸ’¡ ì¶”ì²œ ì§€ì›ì (Top 5)</h2>
            <p style="color: #666; margin-bottom: 20px;">ì˜¨í†¨ë¡œì§€ ê¸°ë°˜ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì„ ë³„ëœ ìµœì ì˜ ì¸ì¬</p>
            <div id="recommendationsList"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/recruitment';
        let token = localStorage.getItem('jwt_token');
        const jobId = window.location.pathname.split('/').pop();
        
        async function fetchWithAuth(url) {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
            return response.json();
        }
        
        function getPositionName(position) {
            const names = {
                'CEO': 'ëŒ€í‘œì´ì‚¬', 'CTO': 'ê¸°ìˆ ì´ì‚¬', 'CFO': 'ì¬ë¬´ì´ì‚¬',
                'DIRECTOR': 'ì´ì‚¬', 'GENERAL_MANAGER': 'ë¶€ì¥', 'MANAGER': 'ì°¨ì¥',
                'ASSISTANT_MANAGER': 'ê³¼ì¥', 'SENIOR': 'ëŒ€ë¦¬', 'STAFF': 'ì‚¬ì›', 'INTERN': 'ì¸í„´'
            };
            return names[position] || position;
        }
        
        function renderApplicant(app, isRecommendation = false) {
            const candidate = isRecommendation ? app.candidate : null;
            const name = isRecommendation ? candidate.name : app.candidateName;
            const score = isRecommendation ? app.matchingScore : app.matchingScore;
            
            return `
                <div class="applicant-card" onclick="location.href='/recruitment/candidates/${isRecommendation ? candidate.id : app.candidateId}'">
                    <div class="applicant-info">
                        <h3>${name}</h3>
                        <p>${isRecommendation ? 
                            `${candidate.education} Â· ${candidate.university} Â· ${candidate.totalYearsOfExperience}ë…„ ê²½ë ¥` :
                            `ìƒíƒœ: ${app.status}`
                        }</p>
                        ${isRecommendation && candidate.skills.length > 0 ? `
                            <p style="margin-top: 5px;">
                                ${candidate.skills.slice(0, 5).map(s => s.skillName).join(', ')}
                                ${candidate.skills.length > 5 ? ` ì™¸ ${candidate.skills.length - 5}ê°œ` : ''}
                            </p>
                        ` : ''}
                    </div>
                    <div class="score-section">
                        <div class="score">${score.toFixed(1)}</div>
                        <div class="score-label">ë§¤ì¹­ ì ìˆ˜</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${Math.min(score, 100)}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadJobDetail() {
            try {
                const job = await fetchWithAuth(`${API_BASE}/jobs/${jobId}`);
                
                document.getElementById('jobDetail').innerHTML = `
                    <div class="job-header">
                        <div class="job-title">${job.title}</div>
                        <div class="job-meta">
                            <span>ğŸ¢ ${job.departmentName || 'ë¯¸ì§€ì •'}</span>
                            <span>ğŸ‘¤ ${getPositionName(job.position)}</span>
                            <span>ğŸ‘¥ ${job.headcount}ëª… ëª¨ì§‘</span>
                            <span>ğŸ“… ${job.startDate} ~ ${job.endDate}</span>
                            <span style="padding: 5px 15px; background: ${job.status === 'OPEN' ? '#e3f2fd' : '#ffebee'}; color: ${job.status === 'OPEN' ? '#1976d2' : '#c62828'}; border-radius: 20px; font-weight: bold;">
                                ${job.status === 'OPEN' ? 'ê³µê°œ' : job.status === 'CLOSED' ? 'ë§ˆê°' : 'ì„ì‹œì €ì¥'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>ğŸ“ ìƒì„¸ ì„¤ëª…</h2>
                        <p style="line-height: 1.8; color: #555;">${job.description}</p>
                    </div>
                    
                    <div class="section">
                        <h2>âœ… í•„ìˆ˜ ìš”êµ¬ì‚¬í•­</h2>
                        <div class="requirements-grid">
                            ${job.requirements.filter(r => r.type === 'REQUIRED').map(req => `
                                <div class="requirement-card required">
                                    <div class="requirement-title">ğŸ”´ ${req.skillName}</div>
                                    <div class="requirement-detail">
                                        ${req.minProficiency ? `ìˆ™ë ¨ë„: ${req.minProficiency}<br>` : ''}
                                        ${req.minYearsOfExperience ? `ê²½ë ¥: ${req.minYearsOfExperience}ë…„ ì´ìƒ<br>` : ''}
                                        ${req.description || ''}
                                    </div>
                                </div>
                            `).join('') || '<p style="color: #999;">í•„ìˆ˜ ìš”êµ¬ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>â­ ìš°ëŒ€ ì‚¬í•­</h2>
                        <div class="requirements-grid">
                            ${job.requirements.filter(r => r.type === 'PREFERRED').map(req => `
                                <div class="requirement-card preferred">
                                    <div class="requirement-title">ğŸŸ¢ ${req.skillName}</div>
                                    <div class="requirement-detail">
                                        ${req.minProficiency ? `ìˆ™ë ¨ë„: ${req.minProficiency}<br>` : ''}
                                        ${req.minYearsOfExperience ? `ê²½ë ¥: ${req.minYearsOfExperience}ë…„ ì´ìƒ<br>` : ''}
                                        ${req.description || ''}
                                    </div>
                                </div>
                            `).join('') || '<p style="color: #999;">ìš°ëŒ€ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                    </div>
                `;
                
                // ì§€ì›ì ëª©ë¡ ë¡œë“œ
                loadApplicants();
                
                // ì¶”ì²œ ì§€ì›ì ë¡œë“œ
                loadRecommendations();
                
            } catch (error) {
                console.error('ê³µê³  ë¡œë”© ì‹¤íŒ¨:', error);
                document.getElementById('jobDetail').innerHTML = '<p>ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        async function loadApplicants() {
            try {
                const applications = await fetchWithAuth(`${API_BASE}/applications/job/${jobId}`);
                
                if (applications.length > 0) {
                    document.getElementById('applicantsSection').style.display = 'block';
                    document.getElementById('applicantsList').innerHTML = applications.map(app => renderApplicant(app, false)).join('');
                }
            } catch (error) {
                console.error('ì§€ì›ì ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }
        
        async function loadRecommendations() {
            try {
                const recommendations = await fetchWithAuth(`${API_BASE}/recommendations/job/${jobId}/candidates?topN=5`);
                
                if (recommendations.length > 0) {
                    document.getElementById('recommendationsSection').style.display = 'block';
                    document.getElementById('recommendationsList').innerHTML = recommendations.map(rec => renderApplicant(rec, true)).join('');
                }
            } catch (error) {
                console.error('ì¶”ì²œ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }
        
        if (!token) {
            window.location.href = '/recruitment/dashboard';
        } else {
            loadJobDetail();
        }
    </script>
</body>
</html>
